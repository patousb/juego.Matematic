<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Challenge PRO - Torneo Corregido</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root {
            --azul: #4e8cff;
            --rojo: #ff6b6b;
            --verde: #6bff6b;
            --amarillo: #ffde59;
            --morado: #a459ff;
            --fondo: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --texto: #333;
            --panel: rgba(255, 255, 255, 0.6);
            --borde: #ddd;
            --sombra: rgba(0, 0, 0, 0.1);
            --tiempo-normal: #a459ff;
            --tiempo-alerta: #ff6b6b;
            --neon-azul: 0 0 10px rgba(78, 140, 255, 0.8);
            --neon-morado: 0 0 10px rgba(164, 89, 255, 0.8);
            --neon-verde: 0 0 10px rgba(107, 255, 107, 0.8);
            --neon-rojo: 0 0 10px rgba(255, 107, 107, 0.8);
            --neon-amarillo: 0 0 10px rgba(255, 222, 89, 0.8);
            
            /* Fondos por fase */
            --fondo-clasificacion: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --fondo-semifinal: linear-gradient(135deg, #8A2BE2 0%, #4B0082 100%);
            --fondo-final: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%);
        }

        .dark-mode {
            --fondo: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --texto: #f0f0f0;
            --panel: rgba(30, 41, 59, 0.7);
            --borde: #334155;
            --sombra: rgba(0, 0, 0, 0.3);
            --fondo-clasificacion: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --fondo-semifinal: linear-gradient(135deg, #4B0082 0%, #2E0854 100%);
            --fondo-final: linear-gradient(135deg, #B8860B 0%, #8B4513 100%);
        }

        /* Clases para fases del torneo */
        .fase-clasificacion {
            background: var(--fondo-clasificacion) !important;
        }
        
        .fase-semifinal {
            background: var(--fondo-semifinal) !important;
            color: white !important;
        }
        
        .fase-final {
            background: var(--fondo-final) !important;
            color: #333 !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Neue', cursive;
            text-align: center;
            background: var(--fondo);
            color: var(--texto);
            min-height: 100vh;
            transition: background 1s ease, color 0.5s ease;
            padding: 20px;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Efecto de particulas en el fondo */
        .particle {
            position: fixed;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 25s infinite linear;
            z-index: -1;
            filter: blur(1px);
        }

        @keyframes float {
            0% { transform: translateY(100vh) scale(1); opacity: 1; }
            100% { transform: translateY(-10vh) scale(0.5); opacity: 0; }
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        h1, h2, h3 {
            font-family: 'Fredoka One', cursive;
            color: var(--texto);
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        main {
            width: 100%;
            max-width: 1200px;
            margin: auto;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--fondo);
            z-index: 2000;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(78, 140, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--morado);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
            box-shadow: var(--neon-morado);
        }

        .loader-small {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(78, 140, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--morado);
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .join-screen {
            width: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }

        .join-screen.active {
            display: flex;
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .enhanced-join-form {
            background: var(--panel);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 15px 35px var(--sombra);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
        }

        .enhanced-join-form h2 {
            background: linear-gradient(45deg, var(--azul), var(--morado));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            margin-bottom: 25px;
        }

        .avatar-selector-enhanced {
            display: grid !important;
            grid-template-columns: repeat(5, 1fr) !important;
            gap: 15px !important;
            margin: 20px 0 !important;
        }

        .avatar-option-enhanced {
            width: 60px !important;
            height: 60px !important;
            border-radius: 15px !important;
            cursor: pointer;
            transition: all 0.3s ease !important;
            border: 3px solid transparent !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1) !important;
            transform: rotateY(0deg);
            transform-style: preserve-3d;
        }

        .avatar-option-enhanced:hover {
            transform: translateY(-5px) scale(1.1) rotateY(5deg) !important;
            box-shadow: 0 10px 25px rgba(164, 89, 255, 0.3) !important;
        }

        .avatar-option-enhanced.selected {
            border-color: var(--morado) !important;
            transform: scale(1.1) rotateY(0deg) !important;
            box-shadow: 0 0 20px rgba(164, 89, 255, 0.5) !important;
        }

        .input-group-enhanced {
            margin-bottom: 25px !important;
            text-align: left !important;
        }

        .input-group-enhanced label {
            display: block !important;
            margin-bottom: 10px !important;
            font-weight: bold !important;
            color: var(--texto) !important;
            font-size: 1.1rem !important;
        }

        .input-group-enhanced input {
            width: 100% !important;
            padding: 15px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 12px !important;
            font-size: 1.1rem !important;
            font-family: 'Comic Neue', cursive !important;
            transition: all 0.3s ease !important;
            background: rgba(255,255,255,0.9) !important;
            color: var(--texto);
            transform: rotateY(0deg);
            transform-style: preserve-3d;
        }

        .input-group-enhanced input:focus {
            outline: none !important;
            border-color: var(--morado) !important;
            box-shadow: 0 0 0 3px rgba(164, 89, 255, 0.2) !important;
            transform: translateY(-2px) rotateY(2deg) !important;
        }

        .btn-enhanced {
            background: linear-gradient(45deg, var(--azul), var(--morado)) !important;
            color: white !important;
            padding: 15px 30px !important;
            border: none !important;
            border-radius: 50px !important;
            font-size: 1.2rem !important;
            font-weight: bold !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 8px 25px rgba(164, 89, 255, 0.3) !important;
            position: relative !important;
            overflow: hidden !important;
            width: 100%;
            margin: 10px 0;
            transform: rotateY(0deg);
            transform-style: preserve-3d;
        }

        .btn-enhanced:hover {
            transform: translateY(-5px) rotateY(5deg) !important;
            box-shadow: 0 15px 35px rgba(164, 89, 255, 0.4) !important;
        }

        .btn-enhanced:active {
            transform: translateY(-2px) !important;
        }

        .btn-enhanced::before {
            content: '' !important;
            position: absolute !important;
            top: 0 !important;
            left: -100% !important;
            width: 100% !important;
            height: 100% !important;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent) !important;
            transition: 0.5s !important;
        }

        .btn-enhanced:hover::before {
            left: 100% !important;
        }

        .btn-create {
            background: linear-gradient(45deg, #ff6b6b, #ffde59) !important;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3) !important;
        }

        .btn-create:hover {
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.4) !important;
        }

        .error-message {
            color: var(--rojo);
            margin-top: 10px;
            font-weight: bold;
            text-shadow: var(--neon-rojo);
        }

        .multiplayer-lobby {
            width: 100%;
            position: relative;
            display: none;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
        }

        #lobby3DCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .lobby-container-enhanced {
            background: var(--panel);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 20px 40px var(--sombra);
            border-radius: 25px;
            padding: 30px;
            width: 100%;
            max-width: 700px;
            z-index: 1;
            flex-shrink: 0;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .lobby-content-wrapper {
            overflow-y: auto;
            padding-right: 15px;
            margin-right: -15px;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* Personaje del Lobby - POSICIÓN CENTRADA */
        #lobbyCharacter {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: floatCharacter 4s ease-in-out infinite;
            z-index: 1;
            position: relative;
            height: 100%;
            width: 300px;
            transform: translateY(0);
        }

        @keyframes floatCharacter {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        #lobbyCharacter img {
            max-width: 250px;
            height: auto;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.3));
        }

        .welcome-bubble {
            background: linear-gradient(45deg, var(--azul), var(--morado));
            color: white;
            padding: 10px 20px;
            border-radius: 20px 20px 0 20px;
            margin-top: -30px;
            font-family: 'Fredoka One', cursive;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .player-badge-enhanced {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 12px 20px !important;
            border-radius: 25px !important;
            font-weight: bold !important;
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3) !important;
            transition: all 0.3s ease !important;
            border: 2px solid transparent !important;
            transform: rotateY(0deg);
            transform-style: preserve-3d;
        }

        .player-badge-enhanced:hover {
            transform: translateY(-5px) rotateY(5deg) !important;
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4) !important;
        }

        .player-badge-enhanced.host {
            border-color: #ffde59 !important;
            background: linear-gradient(135deg, #ffde59, #ff9d00) !important;
        }

        /* Efectos de desempeño */
        .player-badge-enhanced.streak-effect {
            position: relative;
            overflow: hidden;
        }

        .player-badge-enhanced.streak-effect::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff6b00, #ff0000, #ff6b00);
            border-radius: 27px;
            z-index: -1;
            animation: streakGlow 2s infinite;
            filter: blur(3px);
        }

        @keyframes streakGlow {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .player-badge-enhanced.fail-effect {
            position: relative;
            overflow: hidden;
        }

        .player-badge-enhanced.fail-effect::after {
            content: '☁️';
            position: absolute;
            top: -10px;
            right: 5px;
            font-size: 1.2rem;
            animation: fadeCloud 2s forwards;
            z-index: 2;
            filter: drop-shadow(0 0 3px rgba(0,0,0,0.3));
        }

        @keyframes fadeCloud {
            0% { opacity: 0; transform: translateY(0); }
            20% { opacity: 1; transform: translateY(-5px); }
            80% { opacity: 1; transform: translateY(-10px); }
            100% { opacity: 0; transform: translateY(-15px); }
        }

        .player-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .vote-section {
            margin: 30px 0;
        }

        .vote-timer {
            font-size: 1.5rem;
            margin: 15px 0;
            font-weight: bold;
            color: var(--morado);
            text-shadow: var(--neon-morado);
        }

        .lobby-countdown-message {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--verde);
            margin-top: 20px;
            opacity: 0;
            transform: scale(0.8) translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            text-shadow: var(--neon-verde);
        }

        .lobby-countdown-message.active {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        /* Rediseño de botones de votación - OPTIMIZADO */
        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
            transform: translateZ(0);
            will-change: transform;
        }

        .mode-btn {
            padding: 15px;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            color: var(--texto);
            font-size: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            backdrop-filter: blur(5px);
            transform-style: preserve-3d;
            width: 100%;
            transform: translateZ(0);
            will-change: transform;
        }
        
        .mode-btn-wrapper {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 8px;
             transform: translateZ(0);
             will-change: transform;
        }

        .mode-btn:hover {
            transform: translateY(-5px) scale(1.05) rotateY(5deg);
            box-shadow: 0 10px 25px var(--sombra);
            border-color: var(--morado);
        }
        
        .mode-btn.selected {
            background: linear-gradient(45deg, var(--azul), var(--morado));
            color: white;
            border-color: var(--morado);
            box-shadow: var(--neon-morado);
            transform: scale(1.1) rotateY(0deg);
        }

        .mode-btn.voted::after {
            content: "✓";
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--verde);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: var(--neon-verde);
        }

        .vote-results {
            margin-top: 20px;
            padding: 15px;
            background: var(--panel);
            border-radius: 10px;
            border: 1px solid var(--borde);
            backdrop-filter: blur(5px);
        }

        .lobby-buttons-container {
            margin-top: auto; 
            padding-top: 20px;
        }
        
        #startVoteBtn, .ready-btn {
            position: static;
            transform: none;
            left: auto;
            bottom: auto;
            width: calc(100% - 20px);
            margin: 10px auto;
        }

        .finalist-label {
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 5px;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: var(--texto);
            font-weight: bold;
        }

        .finalist-checkbox {
            transform: scale(1.2);
            cursor: pointer;
        }

        /* Nuevos estilos para estadísticas del jugador */
        .player-stats-detailed {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--panel);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--sombra);
            z-index: 100;
            display: none;
            max-width: 300px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--morado);
            transform: rotateY(0deg);
            transform-style: preserve-3d;
        }

        .player-stats-detailed h3 {
            margin-bottom: 10px;
            color: var(--morado);
            font-size: 1.2rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .stat-label {
            font-weight: bold;
        }

        .stat-value {
            color: var(--azul);
        }

        .stat-bar {
            height: 8px;
            background: var(--borde);
            border-radius: 4px;
            margin-top: 3px;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--azul), var(--morado));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Estilos para el juego */
        #gameContainer {
            display: none;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .game {
            background: var(--panel);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px var(--sombra);
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-bottom: 2px solid var(--amarillo);
        }

        .question {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid var(--morado);
            background: rgba(255,255,255,0.1);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        .question-image {
            max-width: 100%;
            max-height: 200px;
            margin: 10px auto;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 2px solid var(--morado);
        }

        .input-container {
            margin: 20px 0;
        }

        #playerAnswer {
            padding: 12px;
            font-size: 1.3rem;
            width: 200px;
            text-align: center;
            margin-bottom: 15px;
            border: 2px solid var(--borde);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: var(--texto);
            transition: all 0.3s;
        }

        #playerAnswer:focus {
            outline: none;
            border-color: var(--morado);
            box-shadow: var(--neon-morado);
        }

        .keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 0 auto;
        }

        .key {
            padding: 15px;
            font-size: 1.3rem;
            cursor: pointer;
            background: var(--panel);
            border: 2px solid var(--borde);
            border-radius: 8px;
            transition: all 0.2s;
            user-select: none;
        }

        .key:hover {
            background: var(--borde);
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .key:active {
            transform: translateY(1px);
        }

        .key.negative {
            grid-column: span 3;
        }

        .abcd-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px auto;
            max-width: 600px;
        }

        .abcd-btn {
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid var(--borde);
            border-radius: 10px;
            cursor: pointer;
            background: var(--panel);
            color: var(--texto);
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .abcd-btn span.letter {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            background: var(--morado);
            color: white;
            text-align: center;
            font-family: 'Fredoka One', cursive;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .abcd-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px var(--sombra);
            border-color: var(--morado);
        }

        .abcd-btn.selected-answer {
            background: var(--azul);
            color: white;
            border-color: var(--azul);
            box-shadow: var(--neon-azul);
        }

        .result {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 15px 0;
            min-height: 40px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
        }

        .correct {
            color: var(--verde);
            animation: tada 1s ease;
            text-shadow: var(--neon-verde);
        }

        .incorrect {
            color: var(--rojo);
            animation: shake 0.5s ease;
            text-shadow: var(--neon-rojo);
        }

        .waiting {
            color: var(--azul);
            text-shadow: var(--neon-azul);
        }

        @keyframes tada {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .timer-container {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            position: relative;
        }

        .timer-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .timer-circle {
            fill: none;
            stroke: var(--tiempo-normal);
            stroke-width: 6;
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 1s linear, stroke 0.5s ease;
            filter: drop-shadow(0 0 5px var(--morado));
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--tiempo-normal);
            text-shadow: var(--neon-morado);
            transition: color 0.5s ease;
        }

        .timer-circle.timer-warning {
            stroke: var(--tiempo-alerta);
            filter: drop-shadow(0 0 5px var(--rojo));
        }
        
        .timer-text.timer-warning {
             color: var(--tiempo-alerta);
             text-shadow: var(--neon-rojo);
        }

        .progress-container {
            width: 80%;
            height: 10px;
            background: var(--borde);
            border-radius: 5px;
            margin: 20px auto;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--azul), var(--morado));
            transition: width 0.5s ease;
            box-shadow: 0 0 10px var(--morado);
        }

        .live-ranking {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 250px;
            background: var(--panel);
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--sombra);
            padding: 15px;
            z-index: 50;
            display: none;
            border: 2px solid var(--morado);
            backdrop-filter: blur(10px);
        }

        .live-ranking h3 {
            margin-bottom: 10px;
            color: var(--morado);
            text-align: center;
            text-shadow: var(--neon-morado);
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 8px;
            background: rgba(78, 140, 255, 0.1);
            transition: all 0.5s ease;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .ranking-item.current-player {
            background: rgba(255, 222, 89, 0.2);
            border-left: 4px solid var(--amarillo);
        }

        .ranking-item.move-up {
            animation: moveUp 0.5s ease;
        }

        @keyframes moveUp {
            0% { transform: translateY(0); background: var(--verde); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }

        .ranking-item.move-down {
            animation: moveDown 0.5s ease;
        }

        @keyframes moveDown {
            0% { transform: translateY(0); background: var(--rojo); }
            50% { transform: translateY(10px); }
            100% { transform: translateY(0); }
        }

        .ranking-position {
            font-weight: bold;
            color: var(--morado);
        }

        .ranking-name {
            flex-grow: 1;
            margin: 0 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-points {
            font-weight: bold;
            color: var(--azul);
        }

        .ranking-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .final-results {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin: 30px 0;
            height: 250px;
            position: relative;
        }

        .podium-place {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
            position: relative;
        }

        .podium-1, .podium-2, .podium-3 {
            width: 100px;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .podium-1 {
            height: 200px;
            background: linear-gradient(to top, #ffd700, #ffec80);
            animation: bounce 1s ease;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        }

        .podium-2 {
            height: 150px;
            background: linear-gradient(to top, #c0c0c0, #e0e0e0);
            animation: bounce 1s 0.2s ease;
            box-shadow: 0 0 15px rgba(192, 192, 192, 0.7);
        }

        .podium-3 {
            height: 100px;
            background: linear-gradient(to top, #cd7f32, #e0a76c);
            animation: bounce 1s 0.4s ease;
            box-shadow: 0 0 10px rgba(205, 127, 50, 0.7);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .podium-name {
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 2;
        }

        .podium-points {
            font-size: 1rem;
            color: var(--texto);
        }

        .podium-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .winner-dancing-emoji {
            font-size: 3rem;
            position: absolute;
            bottom: 210px;
            animation: dance 0.8s infinite alternate;
            z-index: 3;
            pointer-events: none;
        }

        @keyframes dance {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(5deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(-10px) rotate(-5deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        .other-players {
            max-height: 200px;
            overflow-y: auto;
            width: 80%;
            max-width: 500px;
            margin-top: 20px;
            padding: 10px;
            background: var(--panel);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--sombra);
            backdrop-filter: blur(5px);
        }

        .other-player {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
            align-items: center;
        }

        .other-player:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .other-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 3px 10px var(--sombra);
            z-index: 200;
            animation: fadeInOut 3s ease forwards;
            display: flex;
            align-items: center;
            backdrop-filter: blur(5px);
            border: 1px solid var(--morado);
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        .connection-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            background: var(--panel);
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 100;
            backdrop-filter: blur(5px);
            border: 1px solid var(--borde);
        }

        .connection-status.connected {
            color: var(--verde);
            text-shadow: var(--neon-verde);
        }

        .connection-status.disconnected {
            color: var(--rojo);
            animation: pulse 1.5s infinite;
            text-shadow: var(--neon-rojo);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .connection-status.connecting {
            color: var(--amarillo);
            text-shadow: var(--neon-amarillo);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--panel);
            border: 2px solid var(--borde);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px var(--sombra);
            z-index: 100;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            transform: rotate(30deg);
        }

        .skip-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: none;
            backdrop-filter: blur(5px);
        }

        .lightning-mode .timer-container {
            width: 70px;
            height: 70px;
        }

        .lightning-mode .timer-text {
            font-size: 1.5rem;
        }

        .true-false-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .true-false-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .true-false-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        .true-false-btn:hover::before {
            left: 100%;
        }

        .true-btn {
            background-color: var(--verde);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .true-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .true-btn:active {
            transform: translateY(1px);
        }

        .false-btn {
            background-color: var(--rojo);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .false-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .false-btn:active {
            transform: translateY(1px);
        }

        .question-animation {
            animation: pulseQuestion 0.5s ease;
        }

        @keyframes pulseQuestion {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .game-mode-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel);
            padding: 8px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 10px var(--sombra);
            z-index: 100;
            font-weight: bold;
            display: none;
            backdrop-filter: blur(5px);
            border: 1px solid var(--morado);
        }

        .achievement-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ffde59"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>');
            background-size: contain;
            margin-left: 5px;
            vertical-align: middle;
            filter: drop-shadow(0 0 3px rgba(255, 222, 89, 0.7));
        }

        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--panel);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--sombra);
            z-index: 1000;
            text-align: center;
            display: none;
            animation: achievementUnlock 1s ease;
            backdrop-filter: blur(10px);
            border: 2px solid var(--amarillo);
        }

        @keyframes achievementUnlock {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }

        .player-stats {
            position: fixed;
            bottom: 50px;
            right: 20px;
            background: var(--panel);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--sombra);
            z-index: 100;
            display: none;
            max-width: 250px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--morado);
        }

        .player-stats h3 {
            margin-bottom: 10px;
            color: var(--morado);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .stat-label {
            font-weight: bold;
        }

        .stat-value {
            color: var(--azul);
        }

        .reveal-phase {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            color: white;
            font-size: 2rem;
            text-align: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .reveal-content {
            background: var(--panel);
            color: var(--texto);
            padding: 30px;
            border-radius: 15px;
            max-width: 80%;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .reveal-correct {
            color: var(--verde);
            font-weight: bold;
            margin: 20px 0;
            text-shadow: var(--neon-verde);
        }

        .reveal-correct-answer {
            color: var(--verde);
            text-shadow: var(--neon-verde);
        }

        .reveal-player-result {
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            font-size: 1.5rem;
        }

        .reveal-streak-bonus {
            color: var(--amarillo);
            margin-top: 10px;
            font-size: 1.2rem;
            text-shadow: 0 0 5px rgba(255, 222, 89, 0.7);
        }

        .reveal-time-bonus {
            color: var(--amarillo);
            margin-top: 10px;
            font-size: 1.2rem;
            text-shadow: 0 0 5px rgba(255, 222, 89, 0.7);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .neon-border {
            position: relative;
        }

        .neon-border::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            padding: 2px;
            background: linear-gradient(45deg, var(--azul), var(--morado));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        @keyframes neonGlow {
            from {
                opacity: 0.7;
                box-shadow: 0 0 5px var(--azul), 0 0 10px var(--morado);
            }
            to {
                opacity: 1;
                box-shadow: 0 0 10px var(--azul), 0 0 20px var(--morado), 0 0 30px var(--morado);
            }
        }

        .results-countdown {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2500;
            color: white;
            font-size: 8em;
            font-family: 'Fredoka One', cursive;
            animation: scaleInAndFade 1s forwards;
            text-shadow: 0 0 20px var(--amarillo);
        }

        @keyframes scaleInAndFade {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        .join-form.neon-border::after {
            animation: neonGlow 2s infinite alternate;
        }

        .finalist-announcement-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.5s ease;
        }

        .finalist-announcement-content {
            padding: 40px;
            text-align: center;
        }

        .finalist-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            font-size: 1.5rem;
        }

        .finalist-player-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(78, 140, 255, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
            animation: slideIn 0.5s ease forwards;
            opacity: 0;
        }

        .finalist-player-card:nth-child(2) { animation-delay: 0.2s; }
        .finalist-player-card:nth-child(3) { animation-delay: 0.4s; }
        .finalist-player-card:nth-child(4) { animation-delay: 0.6s; }

        .spectator-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2800;
            padding: 20px;
            text-align: center;
        }

        .emoji-chat {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }

        .emoji-btn {
            font-size: 2rem;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .emoji-btn:hover {
            transform: scale(1.3);
        }

        #emoji-animation-container {
            position: fixed;
            bottom: 80px;
            left: 0;
            width: 100%;
            height: 300px;
            pointer-events: none;
            overflow: hidden;
        }

        .flying-emoji {
            position: absolute;
            font-size: 2.5rem;
            animation: flyUp 4s ease-out forwards;
        }

        @keyframes flyUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-300px) scale(0.5); opacity: 0; }
        }

        .ultimate-winner-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,223,0,1) 0%, rgba(255,165,0,1) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: fadeIn 1s ease;
        }
        
        .ultimate-winner-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .crown {
            font-size: 10rem;
            animation: bounce 1.5s ease infinite;
        }

        .winner-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        #ultimateWinnerAvatar {
            border: 5px solid white;
        }

        .tournament-indicator {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #ff6b6b, #ffde59);
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 100;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }
        
        .round-badge {
            display: inline-block;
            padding: 5px 10px;
            background: var(--morado);
            color: white;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
            animation: bounce 1s infinite alternate;
        }
        
        .finalist-highlight {
            border: 3px solid gold !important;
            box-shadow: 0 0 10px gold !important;
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 5px gold; }
            to { box-shadow: 0 0 20px gold; }
        }
        
        .tournament-countdown {
            font-size: 5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 20px var(--amarillo);
            animation: zoomInOut 1s infinite alternate;
        }
        
        @keyframes zoomInOut {
            0% { transform: scale(1); }
            100% { transform: scale(1.2); }
        }

        .tournament-question-indicator {
            background: linear-gradient(45deg, #ff6b6b, #ffde59) !important;
            color: white !important;
            padding: 10px 20px !important;
            border-radius: 25px !important;
            font-weight: bold !important;
            margin-bottom: 15px !important;
            display: inline-block !important;
            animation: pulse 2s infinite !important;
        }

        .finalist-badge {
            display: inline-flex !important;
            align-items: center !important;
            background: linear-gradient(45deg, #FFD700, #FFA500) !important;
            color: white !important;
            padding: 5px 12px !important;
            border-radius: 15px !important;
            font-size: 0.8em !important;
            margin-left: 8px !important;
            font-weight: bold !important;
            animation: glow 1.5s infinite alternate !important;
        }

        /* NUEVOS ESTILOS PARA EFECTOS ESPECIALES */
        .explosion-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .explosion-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
        }

        .confetti {
            position: fixed;
            width: 15px;
            height: 15px;
            pointer-events: none;
            z-index: 9998;
        }

        .winner-explosion {
            position: absolute;
            font-size: 2rem;
            animation: winnerFloat 3s ease-out forwards;
        }

        @keyframes winnerFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0); opacity: 0; }
        }

        .firework {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: fireworkExplode 1.5s ease-out forwards;
        }

        @keyframes fireworkExplode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        .pulse-win {
            animation: pulseWin 0.6s ease-in-out 3;
        }

        @keyframes pulseWin {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .shake-celebration {
            animation: shakeCelebration 0.5s ease-in-out;
        }

        @keyframes shakeCelebration {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .gold-glow {
            animation: goldGlow 2s infinite alternate;
        }

        @keyframes goldGlow {
            from { box-shadow: 0 0 20px gold, 0 0 30px orange; }
            to { box-shadow: 0 0 30px gold, 0 0 40px orange, 0 0 50px yellow; }
        }

        .fire-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #ff6b00, #ff0000);
            border-radius: 50%;
            filter: blur(1px);
        }

        .points-popup {
            position: absolute;
            font-weight: bold;
            font-size: 1.2rem;
            color: gold;
            text-shadow: 0 0 10px rgba(255,215,0,0.8);
            pointer-events: none;
            z-index: 1000;
            animation: pointsFloat 1.5s ease-out forwards;
        }

        @keyframes pointsFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }

        .streak-fire {
            position: relative;
        }

        .streak-fire::after {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ff6b00, #ff0000);
            border-radius: 50%;
            filter: blur(3px);
            animation: firePulse 0.5s infinite alternate;
        }

        @keyframes firePulse {
            from { transform: scale(1); opacity: 0.7; }
            to { transform: scale(1.2); opacity: 1; }
        }

        /* --- INICIO DE AJUSTES RESPONSIVE --- */

        /* Tablets y Laptops Pequeñas */
        @media (max-width: 1024px) {
            .multiplayer-lobby {
                flex-direction: column;
                align-items: center;
            }
            #lobbyCharacter {
                order: -1; 
                margin-bottom: 20px;
                height: auto;
            }
            #lobbyCharacter img {
                max-width: 180px;
            }
            .lobby-container-enhanced {
                max-width: 90%;
            }
            .live-ranking {
                width: 220px;
            }
        }

        /* Tablets y Móviles Grandes */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                display: block; 
                overflow-y: auto;
            }
            main {
                 padding-top: 20px;
            }
            .mode-buttons {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            .abcd-buttons {
                grid-template-columns: 1fr;
            }
            .live-ranking {
                display: none; 
            }
            .podium-place { margin: 0 5px; }
            .podium-1, .podium-2, .podium-3 { width: 80px; }
            .winner-dancing-emoji { bottom: 160px; font-size: 2.5rem; }
            
            #lobbyCharacter {
                display: none; 
            }
            
            .enhanced-join-form, .lobby-container-enhanced, .game {
                padding: 20px;
            }
             .true-false-buttons {
                flex-direction: column;
                gap: 10px;
            }
             .true-false-btn {
                width: 100%;
            }
            
            .player-stats-detailed {
                position: static;
                max-width: 100%;
                margin: 10px 0;
            }
        }
        
        /* Móviles Pequeños */
        @media (max-width: 480px) {
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.5rem; }

            .enhanced-join-form {
                padding: 15px;
            }
            .avatar-selector-enhanced {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            .btn-enhanced {
                padding: 12px 25px;
                font-size: 1rem;
            }
            .keyboard {
                gap: 5px;
                max-width: 280px;
            }
            .key {
                padding: 12px;
                font-size: 1.1rem;
            }
            .podium {
                height: 200px;
            }
            .podium-1 { height: 150px; }
            .podium-2 { height: 110px; }
            .podium-3 { height: 80px; }
            .winner-dancing-emoji { font-size: 2rem; bottom: 160px; }
        }
        
        /* --- FIN DE AJUSTES RESPONSIVE --- */
    </style>
</head>
<body>
    <main>
        <div class="loading-screen" id="loadingScreen">
            <div class="loader"></div>
            <h2>Cargando El Juego De Matematicas Por favor Espera:3...</h2>
        </div>

        <div class="join-screen" id="joinScreen">
            <h1>✨ Juego De Matematicas Pro ✨</h1>
            <div class="enhanced-join-form neon-border">
                <h2>🎮 ¡Únete a la Aventura! 🎮</h2>
                <div class="input-group-enhanced">
                    <label for="playerName">👤 Tu nombre épico:</label>
                    <input type="text" id="playerName" placeholder="Ej: Super Matemático" maxlength="20">
                </div>
                <div class="input-group-enhanced">
                    <label for="grade">🎓 Tu grado escolar:</label>
                    <input type="text" id="grade" placeholder="Ej: 5° Primaria" maxlength="20">
                </div>
                <div class="input-group-enhanced">
                    <label for="gamePin">🔑 Código PIN de la sala:</label>
                    <input type="text" id="gamePin" placeholder="Ej: 1234" maxlength="4">
                </div>
                
                <div class="input-group-enhanced">
                    <label>🎭 Elige tu avatar legendario:</label>
                    <div class="avatar-selector-enhanced" id="avatarSelector">
                        <img src="avatar1.png" class="avatar-option-enhanced" data-avatar="1" alt="avatar 1" onerror="this.src='avatar1.png'">
                        <img src="avatar2.png" class="avatar-option-enhanced" data-avatar="2" alt="avatar 2" onerror="this.src='avatar2.png'">
                        <img src="avatar3.png" class="avatar-option-enhanced" data-avatar="3" alt="avatar 3" onerror="this.src='avatar3.png'">
                        <img src="avatar4.png" class="avatar-option-enhanced" data-avatar="4" alt="avatar 4" onerror="this.src='avatar4.png'">
                        <img src="avatar5.png" class="avatar-option-enhanced" data-avatar="5" alt="avatar 5" onerror="this.src='avatar5.png'">
                    </div>
                </div>
                
                <button class="btn-enhanced" id="joinGame">
                    🚀 Unirse a la Batalla
                </button>
                <button class="btn-enhanced btn-create" id="createGame">
                    🏰 Crear Sala Épica
                </button>
                <p id="joinError" class="error-message"></p>
            </div>
        </div>

        <div class="multiplayer-lobby" id="multiplayerLobby">
            <canvas id="lobby3DCanvas"></canvas>
            <div class="lobby-container-enhanced">
                <div class="lobby-content-wrapper">
                    <h2>Sala: <span id="lobbyPin">----</span></h2>
                    <div class="player-count">Jugadores: <span id="playerCount">0</span>/15</div>
                    
                    <div class="vote-section">
                        <h3>👇 Vota por el próximo modo de juego 👇</h3>
                        <div class="vote-timer">Tiempo: <span id="voteTime">30</span>s</div>
                        <div class="lobby-countdown-message" id="lobbyCountdownMessage"></div>
                        <div class="mode-buttons" id="modeButtons">
                           
                            <div class="mode-btn-wrapper">
                                <button class="mode-btn" data-mode="operaciones">🔢<span>Operación Rápida</span></button>
                            </div>
                             <div class="mode-btn-wrapper">
                                <button class="mode-btn" data-mode="misterioso">❓<span>Número Misterioso</span></button>
                            </div>

                            <div class="mode-btn-wrapper">
                                <button class="mode-btn" data-mode="secuencia">📈<span>Secuencia Numérica</span></button>
                                <label class="finalist-label">
                                    <input type="checkbox" class="finalist-checkbox" data-mode="secuencia"> 🔥 Finalista Único
                                </label>
                            </div>

                            <div class="mode-btn-wrapper">
                                <button class="mode-btn" data-mode="potenciacion">💪<span>Potenciación</span></button>
                            </div>

                            <div class="mode-btn-wrapper">
                                <button class="mode-btn" data-mode="combinadas">🧩<span>Op. Combinadas</span></button>
                            </div>

                            <div class="mode-btn-wrapper">
                                <button class="mode-btn" data-mode="relampago">⚡<span>Modo Relámpago</span></button>
                                <label class="finalist-label">
                                    <input type="checkbox" class="finalist-checkbox" data-mode="relampago"> 🔥 Finalista Único
                                </label>
                            </div>
                            
                            <div class="mode-btn-wrapper">
                                <button class="mode-btn" data-mode="verdadero-falso">✅❌<span>Verdadero/Falso</span></button>
                                <label class="finalist-label">
                                    <input type="checkbox" class="finalist-checkbox" data-mode="verdadero-falso"> 🔥 Finalista Único
                                </label>
                            </div>

                            <div class="mode-btn-wrapper">
                                <button class="mode-btn" data-mode="mas-cercano">🎯<span>El más cercano</span></button>
                            </div>
                            
                            <div class="mode-btn-wrapper">
                                <button class="mode-btn" data-mode="sumamultiplicacion">➕✖️<span>Suma y Multiplica</span></button>
                            </div>
                            
                            <div class="mode-btn-wrapper">
                                <button class="mode-btn" data-mode="informatica">💻<span>Informática</span></button>
                                <label class="finalist-label">
                                    <input type="checkbox" class="finalist-checkbox" data-mode="informatica"> 🔥 Finalista Único
                                </label>
                            </div>
                        </div>
                        <div class="vote-results glass-panel">
                            <h4>Resultados:</h4>
                            <div id="voteResults"></div>
                        </div>
                    </div>
                    
                    <div class="player-list" id="multiplayerPlayerList"></div>
                </div>
                 <div class="lobby-buttons-container">
                    <button class="btn-enhanced ready-btn" id="readyBtn">👍 Listo</button>
                    <button class="btn-enhanced" id="startVoteBtn" style="display:none;">Iniciar Votación</button> 
                </div>
            </div>
            
            <div id="lobbyCharacter" aria-hidden="false">
                <div class="lobby-mascot-wrap" aria-hidden="true">
                    <div class="mascot-shadow" aria-hidden="true"></div>
                    <img src="muñeco1.png" class="lobby-mascot" alt="Pequeña muñeca saludando" loading="lazy" decoding="async" width="220" height="220" onerror="this.src='avatar1.png'">
                </div>

                <style>
                    #lobbyCharacter { display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:auto; z-index:1; height: 100%; width: 300px; }

                    .lobby-mascot-wrap {
                        width: 220px;
                        height: 220px;
                        display:flex;
                        align-items:center;
                        justify-content:center;
                        position:relative;
                        overflow:visible;
                        pointer-events:auto;
                    }

                    .mascot-shadow {
                        position:absolute;
                        bottom:14px;
                        width:140px;
                        height:18px;
                        background: radial-gradient(ellipse at center, rgba(0,0,0,0.25) 0%, rgba(0,0,0,0.08) 60%, transparent 100%);
                        border-radius:50%;
                        transform:scale(0.6);
                        opacity:0;
                        transition:opacity .6s ease, transform .6s ease;
                        filter: blur(6px);
                        z-index:0;
                    }

                    .lobby-mascot {
                        width: 220px;
                        height: auto;
                        transform: translateY(120%) scale(0.7) rotate(0deg);
                        opacity: 0;
                        transition: transform .9s cubic-bezier(.2,.9,.3,1), opacity .9s cubic-bezier(.2,.9,.3,1);
                        will-change: transform, opacity;
                        z-index:2;
                        cursor: pointer;
                        filter: drop-shadow(0 8px 18px rgba(0,0,0,0.25));
                    }

                    .lobby-mascot.enter {
                        transform: translateY(0) scale(1) rotate(0deg);
                        opacity: 1;
                    }

                    .lobby-mascot.wave {
                        animation: mascotBob 3s ease-in-out infinite, mascotWave 1.6s ease-in-out .2s infinite;
                        transform-origin: 50% 80%;
                    }

                    @keyframes mascotBob {
                        0% { transform: translateY(0) scale(1) rotate(0deg); }
                        50% { transform: translateY(-10px) scale(1.01) rotate(0deg); }
                        100% { transform: translateY(0) scale(1) rotate(0deg); }
                    }

                    @keyframes mascotWave {
                        0% { transform: translateY(0) rotate(0deg); }
                        20% { transform: translateY(-6px) rotate(-6deg); }
                        40% { transform: translateY(0) rotate(0deg); }
                        60% { transform: translateY(-6px) rotate(6deg); }
                        80% { transform: translateY(0) rotate(0deg); }
                        100% { transform: translateY(0) rotate(0deg); }
                    }

                    .lobby-mascot.enter + .mascot-shadow,
                    .lobby-mascot.enter ~ .mascot-shadow,
                    .lobby-mascot.enter ~ .mascot-shadow {
                        opacity: 1;
                        transform: scale(1);
                    }

                    .lobby-mascot.jump {
                        animation: mascotJump 520ms cubic-bezier(.25,.7,.25,1);
                    }
                    @keyframes mascotJump {
                        0% { transform: translateY(0) scale(1); }
                        30% { transform: translateY(-15px) scale(1.03); }
                        60% { transform: translateY(0) scale(0.99); }
                        100% { transform: translateY(0) scale(1); }
                    }

                    .welcome-bubble {
                        margin-top: -18px;
                        background: linear-gradient(45deg, var(--azul), var(--morado));
                        color: white;
                        padding: 8px 14px;
                        border-radius: 18px;
                        font-family: 'Fredoka One', cursive;
                        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
                        transform-origin: center;
                        transition: transform .3s ease, opacity .3s ease;
                        opacity: 0;
                        pointer-events: none;
                        font-size: 0.95rem;
                    }

                    .show-welcome .welcome-bubble {
                        opacity: 1;
                        transform: translateY(-6px);
                    }

                    @media (max-width: 768px) {
                        .lobby-mascot-wrap, .lobby-mascot { width: 180px; }
                        .mascot-shadow { width: 110px; bottom:12px; }
                    }
                </style>

                <script>
                    (function(){
                        const parent = document.getElementById('lobbyCharacter');
                        const wrap = parent ? parent.querySelector('.lobby-mascot-wrap') : null;
                        const img = wrap ? wrap.querySelector('.lobby-mascot') : null;
                        const shadow = wrap ? wrap.querySelector('.mascot-shadow') : null;

                        if (!img) return;

                        requestAnimationFrame(() => {
                            setTimeout(() => {
                                img.classList.add('enter');
                                if (shadow) shadow.style.opacity = '1';
                            }, 80);

                            setTimeout(() => {
                                img.classList.add('wave');
                                if (parent) parent.classList.add('show-welcome');
                            }, 950);
                        });

                        img.addEventListener('click', () => {
                            img.classList.remove('jump');
                            void img.offsetWidth;
                            img.classList.add('jump');
                            const clickSound = document.getElementById('clickSound');
                            if (clickSound && typeof clickSound.play === 'function') {
                                try { clickSound.currentTime = 0; clickSound.play(); } catch(e) {}
                            }
                            setTimeout(() => img.classList.remove('jump'), 600);
                        });

                        document.addEventListener('visibilitychange', () => {
                            if (document.hidden) {
                                img.classList.remove('wave');
                            } else {
                                if (img.classList.contains('enter')) img.classList.add('wave');
                            }
                        });
                    })();
                </script>

                <div class="welcome-bubble" id="welcomeBubble">
                    ¡Holaa! ¡Mucha suerte!
                </div>

                <script>
                (function(){
                    const bubble = document.getElementById('welcomeBubble');
                    const templates = [
                        "¡Hola {name}! 🎉 Bienvenido y mucha suerte, ¡a romperla!",
                        "Hey {name} — prepárate para dominar las mates 🧠💥",
                        "¡Qué onda {name}! 🍀 ¡Que la suerte te acompañe!",
                        "{name}, ¡bienvenido! Espero que ganes y te diviertas ✨",
                        "¡Vamos {name}! 🤩 Haz que esos números se rindan",
                        "¡Bienvenido {name}! 💎 Mucha suerte — tú puedes"
                    ];

                    function getPlayerName(){
                        try {
                            if (window.gameInstance && window.gameInstance.player && window.gameInstance.player.name) {
                                return window.gameInstance.player.name;
                            }
                        } catch(e){}
                        const stored = localStorage.getItem('playerName') || localStorage.getItem('playerId');
                        return stored ? stored.substring(0,20) : 'Jugador';
                    }

                    function pickMessage(name){
                        const idx = Math.floor(Math.random() * templates.length);
                        return templates[idx].replace('{name}', sanitize(name));
                    }

                    function sanitize(s){
                        return String(s).replace(/[<>]/g,'').trim() || 'Jugador';
                    }

                    let last = '';
                    function refresh(){
                        const name = getPlayerName();
                        if (name !== last) {
                            bubble.innerHTML = pickMessage(name);
                            last = name;
                        } else {
                            if (Math.random() > 0.6) bubble.innerHTML = pickMessage(name);
                        }
                        bubble.style.transform = 'translateY(-6px) scale(1.02)';
                        setTimeout(()=> bubble.style.transform = '', 500);
                    }

                    refresh();
                    const readyCheck = setInterval(()=>{
                        if (window.gameInstance && window.gameInstance.player) {
                            refresh();
                            clearInterval(readyCheck);
                        }
                    }, 300);

                    setInterval(refresh, 6000 + Math.floor(Math.random()*3000));
                })();
                </script>
            </div>
        </div>

        <!-- Nuevo panel de estadísticas detalladas -->
        <div class="player-stats-detailed glass-panel" id="playerStatsDetailed">
            <h3>📊 Mis Estadísticas</h3>
            <div class="stat-row">
                <span class="stat-label">Preguntas acertadas:</span>
                <span class="stat-value" id="statCorrect">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Preguntas falladas:</span>
                <span class="stat-value" id="statIncorrect">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Exactitud:</span>
                <span class="stat-value" id="statAccuracy">0%</span>
            </div>
            <div class="stat-bar">
                <div class="stat-bar-fill" id="statAccuracyBar" style="width: 0%"></div>
            </div>
            <div class="stat-row">
                <span class="stat-label">Tiempo promedio:</span>
                <span class="stat-value" id="statAvgTime">0s</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Mejor racha:</span>
                <span class="stat-value" id="statBestStreak">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Puntos por tiempo:</span>
                <span class="stat-value" id="statTimeBonus">0</span>
            </div>
        </div>

        <div class="tournament-indicator" id="tournamentIndicator" style="display: none;">
            <span id="tournamentText">¡Torneo Activo!</span>
            <span class="round-badge" id="roundBadge">Ronda</span>
        </div>

        <div class="live-ranking glass-panel" id="liveRanking">
            <h3>🏆 Ranking en Vivo</h3>
            <div id="rankingList"></div>
        </div>

        <div id="gameContainer">
            <h1>✨ Juego Matematica Pro ✨</h1>
            <div class="game-mode-indicator glass-panel" id="gameModeIndicator"></div>

            <div class="timer-container">
                <svg class="timer-svg" viewBox="0 0 100 100">
                    <circle class="timer-circle" cx="50" cy="50" r="45"></circle>
                </svg>
                <div class="timer-text" id="timerText">30</div>
            </div>

            <div class="game glass-panel">
                <p class="score">Puntos: <span id="playerScore">0</span> 💎</p>
                <p id="currentQuestion" class="question">Haz clic en un juego para comenzar</p>
                <img id="questionImage" class="question-image" style="display: none;">
                
                <div class="input-container" id="standardInput">
                    <input type="text" id="playerAnswer" readonly>
                    <div class="keyboard">
                        <div class="key" data-number="1">1</div>
                        <div class="key" data-number="2">2</div>
                        <div class="key" data-number="3">3</div>
                        <div class="key" data-number="4">4</div>
                        <div class="key" data-number="5">5</div>
                        <div class="key" data-number="6">6</div>
                        <div class="key" data-number="7">7</div>
                        <div class="key" data-number="8">8</div>
                        <div class="key" data-number="9">9</div>
                        <div class="key" data-action="clear">⌫</div>
                        <div class="key" data-number="0">0</div>
                        <div class="key negative" data-number="-">-</div>
                    </div>
                    <button class="btn-enhanced" id="submitAnswer">Responder 🚀</button>
                    <p id="answerResult" class="result waiting">Esperando respuesta... 🤔</p>
                </div>
                
                <div class="true-false-buttons" id="trueFalseButtons" style="display: none;">
                    <button class="true-false-btn true-btn" id="trueBtn">✅ Verdadero</button>
                    <button class="true-false-btn false-btn" id="falseBtn">❌ Falso</button>
                </div>

                <div class="abcd-buttons" id="abcdButtons" style="display: none;">
                    <button class="abcd-btn" data-answer="A"><span class="letter">A</span> <span class="answer-text">Opción A</span></button>
                    <button class="abcd-btn" data-answer="B"><span class="letter">B</span> <span class="answer-text">Opción B</span></button>
                    <button class="abcd-btn" data-answer="C"><span class="letter">C</span> <span class="answer-text">Opción C</span></button>
                    <button class="abcd-btn" data-answer="D"><span class="letter">D</span> <span class="answer-text">Opción D</span></button>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <button class="btn-enhanced" id="reiniciarBtn">🔄 Reiniciar Juego</button>
            <p id="mensajeVictoria" class="result"></p>
        </div>

        <div class="final-results" id="finalResults">
            <h1>🏆 ¡Juego Terminado! 🏆</h1>
            <div class="podium">
                <div class="podium-place" id="secondPlace">
                    <div class="podium-2"></div>
                    <div class="podium-name">
                        <img class="podium-avatar" id="secondAvatar" src="avatar1.png" onerror="this.src='avatar1.png'">
                        <span id="secondName">-</span>
                    </div>
                    <div class="podium-points">0 pts</div>
                </div>
                <div class="podium-place" id="firstPlace">
                    <div class="podium-1"></div>
                    <div class="podium-name">
                        <img class="podium-avatar" id="firstAvatar" src="avatar1.png" onerror="this.src='avatar1.png'">
                        <span id="firstName">-</span>
                    </div>
                    <div class="podium-points">0 pts</div>
                    <div class="winner-dancing-emoji" id="winnerDancingEmoji" style="display:none;">🎉</div>
                </div>
                <div class="podium-place" id="thirdPlace">
                    <div class="podium-3"></div>
                    <div class="podium-name">
                        <img class="podium-avatar" id="thirdAvatar" src="avatar1.png" onerror="this.src='avatar1.png'">
                        <span id="thirdName">-</span>
                    </div>
                    <div class="podium-points">0 pts</div>
                </div>
            </div>
            <div class="other-players glass-panel" id="otherPlayers"></div>
            <button class="btn-enhanced" id="backToLobby">Volver al Lobby</button>
        </div>
    </main>

    <div class="theme-toggle" id="themeToggle">🌙</div>
    
    <button class="btn-enhanced skip-btn" id="skipQuestion">⏭️ Saltar pregunta</button>

    <div class="connection-status connected" id="connectionStatus">🟢 Conectado</div>

    <div class="achievement-popup glass-panel" id="achievementPopup">
        <div class="achievement-icon">🏆</div>
        <h3 id="achievementTitle">Logro Desbloqueado</h3>
        <p id="achievementDescription">Descripción del logro</p>
        <button class="btn-enhanced" id="closeAchievement">¡Genial!</button>
    </div>

    <div class="player-stats glass-panel" id="playerStats">
        <h3>📊 Mis Estadísticas</h3>
        <div id="statsContent"></div>
        <button class="btn-enhanced" id="closeStats">Cerrar</button>
    </div>

    <div id="revealPhase" class="reveal-phase" style="display: none;">
        <div class="reveal-content glass-panel">
            <h2>¡Respuesta Correcta!</h2>
            <div id="revealCorrectAnswer" class="reveal-correct"></div>
            <div id="revealPlayerResult" class="reveal-player-result"></div>
            <div id="revealStreakBonus" class="reveal-streak-bonus"></div>
            <div id="revealTimeBonus" class="reveal-time-bonus"></div>
        </div>
    </div>

    <div id="resultsCountdownOverlay" class="results-countdown" style="display: none;"></div>

    <div class="finalist-announcement-screen" id="finalistAnnouncementScreen" style="display: none;">
        <div class="finalist-announcement-content glass-panel neon-border">
            <h2 id="announcementTitle">¡La élite de la partida!</h2>
            <p>Los siguientes jugadores pasan a la siguiente ronda:</p>
            <div class="finalist-list" id="finalistList">
                </div>
        </div>
    </div>

    <div class="spectator-screen" id="spectatorScreen" style="display: none;">
        <h2>👀 Modo Espectador 👀</h2>
        <p>Viendo la ronda final. ¡Anima a los finalistas!</p>
        <div id="spectatorQuestion" class="question">Esperando la siguiente pregunta...</div>
        <div id="spectatorRanking" class="live-ranking" style="position: static; display: block; margin: 20px auto;">
            <h3>Ranking de la Final</h3>
            <div id="spectatorRankingList"></div>
        </div>
        <div class="emoji-chat">
            <button class="emoji-btn">👏</button>
            <button class="emoji-btn">🔥</button>
            <button class="emoji-btn">😂</button>
            <button class="emoji-btn">😱</button>
            <button class="emoji-btn">🤯</button>
        </div>
        <div id="emoji-animation-container"></div>
    </div>

    <div class="ultimate-winner-screen" id="ultimateWinnerScreen" style="display: none;">
        <div class="ultimate-winner-content">
            <div class="crown">👑</div>
            <h1>¡CAMPEÓN ABSOLUTO!</h1>
            <div class="winner-info">
                <img id="ultimateWinnerAvatar" class="podium-avatar" style="width: 80px; height: 80px;" src="avatar1.png" onerror="this.src='avatar1.png'">
                <h2 id="ultimateWinnerName">Nombre del Ganador</h2>
            </div>
            <button class="btn-enhanced" id="backToLobbyFromWinner">Volver al Lobby</button>
        </div>
    </div>

    <div id="effectsContainer" class="explosion-container"></div>

    <audio id="correctSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>
    <audio id="wrongSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" preload="auto"></audio>
    <audio id="winSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>
    <audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" preload="auto"></audio>
    <audio id="countdownSound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-explosion-1699.mp3" preload="auto"></audio>
    <audio id="achievementSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" preload="auto"></audio>
    <audio id="revealSound" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" preload="auto"></audio>
    <audio id="explosionSound" src="https://assets.mixkit.co/sfx/preview/mixkit-explosion-with-debris-1701.mp3" preload="auto"></audio>

    <script>
        // --- SCRIPT PARTÍCULAS OPTIMIZADO ---
        function createParticles() {
            if (document.querySelector('.particle')) return;
            
            const container = document.body;
            const particleCount = 15;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 8 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.animationDuration = `${Math.random() * 20 + 15}s`;
                particle.style.animationDelay = `${Math.random() * 10}s`;
                particle.style.opacity = '0.3';
                container.insertBefore(particle, container.firstChild);
            }
        }

        class GameManager {
            constructor() {
                this.STATES = {
                    LOADING: 0,
                    JOIN_SCREEN: 1,
                    LOBBY: 2,
                    VOTING: 3,
                    PLAYING: 4,
                    RESULTS: 5,
                    REVEAL: 6,
                    ANNOUNCING_SEMIFINALISTS: 7,
                    SEMIFINAL_COUNTDOWN: 8,
                    SEMIFINAL_PLAY: 9,
                    ANNOUNCING_FINALISTS: 10,
                    FINAL_COUNTDOWN: 11,
                    FINAL_PLAY: 12,
                    SPECTATING: 13,
                    ULTIMATE_WINNER: 14
                };
                this.state = this.STATES.LOADING;

                this.player = {
                    id: null,
                    name: "",
                    grade: "",
                    displayName: "",
                    avatar: "1",
                    points: 0,
                    hasAnswered: false,
                    hasVoted: false,
                    streak: 0,
                    maxStreak: 0,
                    avgResponseTime: 0,
                    responseTimes: [],
                    history: [],
                    isProfessor: false,
                    isReady: false,
                    gamesPlayed: 0,
                    favoriteMode: null,
                    modeStats: {},
                    achievements: [],
                    lastAnswerCorrect: false,
                    correctAnswers: 0,
                    incorrectAnswers: 0,
                    totalTimeBonus: 0,
                    currentGameStats: {
                        correct: 0,
                        incorrect: 0,
                        timeBonus: 0
                    }
                };
                
                this.questions = [];
                this.currentQuestionIndex = 0;
                this.gameMode = null;
                this.timeLeft = 30;
                this.timerDuration = 30;
                this.timerInterval = null;
                this.soundEnabled = true;
                this.currentQuestionData = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 3000;
                this.closestAnswerMode = false;
                this.lastAnswerTime = null;
                this.revealPhaseActive = false;
                this.revealPhaseDuration = 3000;
                
                this.isMultiplayer = false;
                this.isHost = false;
                this.gamePin = '';
                this.players = [];
                this.playerVotes = {};
                this.selectedGameMode = null;
                this.playerRanking = [];
                this.maxPlayers = 15;
                this.socket = null;
                this.socketUrl = "wss://juego-matematic.onrender.com";
                this.heartbeatInterval = null;
                this.lastPongTime = null;
                
                this.isFinalistTournament = false;
                this.currentTournamentRound = null;
                this.tournamentFinalists = [];
                this.spectatorMode = false;
                this.tournamentRounds = {
                    normal: 'Juego Normal',
                    semifinal: 'Semifinales',
                    final: 'Final'
                };

                this.voteTime = 30;
                this.voteInterval = null;
                this.voteCounts = { 
                    operaciones: 0,
                    misterioso: 0,
                    secuencia: 0,
                    potenciacion: 0,
                    combinadas: 0,
                    relampago: 0,
                    "verdadero-falso": 0,
                    "mas-cercano": 0,
                    "sumamultiplicacion": 0,
                    "informatica": 0
                };
                this.isVotingActive = false;
                
                this.lastRanking = [];
                this.rankingUpdateInterval = null;
                this.rankingUpdateRate = 1000;
                this.animationPending = false;
                
                this.achievementsList = {
                    perfectStreak: {
                        id: "perfectStreak",
                        title: "Racha Perfecta",
                        description: "Responde correctamente todas las preguntas en una partida",
                        icon: "🏅",
                        condition: (player) => player.streak >= 10
                    },
                    lightningFast: {
                        id: "lightningFast",
                        title: "Relámpago",
                        description: "Responde correctamente en menos de 3 segundos",
                        icon: "⚡",
                        condition: (player) => player.responseTimes.some(t => t > 0 && t < 3)
                    },
                    strategist: {
                        id: "strategist",
                        title: "Estratega",
                        description: "Gana más de 10 puntos por tiempo en una respuesta",
                        icon: "🧠",
                        condition: (player) => player.history.some(h => h.points > 10) 
                    },
                    veteran: {
                        id: "veteran",
                        title: "Veterano",
                        description: "Juega 5 partidas completas",
                        icon: "🎖️",
                        condition: (player) => player.gamesPlayed >= 5
                    }
                };

                this.effectsContainer = document.getElementById('effectsContainer');
                this.lobby3DCanvas = document.getElementById('lobby3DCanvas');
                this.lobbyCountdownMessage = document.getElementById('lobbyCountdownMessage');
                this.abcdButtonsContainer = document.getElementById('abcdButtons');
                this.winnerDancingEmoji = document.getElementById('winnerDancingEmoji');
                this.resultsCountdownOverlay = document.getElementById('resultsCountdownOverlay');
                this.themeToggle = document.getElementById('themeToggle');
                this.timerCircle = document.querySelector('.timer-circle');
                this.timerText = document.getElementById('timerText');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.skipQuestionBtn = document.getElementById('skipQuestion');
                this.readyBtn = document.getElementById('readyBtn');
                this.startVoteBtn = document.getElementById('startVoteBtn');
                this.gameModeIndicator = document.getElementById('gameModeIndicator');
                this.achievementPopup = document.getElementById('achievementPopup');
                this.closeAchievement = document.getElementById('closeAchievement');
                this.playerStats = document.getElementById('playerStats');
                this.closeStats = document.getElementById('closeStats');
                this.statsContent = document.getElementById('statsContent');
                this.modeButtons = document.getElementById('modeButtons');
                this.revealPhase = document.getElementById('revealPhase');
                this.revealCorrectAnswer = document.getElementById('revealCorrectAnswer');
                this.revealPlayerResult = document.getElementById('revealPlayerResult');
                this.revealStreakBonus = document.getElementById('revealStreakBonus');
                this.revealTimeBonus = document.getElementById('revealTimeBonus');
                this.tournamentIndicator = document.getElementById('tournamentIndicator');
                this.tournamentText = document.getElementById('tournamentText');
                this.roundBadge = document.getElementById('roundBadge');
                this.playerStatsDetailed = document.getElementById('playerStatsDetailed');

                this.currentPhase = 'clasificacion';
                
                this.setupEventListeners();
                this.checkDarkModePreference();
                this.loadPlayerStats();
                this.initLobby3D();
                this.updatePhaseBackground();

                setTimeout(() => {
                    this.setState(this.STATES.JOIN_SCREEN);
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('joinScreen').classList.add('active');
                }, 1500);
            }

            // MÉTODO CORREGIDO: Resetear puntos en semifinales y finales
            resetPointsForTournamentRound() {
                console.log(`🔄 Reiniciando puntos para ronda: ${this.currentTournamentRound}`);
                
                this.players.forEach(player => {
                    player.points = 0;
                    player.streak = 0;
                    player.responseTimes = [];
                    player.currentGameStats = {
                        correct: 0,
                        incorrect: 0,
                        timeBonus: 0
                    };
                });
                
                if (this.player) {
                    this.player.points = 0;
                    this.player.streak = 0;
                    this.player.responseTimes = [];
                    this.player.currentGameStats = {
                        correct: 0,
                        incorrect: 0,
                        timeBonus: 0
                    };
                    document.getElementById('playerScore').textContent = '0';
                }
                
                this.updateLiveRanking();
                console.log(`✅ Puntos reiniciados para ${this.currentTournamentRound}`);
            }

            // MÉTODO CORREGIDO: Manejar inicio de rondas de torneo
            handleStartTournamentRound(round, finalists) {
                console.log(`🎯 Iniciando ronda de torneo: ${round}`, finalists);
                
                this.currentTournamentRound = round;
                this.tournamentFinalists = finalists;
                
                if (round === 'semifinal') {
                    this.currentPhase = 'semifinal';
                } else if (round === 'final') {
                    this.currentPhase = 'final';
                }
                this.updatePhaseBackground();
                
                // RESETEAR PUNTOS AL INICIAR NUEVA RONDA
                this.resetPointsForTournamentRound();
                
                const isPlayerFinalist = finalists.some(f => f.id === this.player.id);
                this.spectatorMode = !isPlayerFinalist;

                this.players = finalists;
                this.updateLiveRanking();

                const title = round === 'semifinal' ? '¡Comienzan las Semifinales!' : '¡La Gran Final!';
                document.getElementById('announcementTitle').textContent = title;
                
                const finalistList = document.getElementById('finalistList');
                finalistList.innerHTML = '';
                
                finalists.forEach((player, index) => {
                    const card = document.createElement('div');
                    card.className = 'finalist-player-card';
                    card.style.animationDelay = `${index * 0.2}s`;
                    card.innerHTML = `
                        <img src="avatar${player.avatar || '1'}.png" class="ranking-avatar" onerror="this.src='avatar1.png'">
                        <span>${this.extractName(player.name)}</span>
                        <span style="margin-left: auto; font-weight: bold;">0 pts</span>
                    `;
                    finalistList.appendChild(card);
                });

                if (isPlayerFinalist) {
                    const announcementState = round === 'semifinal' ? 
                        this.STATES.ANNOUNCING_SEMIFINALISTS : 
                        this.STATES.ANNOUNCING_FINALISTS;
                    
                    this.setState(announcementState);

                    setTimeout(() => {
                        this.showTournamentCountdown(3, () => {
                            const playState = round === 'semifinal' ? 
                                this.STATES.SEMIFINAL_PLAY : 
                                this.STATES.FINAL_PLAY;
                            
                            this.setState(playState);
                            this.updateTournamentIndicator(round);
                            
                            if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                                this.socket.send(JSON.stringify({
                                    type: 'request_tournament_question',
                                    pin: this.gamePin,
                                    round: round
                                }));
                            }
                        });
                    }, 4000);
                } else {
                    this.enterSpectatorMode(finalists);
                }
            }

            // MÉTODO OPTIMIZADO: Inicializar lobby 3D con mejor rendimiento
            initLobby3D() {
                try {
                    if (!window.WebGLRenderingContext) {
                        console.log("WebGL no disponible, desactivando fondo 3D");
                        this.lobby3DCanvas.style.display = 'none';
                        return;
                    }
                    
                    this.scene = new THREE.Scene();
                    this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    this.renderer = new THREE.WebGLRenderer({ 
                        canvas: this.lobby3DCanvas, 
                        alpha: true,
                        antialias: false
                    });
                    
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                    this.renderer.setPixelRatio(1);
                    
                    const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
                    this.scene.add(ambientLight);
                    
                    const geometry = new THREE.BoxGeometry(0.08, 0.08, 0.08);
                    this.particles = [];
                    const particleCount = 100;
                    
                    for (let i = 0; i < particleCount; i++) {
                        const material = new THREE.MeshBasicMaterial({ 
                            color: 0x8888ff, 
                            transparent: true, 
                            opacity: 0.5
                        });
                        const particle = new THREE.Mesh(geometry, material);
                        particle.position.x = (Math.random() - 0.5) * 15;
                        particle.position.y = (Math.random() - 0.5) * 15;
                        particle.position.z = (Math.random() - 0.5) * 15;
                        this.scene.add(particle);
                        this.particles.push(particle);
                    }

                    this.camera.position.z = 5;

                    this.resizeHandler = () => {
                        this.camera.aspect = window.innerWidth / window.innerHeight;
                        this.camera.updateProjectionMatrix();
                        this.renderer.setSize(window.innerWidth, window.innerHeight);
                    };
                    window.addEventListener('resize', this.resizeHandler);
                    
                } catch(e) {
                    console.error("Error al inicializar lobby 3D:", e);
                    this.lobby3DCanvas.style.display = 'none';
                }
            }

            // MÉTODO OPTIMIZADO: Animación del lobby 3D
            animateLobby3D = () => {
                if (!this.scene || this.state !== this.STATES.LOBBY && this.state !== this.STATES.VOTING) {
                    return;
                }
                
                this.particles.forEach(particle => {
                    particle.rotation.x += 0.005;
                    particle.rotation.y += 0.002;
                    particle.position.z += 0.005;
                    if (particle.position.z > this.camera.position.z + 5) {
                        particle.position.z = this.camera.position.z - 12;
                    }
                });

                this.scene.rotation.y += 0.0005;
                this.scene.rotation.x += 0.0002;

                this.renderer.render(this.scene, this.camera);
                
                if (this.state === this.STATES.LOBBY || this.state === this.STATES.VOTING) {
                    this.lobbyAnimationId = requestAnimationFrame(this.animateLobby3D);
                }
            };

            // MÉTODO CORREGIDO: Configurar event listeners con avatares locales
            setupEventListeners() {
                this.themeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    this.themeToggle.textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
                    this.playSound('clickSound');
                    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
                });
                
                document.querySelectorAll('.avatar-option-enhanced').forEach(avatar => {
                    avatar.addEventListener('click', () => {
                        document.querySelectorAll('.avatar-option-enhanced').forEach(a => a.classList.remove('selected'));
                        avatar.classList.add('selected');
                        this.player.avatar = avatar.dataset.avatar;
                        this.playSound('clickSound');
                    });
                });
                
                document.querySelector('.avatar-option-enhanced').click();
                
                document.getElementById('joinGame').addEventListener('click', () => this.joinGame());
                document.getElementById('createGame').addEventListener('click', () => this.createGame());
                
                document.querySelectorAll('.key[data-number]').forEach(key => {
                    key.addEventListener('click', () => {
                        this.addNumber(key.dataset.number);
                    });
                });
                
                document.querySelector('.key[data-action="clear"]').addEventListener('click', () => {
                    this.clearNumber();
                });
                
                document.getElementById('submitAnswer').addEventListener('click', () => this.submitAnswer());
                
                document.getElementById('playerAnswer').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.submitAnswer();
                });
                
                document.getElementById('trueBtn').addEventListener('click', () => this.checkAnswer('true'));
                document.getElementById('falseBtn').addEventListener('click', () => this.checkAnswer('false'));

                document.querySelectorAll('.abcd-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.submitABCDAnswer(btn.dataset.answer));
                });
                
                document.getElementById('reiniciarBtn').addEventListener('click', () => {
                    if (this.isMultiplayer && this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify({ type: 'game_over', pin: this.gamePin }));
                    }
                    this.reiniciarJuegoLocal();
                });

                document.getElementById('backToLobby').addEventListener('click', () => {
                    if (this.isMultiplayer && this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify({ type: 'game_over', pin: this.gamePin }));
                    }
                    this.reiniciarJuegoLocal();
                });
                
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.castVote(btn.dataset.mode));
                });
                
                this.skipQuestionBtn.addEventListener('click', () => this.skipQuestionAsProfessor());
                this.readyBtn.addEventListener('click', () => this.toggleReady());
                this.startVoteBtn.addEventListener('click', () => this.initiateVoteAsHost());
                this.closeAchievement.addEventListener('click', () => {
                    this.achievementPopup.style.display = 'none';
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 's' && e.ctrlKey) {
                        e.preventDefault();
                        this.toggleStats();
                    }
                    if (e.key === 'd' && e.ctrlKey) {
                        e.preventDefault();
                        this.toggleDetailedStats();
                    }
                });

                this.closeStats.addEventListener('click', () => {
                    this.playerStats.style.display = 'none';
                });

                document.querySelectorAll('.emoji-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.playSound('clickSound');
                        if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                            this.socket.send(JSON.stringify({
                                type: 'emoji_reaction',
                                pin: this.gamePin,
                                emoji: btn.textContent,
                                from: this.player.id
                            }));
                        }
                    });
                });

                document.getElementById('backToLobbyFromWinner').addEventListener('click', () => {
                    if (this.isMultiplayer && this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify({ type: 'game_over', pin: this.gamePin }));
                    }
                    this.reiniciarJuegoLocal();
                });

                window.addEventListener('online', () => {
                    if (this.socket && this.socket.readyState === WebSocket.CLOSED) {
                        this.attemptReconnect();
                    }
                });
            }

            // MÉTODO CORREGIDO: Actualizar lista de jugadores con avatares locales
            updatePlayerList() {
                const playerList = document.getElementById('multiplayerPlayerList');
                playerList.innerHTML = '';
                
                const sortedPlayers = [...this.players].sort((a, b) => a.name.localeCompare(b.name));

                sortedPlayers.forEach(player => {
                    const playerElement = document.createElement('div');
                    playerElement.className = 'player-badge-enhanced';
                    playerElement.setAttribute('data-player-id', player.id);
                    
                    if (player.id === this.player.id) {
                        playerElement.classList.add('current-player');
                    }
                    if (player.isProfessor) {
                        playerElement.classList.add('host');
                    }
                    
                    playerElement.innerHTML = `
                        <img src="avatar${player.avatar || '1'}.png" class="player-avatar" onerror="this.src='avatar1.png'">
                        <span>${this.extractName(player.name)}</span>
                    `;
                    
                    if (player.isProfessor) {
                        playerElement.innerHTML += ' 👨‍🏫';
                    }
                    
                    if (player.isReady) {
                        playerElement.innerHTML += ' ✓';
                    }
                    
                    playerList.appendChild(playerElement);
                });
                
                document.getElementById('playerCount').textContent = this.players.length;
                
                if (this.players.some(p => p.id === this.player.id)) {
                    this.readyBtn.disabled = this.player.isReady;
                    this.readyBtn.textContent = this.player.isReady ? "❌ No listo" : "👍 Listo";
                }
            }

            // MÉTODO CORREGIDO: Mostrar resultados con avatares locales
            showMultiplayerResults(finalRanking) {
                try {
                    console.log("🏆 Mostrando resultados finales:", finalRanking);
                    this.setState(this.STATES.RESULTS);
                    
                    const firstPlace = document.getElementById('firstPlace');
                    const secondPlace = document.getElementById('secondPlace');
                    const thirdPlace = document.getElementById('thirdPlace');
                    const otherPlayers = document.getElementById('otherPlayers');
                    
                    otherPlayers.innerHTML = '';
                    this.winnerDancingEmoji.style.display = 'none';

                    document.getElementById('firstName').textContent = '-';
                    document.getElementById('firstAvatar').src = 'imagenes/avatar1.png';
                    firstPlace.querySelector('.podium-points').textContent = '0 pts';
                    document.getElementById('secondName').textContent = '-';
                    document.getElementById('secondAvatar').src = 'imagenes/avatar1.png';
                    secondPlace.querySelector('.podium-points').textContent = '0 pts';
                    document.getElementById('thirdName').textContent = '-';
                    document.getElementById('thirdAvatar').src = 'imagenes/avatar1.png';
                    thirdPlace.querySelector('.podium-points').textContent = '0 pts';

                    this.showResultsCountdown(3, () => {
                        this.playSound('winSound');
                        this.createConfettiRain(2000);
                        
                        if (finalRanking.length > 0) {
                            const first = finalRanking[0];
                            document.getElementById('firstName').textContent = this.extractName(first.name);
                            document.getElementById('firstAvatar').src = `imagenes/avatar${first.avatar || '1'}.png`;
                            firstPlace.querySelector('.podium-points').textContent = `${first.points || 0} pts`;
                            this.winnerDancingEmoji.style.display = 'block';
                            
                            setTimeout(() => {
                                this.celebrateWinner(firstPlace);
                            }, 500);

                            if (finalRanking.length > 1) {
                                const second = finalRanking[1];
                                document.getElementById('secondName').textContent = this.extractName(second.name);
                                document.getElementById('secondAvatar').src = `imagenes/avatar${second.avatar || '1'}.png`;
                                secondPlace.querySelector('.podium-points').textContent = `${second.points || 0} pts`;
                            }
                            
                            if (finalRanking.length > 2) {
                                const third = finalRanking[2];
                                document.getElementById('thirdName').textContent = this.extractName(third.name);
                                document.getElementById('thirdAvatar').src = `imagenes/avatar${third.avatar || '1'}.png`;
                                thirdPlace.querySelector('.podium-points').textContent = `${third.points || 0} pts`;
                            }
                        }
                        
                        for (let i = 3; i < finalRanking.length; i++) {
                            const player = finalRanking[i];
                            const playerElement = document.createElement('div');
                            playerElement.className = 'other-player';
                            
                            playerElement.innerHTML = `
                                <div class="player-info">
                                    <img src="avatar${player.avatar || '1'}.png" class="other-avatar" onerror="this.src='avatar1.png'">
                                    <span>${i + 1}. ${this.extractName(player.name)}</span>
                                </div>
                                <span>${player.points || 0} pts</span>
                            `;
                            otherPlayers.appendChild(playerElement);
                        }
                    });

                } catch (error) {
                    console.error("Error al mostrar resultados:", error);
                    this.showError("Ocurrió un error al mostrar los resultados finales");
                }
            }

            // MÉTODO OPTIMIZADO: Actualizar ranking en vivo
            updateLiveRanking() {
                if (this.animationPending) return;
                this.animationPending = true;
                
                setTimeout(() => {
                    this.animationPending = false;
                    
                    const rankingList = document.getElementById('rankingList');
                    const currentRanking = [...this.players].sort((a, b) => {
                        if ((b.points || 0) !== (a.points || 0)) return (b.points || 0) - (a.points || 0);
                        const avgA = typeof a.avgResponseTime === 'number' && !isNaN(a.avgResponseTime) ? a.avgResponseTime : Infinity;
                        const avgB = typeof b.avgResponseTime === 'number' && !isNaN(b.avgResponseTime) ? b.avgResponseTime : Infinity;
                        if (avgA !== avgB) return avgA - avgB;
                        return (b.maxStreak || 0) - (a.maxStreak || 0);
                    });
                    
                    rankingList.innerHTML = '';
                    
                    currentRanking.forEach((player, index) => {
                        const playerElement = document.createElement('div');
                        playerElement.className = 'ranking-item';
                        playerElement.setAttribute('data-player-id', player.id);
                        
                        if (player.id === this.player.id) {
                            playerElement.classList.add('current-player');
                        }
                        
                        if (this.tournamentFinalists.some(f => f.id === player.id)) {
                            playerElement.classList.add('finalist-highlight');
                        }
                        
                        const streakBadge = player.streak > 2 ? `<span style="color: orange;"> 🔥${player.streak}</span>` : '';
                        
                        playerElement.innerHTML = `
                            <span class="ranking-position">${index + 1}°</span>
                            <img src="avatar${player.avatar || '1'}.png" class="ranking-avatar" onerror="this.src='avatar1.png'">
                            <span class="ranking-name">${this.extractName(player.name)}</span>
                            <span class="ranking-points">${player.points || 0}${streakBadge}</span>
                        `;
                        
                        rankingList.appendChild(playerElement);
                    });
                    
                    this.lastRanking = currentRanking;
                }, 100);
            }

            // MÉTODO OPTIMIZADO: Efectos de partículas
            createExplosion(x, y, color = '#FFD700', particleCount = 15) {
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'explosion-particle';
                    particle.style.backgroundColor = color;
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    
                    const angle = Math.random() * Math.PI * 2;
                    const velocity = 1 + Math.random() * 2;
                    const size = 3 + Math.random() * 6;
                    
                    particle.style.width = size + 'px';
                    particle.style.height = size + 'px';
                    
                    this.effectsContainer.appendChild(particle);
                    
                    gsap.to(particle, {
                        x: Math.cos(angle) * (30 + Math.random() * 70),
                        y: Math.sin(angle) * (30 + Math.random() * 70),
                        opacity: 0,
                        scale: 0,
                        duration: 0.8 + Math.random() * 0.4,
                        ease: "power2.out",
                        onComplete: () => {
                            if (particle.parentNode) {
                                particle.parentNode.removeChild(particle);
                            }
                        }
                    });
                }
                
                this.playSound('explosionSound');
            }

            // MÉTODO OPTIMIZADO: Lluvia de confeti
            createConfettiRain(duration = 3000) {
                const confettiColors = ['#f94144', '#f3722c', '#f8961e', '#f9c74f', '#90be6d', '#43aa8b', '#577590'];
                const confettiCount = 80;
                
                for (let i = 0; i < confettiCount; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                        confetti.style.left = Math.random() * 100 + 'vw';
                        confetti.style.top = '-20px';
                        confetti.style.width = (8 + Math.random() * 8) + 'px';
                        confetti.style.height = (8 + Math.random() * 8) + 'px';
                        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0%';
                        
                        this.effectsContainer.appendChild(confetti);
                        
                        gsap.to(confetti, {
                            y: window.innerHeight + 100,
                            rotation: Math.random() * 360,
                            x: '+=50',
                            duration: 1.5 + Math.random() * 1.5,
                            ease: "power1.in",
                            onComplete: () => {
                                if (confetti.parentNode) {
                                    confetti.parentNode.removeChild(confetti);
                                }
                            }
                        });
                    }, i * (duration / confettiCount));
                }
            }

            // MÉTODO CORREGIDO: Reiniciar juego local
            reiniciarJuegoLocal() {
                try {
                    this.playSound('clickSound');
                    
                    clearInterval(this.timerInterval);
                    clearInterval(this.voteInterval);
                    if (this.rankingUpdateInterval) {
                        clearInterval(this.rankingUpdateInterval);
                        this.rankingUpdateInterval = null;
                    }
                    if (this.heartbeatInterval) {
                        clearInterval(this.heartbeatInterval);
                        this.heartbeatInterval = null;
                    }
                    
                    if (this.lobbyAnimationId) {
                        cancelAnimationFrame(this.lobbyAnimationId);
                    }
                    
                    this.isFinalistTournament = false;
                    this.currentTournamentRound = null;
                    this.tournamentFinalists = [];
                    this.spectatorMode = false;
                    this.tournamentIndicator.style.display = 'none';

                    this.currentPhase = 'clasificacion';
                    this.updatePhaseBackground();

                    this.currentQuestionIndex = 0;
                    this.currentQuestionData = null;
                    this.selectedGameMode = null;
                    this.closestAnswerMode = false;
                    this.isVotingActive = false;
                    this.winnerDancingEmoji.style.display = 'none';

                    document.getElementById("currentQuestion").textContent = "Haz clic en un juego para comenzar";
                    document.getElementById("playerAnswer").value = "";
                    document.getElementById("answerResult").textContent = "Esperando respuesta... 🤔";
                    document.getElementById("answerResult").className = "result waiting";
                    document.getElementById("mensajeVictoria").innerHTML = "";
                    document.getElementById("progressBar").style.width = "0%";
                    document.getElementById('submitAnswer').disabled = false;
                    document.getElementById('questionImage').style.display = 'none';
                    
                    document.querySelectorAll('.mode-btn').forEach(btn => {
                        btn.classList.remove('selected', 'voted');
                        btn.disabled = false;
                    });

                    document.getElementById('standardInput').style.display = 'none';
                    document.getElementById('trueFalseButtons').style.display = 'none';
                    this.abcdButtonsContainer.style.display = 'none';
                    
                    this.playerStatsDetailed.style.display = 'none';
                    
                    this.setState(this.STATES.LOBBY);
                    if (this.isHost) {
                        this.startVoteBtn.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Error al reiniciar juego localmente:", error);
                    this.showError("Error al reiniciar el juego localmente.");
                }
            }

            // MÉTODO CORREGIDO: Unirse al juego
            joinGame() {
                const playerName = this.sanitizeInput(document.getElementById('playerName').value.trim());
                const grade = this.sanitizeInput(document.getElementById('grade').value.trim());
                const gamePin = document.getElementById('gamePin').value.trim();

                if (!playerName || playerName.length < 3) {
                    document.getElementById('joinError').textContent = 'El nombre debe tener al menos 3 caracteres';
                    return;
                }

                if (!grade) {
                    document.getElementById('joinError').textContent = 'Ingresa tu grado';
                    return;
                }

                if (!/^\d{4}$/.test(gamePin)) {
                    document.getElementById('joinError').textContent = 'PIN debe ser 4 dígitos';
                    return;
                }
                
                document.getElementById('joinError').textContent = '';

                let playerId = localStorage.getItem('playerId');
                if (!playerId) {
                    playerId = this.generateId();
                    localStorage.setItem('playerId', playerId);
                }

                this.player = {
                    ...this.player,
                    id: playerId,
                    name: playerName,
                    grade: grade,
                    displayName: `${playerName} (${grade})`,
                    points: 0,
                    hasAnswered: false,
                    hasVoted: false,
                    streak: 0,
                    avgResponseTime: 0,
                    responseTimes: [],
                    history: [],
                    isProfessor: false,
                    isReady: false,
                    lastAnswerCorrect: false,
                    currentGameStats: {
                        correct: 0,
                        incorrect: 0,
                        timeBonus: 0
                    }
                };

                this.gamePin = gamePin;
                this.isHost = false;
                this.connectToServer();
            }

            // MÉTODO CORREGIDO: Crear juego
            createGame() {
                const playerName = this.sanitizeInput(document.getElementById('playerName').value.trim());
                const grade = this.sanitizeInput(document.getElementById('grade').value.trim());
                
                if (!playerName || playerName.length < 3) {
                    document.getElementById('joinError').textContent = 'El nombre debe tener al menos 3 caracteres';
                    return;
                }

                if (!grade) {
                    document.getElementById('joinError').textContent = 'Ingresa tu grado';
                    return;
                }
                
                document.getElementById('joinError').textContent = '';

                const createBtn = document.getElementById('createGame');
                createBtn.disabled = true;
                createBtn.innerHTML = '<span class="loader-small"></span> Creando sala...';

                let playerId = localStorage.getItem('playerId');
                if (!playerId) {
                    playerId = this.generateId();
                    localStorage.setItem('playerId', playerId);
                }

                this.gamePin = Math.floor(1000 + Math.random() * 9000).toString();
                document.getElementById('gamePin').value = this.gamePin;
                
                this.player = {
                    ...this.player,
                    id: playerId,
                    name: playerName,
                    grade: grade,
                    displayName: `${playerName} (Profesor)`,
                    points: 0,
                    hasAnswered: false,
                    hasVoted: false,
                    streak: 0,
                    avgResponseTime: 0,
                    responseTimes: [],
                    history: [],
                    isProfessor: true,
                    isReady: false,
                    lastAnswerCorrect: false,
                    currentGameStats: {
                        correct: 0,
                        incorrect: 0,
                        timeBonus: 0
                    }
                };
                
                this.isHost = true;
                
                console.log("[Cliente] Intentando conectar al servidor para crear sala...");
                this.connectToServer();

                setTimeout(() => {
                    createBtn.disabled = false;
                    createBtn.textContent = 'Crear nueva sala';
                }, 2000);
            }

            // MÉTODO CORREGIDO: Conectar al servidor
            connectToServer() {
                try {
                    this.updateConnectionStatus('connecting', '🟡 Conectando...');
                    console.log(`[Cliente] Intentando conectar a: ${this.socketUrl}?playerId=${this.player.id}`);
                    
                    if (!navigator.onLine) {
                        this.handleNetworkError(new Error('Sin conexión a internet'));
                        return;
                    }

                    const wsUrl = `${this.socketUrl}?playerId=${this.player.id}`;
                    this.socket = new WebSocket(wsUrl);
                    
                    this.setupHeartbeat();
                    
                    this.socket.onerror = (error) => {
                        console.error("[Cliente] Error de conexión WS:", error);
                        this.handleNetworkError(error, "Error de conexión con el servidor");
                        this.attemptReconnect();
                    };
                    
                    this.socket.onclose = (event) => {
                        console.log("[Cliente] Conexión WS cerrada:", event.code, event.reason);
                        clearInterval(this.heartbeatInterval);
                        this.heartbeatInterval = null;

                        let message = "Conexión cerrada";
                        if (event.code === 1000) {
                            message = "Conexión finalizada (normal)";
                            this.updateConnectionStatus('disconnected', `🔴 ${message}`);
                        } else {
                            if (this.isMultiplayer || this.state === this.STATES.JOIN_SCREEN) {
                                this.handleNetworkError(new Error("Conexión cerrada inesperadamente"), "Se perdió la conexión con el servidor");
                                this.attemptReconnect();
                            } else {
                                 this.updateConnectionStatus('disconnected', `🔴 Desconectado`);
                            }
                        }
                    };
                    
                    this.socket.onopen = () => {
                        console.log("[Cliente] Conexión WS establecida.");
                        this.reconnectAttempts = 0;
                        this.lastPongTime = Date.now();
                        this.updateConnectionStatus('connected', '🟢 Conectado');
                        
                        let messageType;

                        if (this.isHost) {
                            messageType = 'create_room';
                        } else if (this.gamePin && this.state !== this.STATES.JOIN_SCREEN) {
                            messageType = 'rejoin_room';
                        } else {
                            messageType = 'join_room';
                        }

                        console.log(`[Cliente] Decidiendo tipo de mensaje: ${messageType} para PIN: ${this.gamePin}`);

                        this.socket.send(JSON.stringify({
                            type: messageType,
                            pin: this.gamePin,
                            player: {
                                id: this.player.id,
                                name: this.player.displayName,
                                avatar: this.player.avatar,
                                points: this.player.points,
                                isProfessor: this.player.isProfessor,
                                isReady: this.player.isReady
                            }
                        }));
                    };
                    
                    this.socket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            console.log("[Cliente] Mensaje WS recibido:", data);
                            
                            if (data.type === 'pong') {
                                this.lastPongTime = Date.now();
                                return;
                            }
                            
                            this.handleSocketMessage(data);
                        } catch (error) {
                            console.error("[Cliente] Error al procesar mensaje WS:", error);
                        }
                    };
                } catch (error) {
                    this.handleNetworkError(error, "Error al conectar con el servidor (catch general)");
                    this.attemptReconnect();
                }
            }

            // MÉTODO CORREGIDO: Manejar mensajes del socket
            handleSocketMessage(data) {
                console.log("[Cliente] Mensaje WS recibido:", data.type);
                
                if (data.type === 'question_update' || data.type === 'tournament_question_update') {
                    this.handleQuestionUpdate(data);
                    return;
                }
                
                if (data.type.startsWith('tournament_')) {
                    this.handleTournamentUpdate(data);
                    return;
                }
                
                switch(data.type) {
                    case 'room_created': 
                    case 'room_joined':
                        this.handleRoomJoined(data);
                        break;
                        
                    case 'player_joined':
                        this.handlePlayerJoined(data);
                        break;
                        
                    case 'player_left':
                        this.handlePlayerLeft(data);
                        break;
                        
                    case 'player_ready_update':
                        this.handlePlayerReadyUpdate(data);
                        break;
                        
                    case 'start_voting':
                        this.isVotingActive = true;
                        this.startVoteCountdown(data.time);
                        break;
                        
                    case 'update_vote_timer':
                        this.updateVoteTimer(data.time);
                        break;
                        
                    case 'vote_update':
                        this.updateVoteResults(data.votes);
                        break;
                        
                    case 'game_starting':
                        this.showNotification(`¡El juego comenzará! Modo: ${this.getModeName(data.mode)}`);
                        this.animateLobbyCountdown(data.mode);
                        break;
                        
                    case 'game_start':
                        this.isFinalistTournament = data.isFinalistTournament;
                        this.startGame(data.mode, data.closestAnswerMode);
                        break;
                        
                    case 'game_over':
                        this.handleGameOver(data);
                        break;
                        
                    case 'player_score_update':
                        this.updatePlayerScore(data.playerId, data.points, data.streak, data.maxStreak, data.avgResponseTime);
                        break;
                    
                    case 'host_skipped_question':
                        if (!this.isHost) {
                            this.showNotification("El profesor ha saltado la pregunta.");
                        }
                        break;

                    case 'error':
                        this.handleError(data);
                        break;
                    
                    case 'new_host':
                        if (data.newHostId === this.player.id) {
                            this.isHost = true;
                            this.player.isProfessor = true;
                            this.showNotification("¡Ahora eres el nuevo profesor y anfitrión!");
                        } else {
                            this.showNotification(`${this.extractName(data.newHostName)} es ahora el nuevo profesor.`);
                        }
                        this.updatePlayerList();
                        break;
                        
                    case 'reveal_phase':
                        this.startRevealPhase(data.correctAnswer, data.playerCorrect, data.streakBonus, data.pointsEarned, data.options, data.timeBonus);
                        break;
                    
                    case 'ranking_update':
                        this.players = data.players;
                        this.updateLiveRanking();
                        const myData = this.players.find(p => p.id === this.player.id);
                        if (myData) {
                            this.updatePlayerScore(myData.id, myData.points, myData.streak, myData.maxStreak, myData.avgResponseTime);
                        }
                        break;
                    
                    case 'answer_received':
                        console.log("Servidor: Respuesta recibida.");
                        break;

                    case 'start_semifinals':
                        this.handleStartTournamentRound('semifinal', data.finalists);
                        break;
                        
                    case 'start_final':
                        this.handleStartTournamentRound('final', data.finalists);
                        break;
                        
                    case 'enter_spectator_mode':
                        this.enterSpectatorMode(data.finalists);
                        break;
                        
                    case 'spectator_update':
                        this.updateSpectatorView(data);
                        break;
                        
                    case 'emoji_broadcast':
                        this.showFlyingEmoji(data.emoji);
                        break;

                    case 'ultimate_winner':
                        this.showUltimateWinner(data.winner);
                        break;

                    default:
                        console.warn('[Cliente] Tipo de mensaje no reconocido:', data.type);
                }
            }

            // MÉTODO CORREGIDO: Manejar actualización del torneo
            handleTournamentUpdate(data) {
                console.log("Actualización del torneo:", data.type);
                
                if (data.type === 'tournament_ranking_update') {
                    this.tournamentFinalists = data.finalists;
                    this.updateLiveRanking();
                    this.highlightFinalists();
                    
                    if (this.spectatorMode) {
                        this.updateSpectatorView({
                            finalists: data.finalists,
                            question: null
                        });
                    }
                } else if (data.type === 'tournament_round_end') {
                    this.showNotification(`¡${data.round === 'semifinal' ? 'Semifinales' : 'Final'} terminada!`);
                    
                    if (data.round === 'semifinal' && data.winners) {
                        setTimeout(() => {
                            this.handleStartTournamentRound('final', data.winners);
                        }, 3000);
                    } else if (data.round === 'final' && data.winner) {
                        setTimeout(() => {
                            this.showUltimateWinner(data.winner);
                        }, 3000);
                    }
                }
            }

            // MÉTODO CORREGIDO: Manejar actualización de pregunta
            handleQuestionUpdate(data) {
                this.currentQuestionData = data.question;
                this.lastAnswerTime = Date.now();
                this.currentQuestionIndex = data.questionIndex;
                this.timerDuration = data.timerDuration || 30;
                
                const isTournamentQuestion = data.type === 'tournament_question_update';
                const currentRound = data.round || 'normal';
                
                if (isTournamentQuestion) {
                    console.log(`[Cliente] Recibida pregunta de torneo - Ronda: ${currentRound}`);
                    this.currentTournamentRound = currentRound;
                    
                    this.updateTournamentIndicator(currentRound);
                }
                
                this.displayQuestion(data.question, isTournamentQuestion, currentRound);
                
                if (data.questionIndex !== undefined && data.totalQuestions !== undefined) {
                    const progreso = ((data.questionIndex + 1) / data.totalQuestions) * 100;
                    document.getElementById("progressBar").style.width = `${progreso}%`;
                }
            }

            // MÉTODO CORREGIDO: Mostrar pregunta
            displayQuestion(questionData = null, isTournament = false, round = 'normal') {
                try {
                    const question = questionData || this.currentQuestionData;
                    if (!question) {
                        console.error("No hay datos de pregunta para mostrar");
                        return;
                    }
                    
                    const questionElement = document.getElementById("currentQuestion");
                    
                    let questionPrefix = "";
                    if (isTournament) {
                        if (round === 'semifinal') {
                            questionPrefix = "<div class='tournament-question-indicator'>🏆 SEMIFINALES</div>";
                        } else if (round === 'final') {
                             questionPrefix = "<div class='tournament-question-indicator'>👑 FINAL DEL TORNEO</div>";
                        }
                    }
                    
                    questionElement.innerHTML = questionPrefix + `<div>${question.pregunta}</div>`;
                    
                    questionElement.classList.remove('question-animation');
                    void questionElement.offsetWidth;
                    questionElement.classList.add('question-animation');
                    
                    document.getElementById("playerAnswer").value = "";
                    document.getElementById("answerResult").textContent = "Esperando respuesta... 🤔";
                    document.getElementById("answerResult").className = "result waiting";
                    this.player.hasAnswered = false;
                    
                    document.getElementById('submitAnswer').disabled = false;
                    document.getElementById('trueBtn').disabled = false;
                    document.getElementById('falseBtn').disabled = false;
                    document.querySelectorAll('.abcd-btn').forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('selected-answer');
                    });
                    
                    this.lastAnswerTime = Date.now();
                    
                    const questionImage = document.getElementById('questionImage');
                    if (question.imagen) {
                        questionImage.src = question.imagen;
                        questionImage.style.display = 'block';
                    } else {
                        questionImage.style.display = 'none';
                    }
                    
                    this.setupQuestionInterface(question.tipo);
                    
                    this.resetTimer();
                    
                } catch (error) {
                    console.error("Error al mostrar pregunta:", error);
                    this.showError("Error al cargar la pregunta.");
                }
            }

            // MÉTODO CORREGIDO: Configurar interfaz de pregunta
            setupQuestionInterface(questionType) {
                document.getElementById('standardInput').style.display = 'none';
                document.getElementById('trueFalseButtons').style.display = 'none';
                this.abcdButtonsContainer.style.display = 'none';

                switch(questionType) {
                    case 'verdadero-falso':
                        document.getElementById('trueFalseButtons').style.display = 'flex';
                        break;
                        
                    case 'informatica':
                        this.abcdButtonsContainer.style.display = 'grid';
                        const options = this.currentQuestionData.opciones;
                        if (options) {
                            document.querySelector('.abcd-btn[data-answer="A"] .answer-text').textContent = options.A;
                            document.querySelector('.abcd-btn[data-answer="B"] .answer-text').textContent = options.B;
                            document.querySelector('.abcd-btn[data-answer="C"] .answer-text').textContent = options.C;
                            document.querySelector('.abcd-btn[data-answer="D"] .answer-text').textContent = options.D;
                        }
                        break;
                        
                    default:
                        document.getElementById('standardInput').style.display = 'block';
                        break;
                }
            }

            // MÉTODO CORREGIDO: Manejar unión a sala
            handleRoomJoined(data) {
                console.log("[Cliente] handleRoomJoined activado. Data:", data);
                this.isMultiplayer = true;
                this.players = data.players || [];
                this.isHost = data.isHost;
                
                this.gamePin = data.pin;
                document.getElementById('lobbyPin').textContent = this.gamePin;

                const currentPlayerFromServer = this.players.find(p => p.id === this.player.id);
                if (currentPlayerFromServer) {
                    this.player.isProfessor = currentPlayerFromServer.isProfessor;
                    this.player.isReady = currentPlayerFromServer.isReady;
                }

                this.updatePlayerList();
                
                this.isVotingActive = data.isVotingActive || false;
                if (this.isVotingActive) {
                    this.setState(this.STATES.VOTING);
                    this.startVoteCountdown(data.voteTimeRemaining);
                    this.updateVoteResults(data.currentVotes);
                    this.selectedGameMode = data.selectedGameMode;
                } else if (data.selectedGameMode) {
                    this.selectedGameMode = data.selectedGameMode;
                    this.showNotification(`Modo de juego pre-seleccionado: ${this.getModeName(this.selectedGameMode)}`);
                    this.setState(this.STATES.LOBBY);
                } else {
                    this.setState(this.STATES.LOBBY);
                }
                
                if (data.isGameRunning && data.question) {
                    this.startGame(data.gameMode, data.closestAnswerMode);
                    this.currentQuestionIndex = data.questionIndex;
                    this.handleQuestionUpdate(data);
                }
            }

            // MÉTODO CORREGIDO: Manejar jugador unido
            handlePlayerJoined(data) {
                const existingPlayer = this.players.find(p => p.id === data.player.id);
                if (!existingPlayer) {
                    this.players.push(data.player);
                    this.updatePlayerList();
                    this.showNotification(`Jugador ${this.extractName(data.player.name)} se ha unido :3`);
                } else {
                    Object.assign(existingPlayer, data.player);
                    this.updatePlayerList();
                    this.showNotification(`${this.extractName(data.player.name)} se ha reconectado`);
                }
            }

            // MÉTODO CORREGIDO: Manejar jugador salido
            handlePlayerLeft(data) {
                const playerIndex = this.players.findIndex(p => p.id === data.playerId);
                if (playerIndex !== -1) {
                    const playerName = this.players[playerIndex].name;
                    this.players.splice(playerIndex, 1);
                    this.updatePlayerList();
                    this.showNotification(`${this.extractName(playerName)} se ha desconectado`);
                }
            }

            // MÉTODO CORREGIDO: Manejar actualización de estado listo
            handlePlayerReadyUpdate(data) {
                const player = this.players.find(p => p.id === data.playerId);
                if (player) {
                    player.isReady = data.isReady;
                    this.updatePlayerList();
                    
                    if (data.playerId === this.player.id) {
                        this.player.isReady = data.isReady;
                        this.readyBtn.textContent = data.isReady ? "❌ No listo" : "👍 Listo";
                        this.readyBtn.disabled = data.isReady;
                    }
                    
                    if (this.isHost && !this.isVotingActive && this.state === this.STATES.LOBBY) {
                        const nonProfessorPlayers = this.players.filter(p => !p.isProfessor);
                        const allNeededPlayersReady = nonProfessorPlayers.every(p => p.isReady);
                        const minPlayersForVote = 2;

                        this.startVoteBtn.style.display = (this.players.length >= minPlayersForVote && allNeededPlayersReady) ? 'block' : 'none';
                    }
                    else if (data.playerId !== this.player.id) {
                        const action = data.isReady ? "está listo" : "ya no está listo";
                        this.showNotification(`${this.extractName(player.name)} ${action}`);
                    }
                }
            }

            // MÉTODO CORREGIDO: Alternar estado listo
            toggleReady() {
                this.readyBtn.disabled = true;
                this.player.isReady = !this.player.isReady;
                
                if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                    this.socket.send(JSON.stringify({
                        type: 'player_ready',
                        pin: this.gamePin,
                        playerId: this.player.id,
                        isReady: this.player.isReady
                    }));
                }
            }

            // MÉTODO CORREGIDO: Iniciar votación como host
            initiateVoteAsHost() {
                if (!this.isHost || this.isVotingActive || this.state !== this.STATES.LOBBY) return;

                const nonProfessorPlayers = this.players.filter(p => !p.isProfessor);
                const minPlayersForVote = 2;

                if (this.players.length < minPlayersForVote) {
                    this.showNotification(`Necesitas al menos ${minPlayersForVote} jugadores en la sala para iniciar la votación.`);
                    return;
                }
                
                this.playSound('clickSound');
                this.showNotification("El anfitrión ha iniciado la votación!");
                
                if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                    this.socket.send(JSON.stringify({
                        type: 'initiate_vote',
                        pin: this.gamePin,
                        hostId: this.player.id
                    }));
                }
            }

            // MÉTODO CORREGIDO: Manejar fin del juego
            handleGameOver(data) {
                clearInterval(this.timerInterval);
                clearInterval(this.rankingUpdateInterval);
                this.rankingUpdateInterval = null;
                
                if (this.isFinalistTournament) {
                    console.log("Juego normal terminado. Esperando inicio de semifinales del servidor.");
                } else {
                    const finalRanking = Array.isArray(data.finalRanking) ? 
                        data.finalRanking.map(p => ({
                            id: p.id,
                            name: p.name || p.displayName,
                            avatar: p.avatar || '1',
                            points: p.points || 0,
                            streak: p.streak || 0,
                            maxStreak: p.maxStreak || 0,
                            achievements: p.achievements || []
                        })) : [];
                    
                    this.updatePlayerStatistics(finalRanking);
                    this.showMultiplayerResults(finalRanking);
                }
            }

            // MÉTODO CORREGIDO: Actualizar estadísticas del jugador
            updatePlayerStatistics(finalRanking) {
                this.player.gamesPlayed = (this.player.gamesPlayed || 0) + 1;
                
                if (this.selectedGameMode) {
                    if (!this.player.modeStats) {
                        this.player.modeStats = {};
                    }
                    
                    if (!this.player.modeStats[this.selectedGameMode]) {
                        this.player.modeStats[this.selectedGameMode] = {
                            games: 0,
                            wins: 0,
                            points: 0,
                            maxStreak: 0
                        };
                    }
                    
                    const modeStats = this.player.modeStats[this.selectedGameMode];
                    modeStats.games += 1;
                    modeStats.points += this.player.points;
                    
                    if (this.player.maxStreak > (modeStats.maxStreak || 0)) {
                        modeStats.maxStreak = this.player.maxStreak;
                    }
                    
                    const playerPosition = finalRanking.findIndex(p => p.id === this.player.id);
                    if (playerPosition >= 0 && playerPosition < 3) {
                        modeStats.wins += 1;
                    }
                    
                    let maxGames = 0;
                    let favoriteMode = null;
                    
                    for (const mode in this.player.modeStats) {
                        if (this.player.modeStats[mode].games > maxGames) {
                            maxGames = this.player.modeStats[mode].games;
                            favoriteMode = mode;
                        }
                    }
                    
                    this.player.favoriteMode = favoriteMode;
                }
                
                if (this.player.streak > this.player.maxStreak) {
                    this.player.maxStreak = this.player.streak;
                }

                this.checkAchievements();
                
                this.savePlayerStats();
            }

            // MÉTODO CORREGIDO: Verificar logros
            checkAchievements() {
                for (const achievementId in this.achievementsList) {
                    const achievement = this.achievementsList[achievementId];
                    
                    if (!this.player.achievements.some(a => a.id === achievementId)) {
                        if (achievement.condition(this.player)) {
                            this.unlockAchievement(achievementId, achievement);
                        }
                    }
                }
            }

            // MÉTODO CORREGIDO: Desbloquear logro
            unlockAchievement(achievementId, achievement) {
                this.player.achievements.push({
                    id: achievementId,
                    title: achievement.title,
                    description: achievement.description,
                    icon: achievement.icon,
                    date: new Date().toISOString()
                });
                
                this.showAchievementPopup(achievement);
                
                this.savePlayerStats();
            }

            // MÉTODO CORREGIDO: Mostrar popup de logro
            showAchievementPopup(achievement) {
                document.getElementById('achievementTitle').textContent = achievement.title;
                document.getElementById('achievementDescription').textContent = achievement.description;
                document.getElementById('achievementPopup').querySelector('.achievement-icon').textContent = achievement.icon;
                
                this.achievementPopup.style.display = 'block';
                this.playSound('achievementSound');
                
                setTimeout(() => {
                    if (this.achievementPopup.style.display === 'block') {
                        this.achievementPopup.style.display = 'none';
                    }
                }, 5000);
            }

            // MÉTODO CORREGIDO: Manejar error
            handleError(data) {
                document.getElementById('joinError').textContent = data.message;
                this.showNotification(`Error: ${data.message}`);
                if (this.state === this.STATES.LOADING || this.state === this.STATES.JOIN_SCREEN) {
                    this.setState(this.STATES.JOIN_SCREEN);
                }
            }

            // MÉTODO CORREGIDO: Iniciar cuenta regresiva de votación
            startVoteCountdown(time) {
                if (this.voteInterval) {
                    clearInterval(this.voteInterval);
                    this.voteInterval = null;
                }
                
                this.isVotingActive = true;
                this.setState(this.STATES.VOTING);

                this.voteCounts = {
                    operaciones: 0, misterioso: 0, secuencia: 0, potenciacion: 0,
                    combinadas: 0, relampago: 0, "verdadero-falso": 0, "mas-cercano": 0,
                    "sumamultiplicacion": 0, "informatica": 0
                };
                document.getElementById('voteResults').innerHTML = '<p>Esperando votos...</p>';
                this.player.hasVoted = false;

                this.players.forEach(p => p.hasVoted = false);
                this.enableVotingButtons(true);
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('selected', 'voted');
                });
                
                this.voteTime = time;
                document.getElementById('voteTime').textContent = this.voteTime;
                
                if (this.voteTime > 0) {
                    this.voteInterval = setInterval(() => {
                        this.voteTime--;
                        document.getElementById('voteTime').textContent = this.voteTime;
                        if (this.voteTime <= 0) {
                            clearInterval(this.voteInterval);
                            this.voteInterval = null;
                            this.isVotingActive = false;
                            this.enableVotingButtons(false);
                        }
                    }, 1000);
                } else {
                    this.isVotingActive = false;
                    this.enableVotingButtons(false);
                }
            }

            // MÉTODO CORREGIDO: Actualizar temporizador de votación
            updateVoteTimer(time) {
                document.getElementById('voteTime').textContent = time;
                this.voteTime = time;
                if (time <= 0) {
                    this.isVotingActive = false;
                    this.enableVotingButtons(false);
                }
            }

            // MÉTODO CORREGIDO: Emitir voto
            castVote(mode) {
                if (!this.isVotingActive || this.player.hasVoted) return;
                
                this.player.hasVoted = true;
                
                const finalistCheckbox = document.querySelector(`.finalist-checkbox[data-mode="${mode}"]`);
                const isFinalistMode = finalistCheckbox ? finalistCheckbox.checked : false;

                let notificationMessage = `Has votado por: ${this.getModeName(mode)}`;
                if (isFinalistMode) {
                    notificationMessage += " (Finalista Único)";
                }
                this.showNotification(notificationMessage);
                
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.dataset.mode === mode) {
                        btn.classList.add('selected', 'voted');
                    } else {
                        btn.classList.remove('voted');
                    }
                });
                this.enableVotingButtons(false);
                
                this.playSound('clickSound');
                
                this.socket.send(JSON.stringify({
                    type: 'cast_vote',
                    pin: this.gamePin,
                    playerId: this.player.id,
                    mode: mode,
                    finalistMode: isFinalistMode
                }));
            }

            // MÉTODO CORREGIDO: Habilitar botones de votación
            enableVotingButtons(enable) {
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.disabled = !enable || this.player.hasVoted;
                });
            }

            // MÉTODO CORREGIDO: Actualizar resultados de votación
            updateVoteResults(votes) {
                this.voteCounts = votes;
                let resultsHTML = '';
                
                const sortedModes = Object.entries(this.voteCounts)
                    .sort(([, countA], [, countB]) => countB - countA)
                    .filter(([, count]) => count > 0);

                if (sortedModes.length > 0) {
                    sortedModes.forEach(([mode, count]) => {
                        resultsHTML += `<p>${this.getModeName(mode)}: <strong>${count}</strong> ${count === 1 ? 'voto' : 'votos'}</p>`;
                    });
                } else {
                    resultsHTML = '<p>Esperando votos...</p>';
                }
                
                document.getElementById('voteResults').innerHTML = resultsHTML;
            }

            // MÉTODO CORREGIDO: Obtener nombre del modo
            getModeName(mode) {
                const names = {
                    operaciones: '🔢 Operación Rápida',
                    misterioso: '❓ Número Misterioso',
                    secuencia: '📈 Secuencia Numérica',
                    potenciacion: '💪 Potenciación',
                    combinadas: '🧩 Op. Combinadas',
                    relampago: '⚡ Modo Relámpago',
                    "verdadero-falso": '✅❌ Verdadero/Falso',
                    "mas-cercano": '🎯 El más cercano',
                    "sumamultiplicacion": '➕✖️ Suma y Multiplica',
                    "informatica": '💻 Informática'
                };
                return names[mode] || mode;
            }

            // MÉTODO CORREGIDO: Animación de cuenta regresiva del lobby
            animateLobbyCountdown(mode) {
                this.lobbyCountdownMessage.textContent = `¡El modo ${this.getModeName(mode)} comenzará pronto!`;
                this.lobbyCountdownMessage.style.display = 'block';
                this.lobbyCountdownMessage.classList.add('active');

                setTimeout(() => {
                    this.lobbyCountdownMessage.classList.remove('active');
                    this.lobbyCountdownMessage.style.display = 'none';
                }, 3000);
            }

            // MÉTODO CORREGIDO: Reiniciar jugador para nuevo juego
            resetPlayerForNewGame() {
                console.log("🔄 Reiniciando estadísticas del jugador para nuevo juego");
                this.player.points = 0;
                this.player.streak = 0;
                this.player.responseTimes = [];
                this.player.history = [];
                this.player.hasAnswered = false;
                this.player.hasVoted = false;
                this.player.lastAnswerCorrect = false;
                this.player.avgResponseTime = 0;
                this.player.currentGameStats = {
                    correct: 0,
                    incorrect: 0,
                    timeBonus: 0
                };
                this.updatePlayerScore(this.player.id, 0, 0);
                this.updateDetailedStats();
                console.log("✅ Estadísticas reiniciadas para nuevo juego");
            }

            // MÉTODO CORREGIDO: Iniciar juego
            startGame(mode, closestAnswerMode = false) {
                console.log("🎮 Iniciando nuevo juego con modo:", mode);
                this.resetPlayerForNewGame();
                this.selectedGameMode = mode;
                this.closestAnswerMode = closestAnswerMode;
                this.isVotingActive = false;
                clearInterval(this.voteInterval);
                this.voteInterval = null;
                this.currentQuestionIndex = 0;
                this.currentQuestionData = null;
                this.player.hasAnswered = false;
                this.player.lastAnswerCorrect = false;

                let modeIndicatorText = `Modo: ${this.getModeName(mode)}`;
                if (this.isFinalistTournament) {
                    modeIndicatorText += " 🔥 ¡Torneo!";
                }
                this.gameModeIndicator.textContent = modeIndicatorText;

                document.getElementById('gameContainer').classList.remove('lightning-mode');
                if (mode === 'relampago') {
                    document.getElementById('gameContainer').classList.add('lightning-mode');
                }
                
                this.setState(this.STATES.PLAYING);
                this.createExplosion(window.innerWidth / 2, 100, '#4e8cff', 25);
                this.lastRanking = [...this.players].sort((a, b) => (b.points || 0) - (a.points || 0));
                this.updateLiveRanking();
                
                if (this.rankingUpdateInterval) {
                    clearInterval(this.rankingUpdateInterval);
                }
                this.rankingUpdateInterval = setInterval(() => this.updateLiveRanking(), 500);
            }

            // MÉTODO CORREGIDO: Iniciar fase de revelación
            startRevealPhase(correctAnswer, playerCorrect, streakBonus, pointsEarned, receivedOptions = undefined, timeBonus = 0) {
                this.setState(this.STATES.REVEAL);
                this.playSound('revealSound');
                
                const displayOptions = receivedOptions || (this.currentQuestionData ? this.currentQuestionData.opciones : {});

                let formattedCorrectAnswer = correctAnswer;
                if (this.selectedGameMode === 'verdadero-falso' || this.currentQuestionData.tipo === 'verdadero-falso') {
                    formattedCorrectAnswer = correctAnswer ? '✅ Verdadero' : '❌ Falso';
                } else if ((this.selectedGameMode === 'informatica') && displayOptions && displayOptions[correctAnswer]) {
                    formattedCorrectAnswer = `${correctAnswer}) ${displayOptions[correctAnswer]}`;
                }
                this.revealCorrectAnswer.innerHTML = `Respuesta correcta: <span class="reveal-correct-answer">${formattedCorrectAnswer}</span>`;
                
                let timeBonusText = '';
                if (timeBonus > 0) {
                    timeBonusText = `<div class="reveal-time-bonus">⏱️ +${timeBonus} puntos por velocidad</div>`;
                }
                
                if (playerCorrect) {
                    this.revealPlayerResult.innerHTML = `✅ <strong>¡Correcto! +${pointsEarned}</strong>${timeBonusText}`;
                    this.revealPlayerResult.style.color = 'var(--verde)';
                    this.playSound('correctSound');
                    this.createExplosion(window.innerWidth / 2, window.innerHeight / 2, '#6bff6b', 20);
                    
                    this.player.lastAnswerCorrect = true;
                    this.player.correctAnswers++;
                    this.player.currentGameStats.correct++;
                    if (timeBonus > 0) {
                        this.player.totalTimeBonus += timeBonus;
                        this.player.currentGameStats.timeBonus += timeBonus;
                    }
                } else {
                    this.revealPlayerResult.innerHTML = `❌ <strong>Incorrecto</strong>`;
                    this.revealPlayerResult.style.color = 'var(--rojo)';
                    this.playSound('wrongSound');
                    
                    this.player.lastAnswerCorrect = false;
                    this.player.incorrectAnswers++;
                    this.player.currentGameStats.incorrect++;
                }
                
                if (streakBonus > 0) {
                    this.revealStreakBonus.innerHTML = `🔥 ¡Racha +${streakBonus} puntos!`;
                    this.createExplosion(window.innerWidth / 2, window.innerHeight / 2 + 50, '#ffde59', 15);
                } else {
                    this.revealStreakBonus.innerHTML = '';
                }
                
                this.updateDetailedStats();
                
                this.applyPerformanceEffects(this.player.id, playerCorrect, this.player.streak);
                
                setTimeout(() => {
                    const currentState = this.state;
                    if (this.currentTournamentRound === 'semifinal') {
                         this.setState(this.STATES.SEMIFINAL_PLAY);
                    } else if (this.currentTournamentRound === 'final') {
                         this.setState(this.STATES.FINAL_PLAY);
                    } else if (this.state === this.STATES.REVEAL) {
                         this.setState(this.STATES.PLAYING);
                    }
                    
                    document.getElementById('submitAnswer').disabled = false;
                    document.getElementById('trueBtn').disabled = false;
                    document.getElementById('falseBtn').disabled = false;
                    document.querySelectorAll('.abcd-btn').forEach(btn => btn.disabled = false);
                }, this.revealPhaseDuration);
            }

            // MÉTODO CORREGIDO: Actualizar puntuación del jugador
            updatePlayerScore(playerId, points, streak, maxStreak, avgResponseTime, timeBonus = 0) {
                const player = this.players.find(p => p.id === playerId);
                if (player) {
                    player.points = points;
                    player.streak = streak;
                    player.maxStreak = maxStreak;
                    player.avgResponseTime = avgResponseTime;
                }
                
                if (playerId === this.player.id) {
                    const oldPoints = this.player.points;
                    this.player.points = points;
                    this.player.streak = streak;
                    this.player.maxStreak = maxStreak;
                    this.player.avgResponseTime = avgResponseTime;
                    
                    document.getElementById('playerScore').textContent = this.player.points;
                    
                    if (points > oldPoints) {
                        this.createPointsPopup(points - oldPoints);
                    }
                }
            }

            // MÉTODO CORREGIDO: Resaltar finalistas
            highlightFinalists() {
                const rankingItems = document.querySelectorAll('.ranking-item');
                rankingItems.forEach(item => {
                    const playerNameElement = item.querySelector('.ranking-name');
                    if (playerNameElement) {
                        const playerName = playerNameElement.textContent;
                        const isFinalist = this.tournamentFinalists.some(f => 
                            this.extractName(f.name) === playerName
                        );
                        
                        if (isFinalist) {
                            item.classList.add('finalist-highlight');
                        } else {
                            item.classList.remove('finalist-highlight');
                        }
                    }
                });
            }

            // MÉTODO CORREGIDO: Iniciar temporizador
            startTimer() {
                try {
                    this.timeLeft = this.timerDuration;
                    this.updateTimerUI();
                    
                    clearInterval(this.timerInterval);
                    this.timerInterval = setInterval(() => {
                        this.timeLeft--;
                        this.updateTimerUI();
                        
                        if (this.timeLeft <= 5 && this.timeLeft > 0 && this.soundEnabled) {
                            this.playSound('countdownSound');
                        }
                        
                        if (this.timeLeft <= 0) {
                            clearInterval(this.timerInterval);
                            if (this.isMultiplayer && this.socket && this.socket.readyState === WebSocket.OPEN && !this.player.hasAnswered) {
                                this.player.hasAnswered = true;
                                this.player.streak = 0;
                                document.getElementById("answerResult").textContent = "¡Tiempo agotado! ⏳";
                                document.getElementById("answerResult").className = "result incorrect";
                                
                                this.socket.send(JSON.stringify({
                                    type: 'submit_answer',
                                    pin: this.gamePin,
                                    playerId: this.player.id,
                                    answer: null,
                                    responseTime: this.timerDuration
                                }));
                            }
                        }
                    }, 1000);
                } catch (error) {
                    console.error("Error en el temporizador:", error);
                    this.showError("Error en el temporizador.");
                }
            }

            // MÉTODO CORREGIDO: Actualizar UI del temporizador
            updateTimerUI() {
                this.timerText.textContent = this.timeLeft;
                
                const circumference = 283;
                const offset = circumference - (this.timeLeft / this.timerDuration) * circumference;
                this.timerCircle.style.strokeDashoffset = offset;
                
                if (this.timeLeft <= 5) {
                    this.timerCircle.classList.add('timer-warning');
                    this.timerText.classList.add('timer-warning');
                } else {
                    this.timerCircle.classList.remove('timer-warning');
                    this.timerText.classList.remove('timer-warning');
                }
            }

            // MÉTODO CORREGIDO: Reiniciar temporizador
            resetTimer() {
                clearInterval(this.timerInterval);
                this.startTimer();
            }

            // MÉTODO CORREGIDO: Saltar pregunta como profesor
            skipQuestionAsProfessor() {
                if (!this.isProfessor || !this.isHost) {
                    this.showNotification("Solo el profesor puede saltar preguntas.");
                    return;
                }
                
                this.playSound('clickSound');
                if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                    this.socket.send(JSON.stringify({
                        type: 'skip_question',
                        pin: this.gamePin,
                        hostId: this.player.id
                    }));
                }
            }

            // MÉTODO CORREGIDO: Agregar número
            addNumber(num) {
                if (this.currentQuestionData && !this.player.hasAnswered) {
                    this.playSound('clickSound');
                    const playerAnswerInput = document.getElementById('playerAnswer');
                    playerAnswerInput.value += num;
                }
            }

            // MÉTODO CORREGIDO: Limpiar número
            clearNumber() {
                this.playSound('clickSound');
                document.getElementById('playerAnswer').value = "";
            }

            // MÉTODO CORREGIDO: Enviar respuesta
            submitAnswer() {
                const respuesta = document.getElementById('playerAnswer').value;
                this.checkAnswer(respuesta);
            }

            // MÉTODO CORREGIDO: Verificar respuesta
            checkAnswer(userAnswer) {
                try {
                    if (this.player.hasAnswered) {
                        console.log("Ya respondiste esta pregunta");
                        return;
                    }

                    document.getElementById('submitAnswer').disabled = true;
                    document.getElementById('trueBtn').disabled = true;
                    document.getElementById('falseBtn').disabled = true;
                    document.querySelectorAll('.abcd-btn').forEach(btn => btn.disabled = true);

                    this.player.hasAnswered = true;
                    document.getElementById("answerResult").textContent = "Respuesta enviada. ¡Esperando a los demás!";
                    document.getElementById("answerResult").className = "result waiting";

                    const responseTime = (Date.now() - this.lastAnswerTime) / 1000;
                    
                    const timeBonus = this.calculateTimeBonus(responseTime, this.timerDuration);
                    
                    if (this.isMultiplayer && this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify({
                            type: 'submit_answer',
                            pin: this.gamePin,
                            playerId: this.player.id,
                            answer: userAnswer,
                            responseTime: responseTime,
                            timeBonus: timeBonus
                        }));
                    }
                } catch (error) {
                    console.error("Error al enviar respuesta:", error);
                    this.showError("Error al enviar la respuesta.");
                    this.reEnableAnswerButtons();
                }
            }

            // MÉTODO CORREGIDO: Enviar respuesta ABCD
            submitABCDAnswer(answer) {
                if (this.player.hasAnswered) return;

                document.querySelectorAll('.abcd-btn').forEach(btn => {
                    btn.classList.remove('selected-answer');
                    btn.disabled = true;
                });
                document.querySelector(`.abcd-btn[data-answer="${answer}"]`).classList.add('selected-answer');

                this.checkAnswer(answer);
            }

            // MÉTODO CORREGIDO: Rehabilitar botones de respuesta
            reEnableAnswerButtons() {
                document.getElementById('submitAnswer').disabled = false;
                document.getElementById('trueBtn').disabled = false;
                document.getElementById('falseBtn').disabled = false;
                document.querySelectorAll('.abcd-btn').forEach(btn => btn.disabled = false);
                this.player.hasAnswered = false;
            }

            // MÉTODO CORREGIDO: Manejar error de red
            handleNetworkError(error, message = "Error de red") {
                console.error(message, error);
                this.showNotification(`${message}. Intentando reconectar...`);
            }

            // MÉTODO CORREGIDO: Generar ID
            generateId() {
                return Math.random().toString(36).substring(2, 9) + Date.now().toString(36);
            }

            // MÉTODO CORREGIDO: Reproducir sonido
            playSound(soundId) {
                if (!this.soundEnabled) return;
                try {
                    const sound = document.getElementById(soundId);
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play().catch(e => console.log("Error al reproducir sonido:", e));
                    }
                } catch (error) {
                    console.error("Error con el sonido:", error);
                }
            }

            // MÉTODO CORREGIDO: Configurar heartbeat
            setupHeartbeat() {
                clearInterval(this.heartbeatInterval);
                
                this.heartbeatInterval = setInterval(() => {
                    if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                        const now = Date.now();
                        
                        if (this.lastPongTime && now - this.lastPongTime > 30000) {
                            console.warn("[Cliente] No se recibió pong en 30s. Cerrando conexión para intentar reconectar...");
                            this.socket.close();
                            return;
                        }
                        
                        this.socket.send(JSON.stringify({ type: 'ping' }));
                    } else if (this.socket && this.socket.readyState === WebSocket.CLOSED) {
                        clearInterval(this.heartbeatInterval);
                        this.heartbeatInterval = null;
                    }
                }, 15000);
            }

            // MÉTODO CORREGIDO: Intentar reconexión
            attemptReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    console.log("[Cliente] Máximo de intentos de reconexión alcanzado");
                    this.showNotification("No se pudo reconectar. Intenta manualmente.");
                    this.showReconnectButton();
                    return;
                }
                
                this.reconnectAttempts++;
                const delay = Math.min(30000, this.reconnectAttempts * this.reconnectDelay);
                
                console.log(`[Cliente] Intentando reconectar en ${delay/1000} segundos... (Intento ${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                
                this.showNotification(`Reconectando... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                this.updateConnectionStatus('connecting', '🟡 Reconectando...');
                
                clearInterval(this.heartbeatInterval);
                this.heartbeatInterval = null;

                setTimeout(() => {
                    if (!this.socket || this.socket.readyState === WebSocket.CLOSED) {
                        this.connectToServer();
                    }
                }, delay);
            }

            // MÉTODO CORREGIDO: Mostrar botón de reconexión
            showReconnectButton() {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.innerHTML = '🔴 Desconectado <button id="reconnectBtn" class="btn-enhanced" style="padding: 5px 10px !important; font-size: 0.8rem !important; margin: 0 0 0 10px !important; width: auto !important;">Reconectar</button>';
                const existingBtn = document.getElementById('reconnectBtn');
                if (existingBtn) {
                     existingBtn.onclick = () => {
                        this.reconnectAttempts = 0;
                        this.connectToServer();
                        statusElement.textContent = '🟡 Conectando...';
                    };
                }
            }

            // MÉTODO CORREGIDO: Actualizar estado de conexión
            updateConnectionStatus(status, message = null) {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = `connection-status ${status}`;
                
                if (message) {
                    statusElement.textContent = message;
                } else {
                    switch(status) {
                        case 'connected':
                            statusElement.textContent = '🟢 Conectado';
                            break;
                        case 'disconnected':
                            statusElement.textContent = '🔴 Desconectado';
                            break;
                        case 'connecting':
                            statusElement.textContent = '🟡 Conectando...';
                            break;
                    }
                }
            }

            // MÉTODO CORREGIDO: Mostrar notificación
            showNotification(message, duration = 3000) {
                let notification = document.querySelector('.notification');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.className = 'notification';
                    document.body.appendChild(notification);
                }
                
                notification.textContent = message;
                notification.style.display = 'flex';
                
                notification.style.animation = 'none';
                void notification.offsetWidth;
                notification.style.animation = `fadeInOut ${duration}ms ease forwards`;
                
                setTimeout(() => {
                    if(notification.parentElement) {
                        notification.style.display = 'none';
                    }
                }, duration);
            }

            // MÉTODO CORREGIDO: Mostrar error
            showError(message) {
                this.showNotification(`❌ ${message}`, 5000);
            }

            // MÉTODO CORREGIDO: Extraer nombre
            extractName(fullName) {
                if (!fullName) return 'Jugador';
                const match = fullName.match(/^(.*?)\s*(\(.*\))?$/);
                return match && match[1] ? match[1].trim() : fullName.trim();
            }

            // MÉTODO CORREGIDO: Cambiar estado
            setState(newState) {
                this.state = newState;
                this.updateUIForState();
            }

            // MÉTODO CORREGIDO: Actualizar UI según estado
            updateUIForState() {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('joinScreen').style.display = 'none';
                document.getElementById('multiplayerLobby').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('finalResults').style.display = 'none';
                document.getElementById('liveRanking').style.display = 'none';
                this.gameModeIndicator.style.display = 'none';
                this.skipQuestionBtn.style.display = 'none';
                this.startVoteBtn.style.display = 'none';
                this.revealPhase.style.display = 'none';
                this.lobbyCountdownMessage.style.display = 'none';
                this.lobbyCountdownMessage.classList.remove('active');
                
                this.tournamentIndicator.style.display = 'none';
                
                document.getElementById('finalistAnnouncementScreen').style.display = 'none';
                document.getElementById('spectatorScreen').style.display = 'none';
                document.getElementById('ultimateWinnerScreen').style.display = 'none';

                if (this.state !== this.STATES.JOIN_SCREEN) {
                    document.getElementById('joinScreen').classList.remove('active');
                }

                switch(this.state) {
                    case this.STATES.LOADING:
                        document.getElementById('loadingScreen').style.display = 'flex';
                        break;
                    case this.STATES.JOIN_SCREEN:
                        document.getElementById('joinScreen').style.display = 'flex';
                        break;
                    case this.STATES.LOBBY:
                        document.getElementById('multiplayerLobby').style.display = 'flex';
                        this.readyBtn.style.display = 'block';
                        if (this.isHost) {
                            this.startVoteBtn.style.display = this.isVotingActive ? 'none' : 'block';
                        }
                        this.enableVotingButtons(true);
                        if (this.lobby3DCanvas.style.display !== 'block') {
                             this.lobby3DCanvas.style.display = 'block';
                             this.animateLobby3D();
                        }
                        break;
                    case this.STATES.VOTING:
                        document.getElementById('multiplayerLobby').style.display = 'flex';
                        this.readyBtn.style.display = 'none';
                        this.startVoteBtn.style.display = 'none';
                        this.enableVotingButtons(true);
                        if (this.lobby3DCanvas.style.display !== 'block') {
                            this.lobby3DCanvas.style.display = 'block';
                            this.animateLobby3D();
                        }
                        break;
                    case this.STATES.PLAYING:
                    case this.STATES.SEMIFINAL_PLAY:
                    case this.STATES.FINAL_PLAY:
                        document.getElementById('gameContainer').style.display = 'block';
                        document.getElementById('liveRanking').style.display = 'block';
                        this.gameModeIndicator.style.display = 'block';
                        this.readyBtn.style.display = 'none';
                        this.startVoteBtn.style.display = 'none';
                        if (this.isProfessor) {
                            this.skipQuestionBtn.style.display = 'block';
                        }
                        this.lobby3DCanvas.style.display = 'none';
                        cancelAnimationFrame(this.lobbyAnimationId);
                        
                        if (this.currentTournamentRound) {
                            this.updateTournamentIndicator(this.currentTournamentRound);
                        }
                        break;
                    case this.STATES.REVEAL:
                        this.revealPhase.style.display = 'flex';
                        this.lobby3DCanvas.style.display = 'none';
                        cancelAnimationFrame(this.lobbyAnimationId);
                        break;
                    case this.STATES.RESULTS:
                        document.getElementById('finalResults').style.display = 'flex';
                        this.lobby3DCanvas.style.display = 'none';
                        cancelAnimationFrame(this.lobbyAnimationId);
                        break;
                    case this.STATES.ANNOUNCING_SEMIFINALISTS:
                    case this.STATES.ANNOUNCING_FINALISTS:
                        document.getElementById('finalistAnnouncementScreen').style.display = 'flex';
                        break;
                    case this.STATES.SPECTATING:
                        document.getElementById('spectatorScreen').style.display = 'flex';
                        break;
                    case this.STATES.ULTIMATE_WINNER:
                        document.getElementById('ultimateWinnerScreen').style.display = 'flex';
                        break;
                }
            }

            // MÉTODO CORREGIDO: Sanitizar entrada
            sanitizeInput(input) {
                return input.replace(/[<>]/g, '').substring(0, 20);
            }

            // MÉTODO CORREGIDO: Verificar preferencia de modo oscuro
            checkDarkModePreference() {
                const darkMode = localStorage.getItem('darkMode') === 'true';
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                    this.themeToggle.textContent = '☀️';
                }
            }

            // MÉTODO CORREGIDO: Cargar estadísticas del jugador
            loadPlayerStats() {
                const savedStats = localStorage.getItem('playerStats');
                if (savedStats) {
                    try {
                        const stats = JSON.parse(savedStats);
                        if (!this.player.id || stats.id === this.player.id) {
                            this.player.gamesPlayed = stats.gamesPlayed || 0;
                            this.player.modeStats = stats.modeStats || {};
                            this.player.achievements = stats.achievements || [];
                            this.player.favoriteMode = stats.favoriteMode || null;
                            this.player.correctAnswers = stats.correctAnswers || 0;
                            this.player.incorrectAnswers = stats.incorrectAnswers || 0;
                            this.player.totalTimeBonus = stats.totalTimeBonus || 0;
                        }
                    } catch (e) {
                        console.error("Error al cargar estadísticas:", e);
                    }
                }
            }

            // MÉTODO CORREGIDO: Guardar estadísticas del jugador
            savePlayerStats() {
                try {
                    const statsToSave = {
                        id: this.player.id,
                        gamesPlayed: this.player.gamesPlayed,
                        modeStats: this.player.modeStats,
                        achievements: this.player.achievements,
                        favoriteMode: this.player.favoriteMode,
                        correctAnswers: this.player.correctAnswers,
                        incorrectAnswers: this.player.incorrectAnswers,
                        totalTimeBonus: this.player.totalTimeBonus
                    };
                    localStorage.setItem('playerStats', JSON.stringify(statsToSave));
                } catch (e) {
                    console.error("Error al guardar estadísticas:", e);
                }
            }

            // MÉTODO CORREGIDO: Alternar estadísticas
            toggleStats() {
                if (this.playerStats.style.display === 'block') {
                    this.playerStats.style.display = 'none';
                    return;
                }

                let statsHTML = `
                    <div class="stat-item">
                        <span class="stat-label">Partidas jugadas:</span>
                        <span class="stat-value">${this.player.gamesPlayed}</span>
                    </div>
                `;

                if (this.player.favoriteMode) {
                    statsHTML += `
                        <div class="stat-item">
                            <span class="stat-label">Modo favorito:</span>
                            <span class="stat-value">${this.getModeName(this.player.favoriteMode)}</span>
                        </div>
                    `;
                }

                if (this.player.responseTimes.length > 0) {
                    if (this.player.responseTimes.length > 0) {
                        this.player.avgResponseTime = this.player.responseTimes.reduce((a, b) => a + b, 0) / this.player.responseTimes.length;
                    } else {
                        this.player.avgResponseTime = 0;
                    }

                    statsHTML += `
                        <div class="stat-item">
                            <span class="stat-label">Tiempo promedio:</span>
                            <span class="stat-value">${this.player.avgResponseTime.toFixed(2)}s</span>
                        </div>
                    `;
                }

                if (this.player.maxStreak > 0) {
                    statsHTML += `
                        <div class="stat-item">
                            <span class="stat-label">Racha máxima:</span>
                            <span class="stat-value">${this.player.maxStreak}</span>
                        </div>
                    `;
                }

                if (this.player.achievements.length > 0) {
                    statsHTML += `<h4>Logros:</h4>`;
                    this.player.achievements.forEach(achievement => {
                        statsHTML += `
                            <div class="stat-item">
                                <span class="stat-label">${achievement.title}</span>
                                <span class="achievement-icon">${achievement.icon}</span>
                            </div>
                        `;
                    });
                }

                this.statsContent.innerHTML = statsHTML;
                this.playerStats.style.display = 'block';
            }

            // MÉTODO CORREGIDO: Aplicar efectos de desempeño
            applyPerformanceEffects(playerId, isCorrect, streak) {
                const playerBadge = document.querySelector(`.player-badge-enhanced[data-player-id="${playerId}"]`) ||
                                  document.querySelector(`.ranking-item[data-player-id="${playerId}"]`);
                
                if (!playerBadge) return;
                
                playerBadge.classList.remove('streak-effect', 'fail-effect');
                
                if (isCorrect && streak >= 3) {
                    playerBadge.classList.add('streak-effect');
                } else if (!isCorrect) {
                    playerBadge.classList.add('fail-effect');
                    
                    setTimeout(() => {
                        playerBadge.classList.remove('fail-effect');
                    }, 2000);
                }
            }

            // MÉTODO CORREGIDO: Actualizar fondo según fase
            updatePhaseBackground() {
                document.body.classList.remove('fase-clasificacion', 'fase-semifinal', 'fase-final');
                
                switch(this.currentPhase) {
                    case 'clasificacion':
                        document.body.classList.add('fase-clasificacion');
                        break;
                    case 'semifinal':
                        document.body.classList.add('fase-semifinal');
                        break;
                    case 'final':
                        document.body.classList.add('fase-final');
                        break;
                }
            }

            // MÉTODO CORREGIDO: Actualizar estadísticas detalladas
            updateDetailedStats() {
                const totalAnswers = this.player.correctAnswers + this.player.incorrectAnswers;
                const accuracy = totalAnswers > 0 ? (this.player.correctAnswers / totalAnswers * 100) : 0;
                
                document.getElementById('statCorrect').textContent = this.player.correctAnswers;
                document.getElementById('statIncorrect').textContent = this.player.incorrectAnswers;
                document.getElementById('statAccuracy').textContent = `${accuracy.toFixed(1)}%`;
                document.getElementById('statAccuracyBar').style.width = `${accuracy}%`;
                
                const avgTime = this.player.responseTimes.length > 0 ? 
                    (this.player.responseTimes.reduce((a, b) => a + b, 0) / this.player.responseTimes.length).toFixed(2) : '0';
                document.getElementById('statAvgTime').textContent = `${avgTime}s`;
                
                document.getElementById('statBestStreak').textContent = this.player.maxStreak;
                document.getElementById('statTimeBonus').textContent = this.player.totalTimeBonus;
            }

            // MÉTODO CORREGIDO: Calcular bonificación por tiempo
            calculateTimeBonus(responseTime, maxTime) {
                const timeLeft = maxTime - responseTime;
                const bonus = Math.max(0, Math.floor(timeLeft / maxTime * 20));
                return bonus;
            }

            // MÉTODO CORREGIDO: Alternar estadísticas detalladas
            toggleDetailedStats() {
                if (this.playerStatsDetailed.style.display === 'block') {
                    this.playerStatsDetailed.style.display = 'none';
                } else {
                    this.updateDetailedStats();
                    this.playerStatsDetailed.style.display = 'block';
                }
            }

            // MÉTODO CORREGIDO: Celebrar ganador
            celebrateWinner(winnerElement) {
                winnerElement.classList.add('pulse-win', 'gold-glow');
                const rect = winnerElement.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        this.createExplosion(
                            centerX + (Math.random() - 0.5) * 100,
                            centerY + (Math.random() - 0.5) * 100,
                            '#FFD700',
                            20
                        );
                    }, i * 300);
                }
                
                setTimeout(() => {
                    this.createFirework(centerX, centerY);
                }, 1500);
                
                this.createConfettiRain();
                
                setTimeout(() => {
                    winnerElement.classList.remove('pulse-win');
                }, 2000);
            }

            // MÉTODO CORREGIDO: Crear popup de puntos
            createPointsPopup(points) {
                const scoreElement = document.getElementById('playerScore');
                const rect = scoreElement.getBoundingClientRect();

                const popup = document.createElement('div');
                popup.className = 'points-popup';
                popup.textContent = `+${points}`;
                popup.style.left = `${rect.left + rect.width / 2}px`;
                popup.style.top = `${rect.top}px`;
                
                this.effectsContainer.appendChild(popup);
                
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.parentNode.removeChild(popup);
                    }
                }, 1500);
            }

            // MÉTODO CORREGIDO: Mostrar cuenta regresiva de resultados
            showResultsCountdown(count, callback) {
                this.resultsCountdownOverlay.style.display = 'flex';
                this.resultsCountdownOverlay.textContent = '';

                let currentCount = count;
                const countdownInterval = setInterval(() => {
                    if (currentCount > 0) {
                        this.resultsCountdownOverlay.textContent = currentCount;
                        this.resultsCountdownOverlay.style.animation = 'none';
                        void this.resultsCountdownOverlay.offsetWidth;
                        this.resultsCountdownOverlay.style.animation = 'scaleInAndFade 1s forwards';
                        this.playSound('countdownSound');
                        currentCount--;
                    } else {
                        clearInterval(countdownInterval);
                        this.resultsCountdownOverlay.style.display = 'none';
                        if (callback) callback();
                    }
                }, 1000);
            }

            // MÉTODO CORREGIDO: Mostrar cuenta regresiva de torneo
            showTournamentCountdown(count, callback) {
                const countdownOverlay = document.createElement('div');
                countdownOverlay.className = 'reveal-phase';
                countdownOverlay.style.background = 'rgba(0,0,0,0.9)';
                countdownOverlay.innerHTML = `
                    <div class="tournament-countdown">${count}</div>
                `;
                document.body.appendChild(countdownOverlay);

                let currentCount = count;
                const countdownInterval = setInterval(() => {
                    if (currentCount > 1) {
                        currentCount--;
                        countdownOverlay.innerHTML = `<div class="tournament-countdown">${currentCount}</div>`;
                        this.playSound('countdownSound');
                    } else {
                        clearInterval(countdownInterval);
                        countdownOverlay.remove();
                        if (callback) callback();
                    }
                }, 1000);
            }

            // MÉTODO CORREGIDO: Actualizar indicador de torneo
            updateTournamentIndicator(round) {
                if (round === 'normal') {
                    this.tournamentIndicator.style.display = 'none';
                    return;
                }
                
                this.tournamentIndicator.style.display = 'block';
                
                let roundText = '';
                let badgeText = '';
                
                switch(round) {
                    case 'semifinal':
                        roundText = 'Semifinales';
                        badgeText = 'Semifinal';
                        break;
                    case 'final':
                        roundText = 'Final del Torneo';
                        badgeText = 'Final';
                        break;
                    default:
                        roundText = 'Torneo';
                        badgeText = 'Ronda';
                }
                
                this.tournamentText.textContent = roundText;
                this.roundBadge.textContent = badgeText;
                
                if (this.gameModeIndicator) {
                    let modeText = `Modo: ${this.getModeName(this.selectedGameMode)}`;
                    if (round !== 'normal') {
                        modeText += ` | ${roundText}`;
                    }
                    this.gameModeIndicator.textContent = modeText;
                }
                
                this.highlightFinalists();
            }

            // MÉTODO CORREGIDO: Entrar en modo espectador
            enterSpectatorMode(finalists) {
                console.log("Entrando en modo espectador");
                this.spectatorMode = true;
                this.setState(this.STATES.SPECTATING);
                
                this.updateSpectatorView({ 
                    finalists: finalists, 
                    question: null,
                    message: "Esperando a que comience la ronda..."
                });
                
                const spectatorQuestion = document.getElementById('spectatorQuestion');
                if (this.currentTournamentRound === 'semifinal') {
                    spectatorQuestion.innerHTML = "🏆 <strong>Semifinales en curso</strong> - ¡Anima a los finalistas!";
                } else if (this.currentTournamentRound === 'final') {
                    spectatorQuestion.innerHTML = "👑 <strong>Final del Torneo</strong> - ¡Esto es épico!";
                }
            }

            // MÉTODO CORREGIDO: Actualizar vista del espectador
            updateSpectatorView(data) {
                if (data.finalists) {
                    const rankingList = document.getElementById('spectatorRankingList');
                    rankingList.innerHTML = '';
                    
                    data.finalists.sort((a, b) => (b.points || 0) - (a.points || 0))
                        .forEach((player, index) => {
                            const item = document.createElement('div');
                            item.className = 'ranking-item';
                            
                            if (player.id === this.player.id) {
                                item.classList.add('current-player');
                            }
                            
                            item.innerHTML = `
                                <span class="ranking-position">${index + 1}°</span>
                                <img src="avatar${player.avatar || '1'}.png" class="ranking-avatar" onerror="this.src='avatar1.png'">
                                <span class="ranking-name">${this.extractName(player.name)}</span>
                                <span class="ranking-points">${player.points || 0}</span>
                            `;
                            rankingList.appendChild(item);
                        });
                }
                
                if (data.question) {
                    const spectatorQuestion = document.getElementById('spectatorQuestion');
                    spectatorQuestion.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <strong>Pregunta actual:</strong>
                        </div>
                        <div>${data.question.pregunta}</div>
                    `;
                    
                    if (data.question.imagen) {
                        spectatorQuestion.innerHTML += `
                            <img src="${data.question.imagen}" style="max-width: 100%; max-height: 200px; margin-top: 10px; border-radius: 8px;">
                        `;
                    }
                }
                
                if (data.message) {
                    document.getElementById('spectatorQuestion').innerHTML = data.message;
                }
            }

            // MÉTODO CORREGIDO: Mostrar emoji volador
            showFlyingEmoji(emoji) {
                const container = document.getElementById('emoji-animation-container');
                const emojiElement = document.createElement('div');
                emojiElement.className = 'flying-emoji';
                emojiElement.textContent = emoji;
                emojiElement.style.left = `${Math.random() * 90 + 5}%`;
                
                container.appendChild(emojiElement);

                setTimeout(() => {
                    emojiElement.remove();
                }, 4000);
            }

            // MÉTODO CORREGIDO: Mostrar ganador absoluto
            showUltimateWinner(winner) {
                console.log("Mostrando ganador absoluto:", winner);
                this.setState(this.STATES.ULTIMATE_WINNER);
                this.playSound('winSound');
                
                document.body.style.background = 'radial-gradient(circle, rgba(255,223,0,1) 0%, rgba(255,165,0,1) 100%';
                
                document.getElementById('ultimateWinnerAvatar').src = `imagenes/avatar${winner.avatar || '1'}.png`;
                document.getElementById('ultimateWinnerName').textContent = this.extractName(winner.name);
                
                const winnerInfo = document.querySelector('.winner-info');
                const existingScore = winnerInfo.querySelector('.winner-score');
                if (existingScore) existingScore.remove();
                winnerInfo.innerHTML += `<div class="winner-score" style="margin-top: 10px; font-size: 1.5rem;">Puntuación: ${winner.points || 0} puntos</div>`;
                
                this.createConfettiRain(5000);
            }

            // MÉTODO CORREGIDO: Crear fuegos artificiales
            createFirework(x, y) {
                const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];
                for (let i = 0; i < 60; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'firework';
                    particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 50 + Math.random() * 150;
                    
                    particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                    particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                    
                    this.effectsContainer.appendChild(particle);
                }
                
                this.playSound('countdownSound');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                createParticles();
                const game = new GameManager();
                window.gameInstance = game;
            } catch (error) {
                console.error("Error al iniciar el juego:", error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'notification';
                errorMessage.textContent = "Ocurrió un error al cargar el juego. Por favor recarga la página.";
                document.body.appendChild(errorMessage);
            }
        });
    </script>
</body>
</html>
