<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Challenge PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --azul: #4e8cff;
            --rojo: #ff6b6b;
            --verde: #6bff6b;
            --amarillo: #ffde59;
            --morado: #a459ff;
            --fondo: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --texto: #333;
            --panel: white;
            --borde: #ddd;
            --sombra: rgba(0, 0, 0, 0.1);
            --tiempo-normal: #a459ff;
            --tiempo-alerta: #ff6b6b;
            --neon-azul: 0 0 10px rgba(78, 140, 255, 0.8);
            --neon-morado: 0 0 10px rgba(164, 89, 255, 0.8);
            --neon-verde: 0 0 10px rgba(107, 255, 107, 0.8);
            --neon-rojo: 0 0 10px rgba(255, 107, 107, 0.8);
            --neon-amarillo: 0 0 10px rgba(255, 222, 89, 0.8);
            --equipo-rojo: #ff6b6b;
            --equipo-azul: #4e8cff;
        }

        .dark-mode {
            --fondo: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --texto: #f0f0f0;
            --panel: rgba(30, 41, 59, 0.8);
            --borde: #334155;
            --sombra: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Neue', cursive;
            text-align: center;
            background: var(--fondo);
            color: var(--texto);
            min-height: 100vh;
            transition: all 0.3s ease;
            padding: 20px;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overflow: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        h1, h2, h3 {
            font-family: 'Fredoka One', cursive;
            color: var(--texto);
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Pantalla de inicio personalizada */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--fondo);
            z-index: 3000;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            transition: opacity 0.8s ease-out;
        }

        .welcome-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .welcome-title {
            font-size: 3.5rem;
            background: linear-gradient(45deg, var(--azul), var(--morado));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            text-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Pantalla de carga */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--fondo);
            z-index: 2000;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(78, 140, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--morado);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
            box-shadow: var(--neon-morado);
        }

        .loader-small {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(78, 140, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--morado);
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Pantalla de uni√≥n */
        .join-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--fondo);
            z-index: 1000;
            padding: 20px;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .join-screen.active {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .join-form {
            background: var(--panel);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px var(--sombra);
            width: 100%;
            max-width: 500px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-bottom: 2px solid var(--morado);
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--borde);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Comic Neue', cursive;
            transition: all 0.3s;
            background: rgba(255,255,255,0.1);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--morado);
            box-shadow: var(--neon-morado);
        }

        .avatar-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .avatar-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .avatar-option:hover {
            transform: scale(1.1);
            box-shadow: var(--neon-morado);
        }

        .avatar-option.selected {
            border-color: var(--morado);
            transform: scale(1.1);
            box-shadow: var(--neon-morado);
        }

        .btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Comic Neue', cursive;
            margin: 8px;
            background: linear-gradient(45deg, var(--azul), var(--morado));
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px var(--sombra);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px var(--sombra);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-secondary {
            background: var(--panel);
            border: 2px solid var(--borde);
            color: var(--texto);
        }

        .btn-secondary:hover {
            border-color: var(--morado);
            box-shadow: var(--neon-morado);
        }

        .error-message {
            color: var(--rojo);
            margin-top: 10px;
            font-weight: bold;
            text-shadow: var(--neon-rojo);
        }

        /* Lobby multijugador */
        .multiplayer-lobby {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overflow: hidden;
        }

        #lobby3DCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .lobby-container {
            background: var(--panel);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px var(--sombra);
            width: 100%;
            max-width: 800px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-bottom: 2px solid var(--morado);
            position: relative;
            z-index: 1;
        }

        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .player-badge {
            background: linear-gradient(45deg, var(--azul), var(--morado));
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .player-badge:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px var(--sombra);
        }

        .player-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .vote-section {
            margin: 30px 0;
        }

        .vote-timer {
            font-size: 1.5rem;
            margin: 15px 0;
            font-weight: bold;
            color: var(--morado);
            text-shadow: var(--neon-morado);
        }

        .lobby-countdown-message {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--verde);
            margin-top: 20px;
            opacity: 0;
            transform: scale(0.8) translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            text-shadow: var(--neon-verde);
        }
        .lobby-countdown-message.active {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .mode-btn {
            padding: 15px;
            border: 2px solid var(--borde);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            background: var(--panel);
            position: relative;
            overflow: hidden;
        }

        .mode-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: 0.5s;
        }

        .mode-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px var(--sombra);
        }

        .mode-btn:hover::before {
            left: 100%;
        }

        .mode-btn.selected {
            background: var(--morado);
            color: white;
            border-color: var(--morado);
            box-shadow: var(--neon-morado);
        }

        .mode-btn.voted {
            position: relative;
            overflow: hidden;
        }

        .mode-btn.voted::after {
            content: "‚úì";
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--verde);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: var(--neon-verde);
        }

        .vote-results {
            margin-top: 20px;
            padding: 15px;
            background: var(--panel);
            border-radius: 10px;
            border: 2px solid var(--borde);
            backdrop-filter: blur(5px);
        }

        /* Juego principal */
        #gameContainer {
            display: none;
            max-width: 800px;
            margin: 0 auto;
        }

        .game {
            background: var(--panel);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px var(--sombra);
            margin: 20px 0;
            border: 4px solid var(--amarillo);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-bottom: 2px solid var(--amarillo);
        }

        .question {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid var(--morado);
            background: rgba(255,255,255,0.1);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        .question-image {
            max-width: 100%;
            max-height: 200px;
            margin: 10px auto;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 2px solid var(--morado);
        }

        .input-container {
            margin: 20px 0;
        }

        #playerAnswer {
            padding: 12px;
            font-size: 1.3rem;
            width: 200px;
            text-align: center;
            margin-bottom: 15px;
            border: 2px solid var(--borde);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s;
        }

        #playerAnswer:focus {
            outline: none;
            border-color: var(--morado);
            box-shadow: var(--neon-morado);
        }

        .keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 0 auto;
        }

        .key {
            padding: 15px;
            font-size: 1.3rem;
            cursor: pointer;
            background: var(--panel);
            border: 2px solid var(--borde);
            border-radius: 8px;
            transition: all 0.2s;
            user-select: none;
        }

        .key:hover {
            background: var(--borde);
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .key:active {
            transform: translateY(1px);
        }

        .key.negative {
            grid-column: span 3;
        }

        /* Botones de opci√≥n A/B/C/D */
        .abcd-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px auto;
            max-width: 600px;
        }

        .abcd-btn {
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid var(--borde);
            border-radius: 10px;
            cursor: pointer;
            background: var(--panel);
            color: var(--texto);
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .abcd-btn span.letter {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            background: var(--morado);
            color: white;
            text-align: center;
            font-family: 'Fredoka One', cursive;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .abcd-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px var(--sombra);
            border-color: var(--morado);
        }

        .abcd-btn.selected-answer {
            background: var(--azul);
            color: white;
            border-color: var(--azul);
            box-shadow: var(--neon-azul);
        }

        .result {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 15px 0;
            min-height: 40px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
        }

        .correct {
            color: var(--verde);
            animation: tada 1s ease;
            text-shadow: var(--neon-verde);
        }

        .incorrect {
            color: var(--rojo);
            animation: shake 0.5s ease;
            text-shadow: var(--neon-rojo);
        }

        .waiting {
            color: var(--azul);
            text-shadow: var(--neon-azul);
        }

        @keyframes tada {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Temporizador */
        .timer-container {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            position: relative;
        }

        .timer-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .timer-circle {
            fill: none;
            stroke: var(--tiempo-normal);
            stroke-width: 6;
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 1s linear;
            filter: drop-shadow(0 0 5px var(--morado));
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--tiempo-normal);
            text-shadow: var(--neon-morado);
        }

        .timer-warning {
            stroke: var(--tiempo-alerta);
            color: var(--tiempo-alerta);
            filter: drop-shadow(0 0 5px var(--rojo));
        }

        /* Barra de progreso */
        .progress-container {
            width: 80%;
            height: 10px;
            background: var(--borde);
            border-radius: 5px;
            margin: 20px auto;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--azul), var(--morado));
            transition: width 0.5s ease;
            box-shadow: 0 0 10px var(--morado);
        }

        /* Ranking en vivo */
        .live-ranking {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 250px;
            background: var(--panel);
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--sombra);
            padding: 15px;
            z-index: 50;
            display: none;
            border: 3px solid var(--morado);
            backdrop-filter: blur(5px);
        }

        .live-ranking h3 {
            margin-bottom: 10px;
            color: var(--morado);
            text-align: center;
            text-shadow: var(--neon-morado);
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 8px;
            background: rgba(78, 140, 255, 0.1);
            transition: all 0.5s ease;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .ranking-item.current-player {
            background: rgba(255, 222, 89, 0.2);
            border-left: 4px solid var(--amarillo);
        }

        .ranking-item.move-up {
            animation: moveUp 0.5s ease;
        }

        @keyframes moveUp {
            0% { transform: translateY(0); background: var(--verde); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }

        .ranking-item.move-down {
            animation: moveDown 0.5s ease;
        }

        @keyframes moveDown {
            0% { transform: translateY(0); background: var(--rojo); }
            50% { transform: translateY(10px); }
            100% { transform: translateY(0); }
        }

        .ranking-position {
            font-weight: bold;
            color: var(--morado);
        }

        .ranking-name {
            flex-grow: 1;
            margin: 0 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-points {
            font-weight: bold;
            color: var(--azul);
        }

        .ranking-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* Resultados finales */
        .final-results {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin: 30px 0;
            height: 250px;
            position: relative;
        }

        .podium-place {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
            position: relative;
        }

        .podium-1, .podium-2, .podium-3 {
            width: 100px;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .podium-1 {
            height: 200px;
            background: linear-gradient(to top, #ffd700, #ffec80);
            animation: bounce 1s ease;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        }

        .podium-2 {
            height: 150px;
            background: linear-gradient(to top, #c0c0c0, #e0e0e0);
            animation: bounce 1s 0.2s ease;
            box-shadow: 0 0 15px rgba(192, 192, 192, 0.7);
        }

        .podium-3 {
            height: 100px;
            background: linear-gradient(to top, #cd7f32, #e0a76c);
            animation: bounce 1s 0.4s ease;
            box-shadow: 0 0 10px rgba(205, 127, 50, 0.7);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .podium-name {
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 2;
        }

        .podium-points {
            font-size: 1rem;
            color: var(--texto);
        }

        .podium-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .winner-dancing-emoji {
            font-size: 3rem;
            position: absolute;
            bottom: 210px;
            animation: dance 0.8s infinite alternate;
            z-index: 3;
            pointer-events: none;
        }

        @keyframes dance {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(5deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(-10px) rotate(-5deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        .other-players {
            max-height: 200px;
            overflow-y: auto;
            width: 80%;
            max-width: 500px;
            margin-top: 20px;
            padding: 10px;
            background: var(--panel);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--sombra);
            backdrop-filter: blur(5px);
        }

        .other-player {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
            align-items: center;
        }

        .other-player:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .other-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 3px 10px var(--sombra);
            z-index: 200;
            animation: fadeInOut 3s ease forwards;
            display: flex;
            align-items: center;
            backdrop-filter: blur(5px);
            border: 1px solid var(--morado);
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        /* Estado de conexi√≥n */
        .connection-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            background: var(--panel);
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 100;
            backdrop-filter: blur(5px);
            border: 1px solid var(--borde);
        }

        .connection-status.connected {
            color: var(--verde);
            text-shadow: var(--neon-verde);
        }

        .connection-status.disconnected {
            color: var(--rojo);
            animation: pulse 1.5s infinite;
            text-shadow: var(--neon-rojo);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .connection-status.connecting {
            color: var(--amarillo);
            text-shadow: var(--neon-amarillo);
        }

        /* Bot√≥n tema nocturno */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--panel);
            border: 2px solid var(--borde);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px var(--sombra);
            z-index: 100;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            transform: rotate(30deg);
        }

        /* Bot√≥n saltar pregunta (modo profesor) */
        .skip-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: none;
            backdrop-filter: blur(5px);
        }

        /* Modo rel√°mpago */
        .lightning-mode .timer-container {
            width: 70px;
            height: 70px;
        }

        .lightning-mode .timer-text {
            font-size: 1.5rem;
        }

        .lightning-mode .question {
            font-size: 1.2rem;
            min-height: 60px;
        }

        .lightning-mode .abcd-btn {
            padding: 10px 15px;
            font-size: 1rem;
        }

        /* Modo 1vs1 */
        .versus-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .versus-container {
            display: flex;
            align-items: center;
            gap: 30px;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            text-transform: uppercase;
            animation: zoomIn 0.5s ease;
        }

        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .versus-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .versus-vs {
            font-size: 3rem;
            color: var(--amarillo);
            text-shadow: 0 0 10px var(--amarillo);
            animation: pulse 1s infinite;
        }

        /* Panel de respuestas en vivo */
        .live-answers-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 250px;
            background: var(--panel);
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--sombra);
            padding: 15px;
            z-index: 50;
            display: none;
            border: 3px solid var(--morado);
            backdrop-filter: blur(5px);
        }

        .live-answers-panel h3 {
            margin-bottom: 10px;
            color: var(--morado);
            text-align: center;
            text-shadow: var(--neon-morado);
        }

        .answer-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .answer-correct {
            background: rgba(107, 255, 107, 0.2);
            border-left: 4px solid var(--verde);
        }

        .answer-incorrect {
            background: rgba(255, 107, 107, 0.2);
            border-left: 4px solid var(--rojo);
        }

        .answer-pending {
            background: rgba(255, 222, 89, 0.2);
            border-left: 4px solid var(--amarillo);
        }

        .answer-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* Modo torneo */
        .tournament-bracket {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            overflow-x: auto;
        }

        .tournament-round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            margin: 0 20px;
        }

        .tournament-match {
            background: var(--panel);
            border: 2px solid var(--borde);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            width: 200px;
            box-shadow: 0 2px 5px var(--sombra);
        }

        .tournament-player {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            margin: 3px 0;
            border-radius: 4px;
        }

        .tournament-winner {
            background: rgba(107, 255, 107, 0.2);
            font-weight: bold;
        }

        /* Modo supervivencia */
        .survival-count {
            font-size: 2rem;
            font-weight: bold;
            color: var(--rojo);
            margin: 10px 0;
            text-shadow: var(--neon-rojo);
            animation: pulse 1.5s infinite;
        }

        /* Modo contrarreloj */
        .countdown-clock {
            font-size: 3rem;
            font-weight: bold;
            color: var(--rojo);
            margin: 10px 0;
            text-shadow: var(--neon-rojo);
            animation: pulse 1s infinite;
        }

        /* Modo equipos */
        .team-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .team {
            padding: 15px;
            border-radius: 10px;
            width: 45%;
            text-align: center;
            box-shadow: 0 5px 15px var(--sombra);
        }

        .team-red {
            background: rgba(255, 107, 107, 0.2);
            border: 3px solid var(--rojo);
        }

        .team-blue {
            background: rgba(78, 140, 255, 0.2);
            border: 3px solid var(--azul);
        }

        .team-score {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .team-players {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        /* Historial de partidas */
        .history-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overflow-y: auto;
        }

        .history-container {
            background: var(--panel);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px var(--sombra);
            width: 100%;
            max-width: 800px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-bottom: 2px solid var(--morado);
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .history-item {
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--morado);
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px var(--sombra);
        }

        /* Configuraci√≥n de sala */
        .room-settings {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        .settings-container {
            background: var(--panel);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px var(--sombra);
            width: 100%;
            max-width: 500px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-bottom: 2px solid var(--morado);
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            border-bottom: 1px solid var(--borde);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 2.5rem;
            }

            .welcome-logo {
                font-size: 3.5rem;
            }

            .live-ranking, .live-answers-panel {
                position: static;
                width: 100%;
                margin: 10px 0;
            }

            .podium {
                flex-direction: column;
                align-items: center;
                height: auto;
            }

            .podium-place {
                margin: 10px 0;
            }

            .podium-1, .podium-2, .podium-3 {
                width: 80px;
            }

            .podium-1 {
                height: 150px;
            }

            .podium-2 {
                height: 120px;
            }

            .podium-3 {
                height: 90px;
            }

            .winner-dancing-emoji {
                font-size: 2rem;
                bottom: 160px;
            }

            .theme-toggle {
                top: 10px;
                right: 10px;
            }

            .connection-status {
                bottom: 5px;
                right: 5px;
            }

            .team-container {
                flex-direction: column;
                align-items: center;
            }

            .team {
                width: 90%;
                margin: 10px 0;
            }
        }

        /* Efectos especiales */
        .confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1500;
        }

        .crown {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            animation: bounce 1s infinite;
        }

        .fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1500;
        }

        /* Efecto de parpadeo al acabar tiempo */
        .time-up {
            animation: flash 0.5s 3;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Indicador de respuesta m√°s r√°pida */
        .fastest-answer {
            position: relative;
        }

        .fastest-answer::after {
            content: "‚ö°";
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 1.2rem;
            animation: pulse 1s infinite;
        }

        /* Estad√≠sticas avanzadas */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--panel);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px var(--sombra);
            text-align: center;
            border-left: 4px solid var(--morado);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--morado);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--texto);
            opacity: 0.8;
        }

        /* Panel de errores */
        .errors-panel {
            background: var(--panel);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 3px 10px var(--sombra);
            border-left: 4px solid var(--rojo);
        }

        .error-question {
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 8px;
        }

        .error-players {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .error-player {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255, 107, 107, 0.2);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* Espectadores */
        .spectator-badge {
            background: rgba(128, 128, 128, 0.2);
            color: #666;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        /* Reconexi√≥n autom√°tica */
        .reconnect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 1.5rem;
            flex-direction: column;
        }

        /* Bloqueo de sala */
        .room-locked {
            position: relative;
        }

        .room-locked::after {
            content: "üîí";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }

        /* Animaci√≥n de entrada para elementos */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        .slide-in-left {
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .slide-in-right {
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .zoom-in {
            animation: zoomIn 0.5s ease;
        }

        /* Efectos de part√≠culas */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
    </style>
</head>
<body>
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-logo">üßÆ</div>
        <h1 class="welcome-title">Math Challenge PRO</h1>
        <p>El juego matem√°tico m√°s divertido para todos</p>
        <button class="btn" id="startButton">¬°Comenzar!</button>
    </div>

    <div class="loading-screen" id="loadingScreen" style="display: none;">
        <div class="loader"></div>
        <h2>Cargando juego...</h2>
        <p>Preparando la experiencia matem√°tica m√°s divertida</p>
    </div>

    <div class="join-screen" id="joinScreen">
        <div class="join-form">
            <h2>Unirse a Math Challenge PRO</h2>
            <div class="input-group">
                <label for="playerName">Tu nombre:</label>
                <input type="text" id="playerName" placeholder="Ingresa tu nombre" maxlength="15">
            </div>
            <div class="input-group">
                <label>Elige tu avatar:</label>
                <div class="avatar-selector" id="avatarSelector">
                    </div>
            </div>
            <div class="input-group">
                <label for="gameMode">Modo de juego:</label>
                <select id="gameMode">
                    <option value="solo">Individual</option>
                    <option value="multiplayer">Multijugador</option>
                    <option value="1vs1">1 vs 1 (Duelo r√°pido)</option>
                    <option value="tournament">Torneo</option>
                    <option value="lightning">Rel√°mpago (3 segundos)</option>
                    <option value="teams">Equipos Virtuales</option>
                    <option value="survival">Supervivencia</option>
                    <option value="countdown">Contrarreloj</option>
                </select>
            </div>
            <div class="input-group" id="roomCodeGroup" style="display: none;">
                <label for="roomCode">C√≥digo de sala:</label>
                <input type="text" id="roomCode" placeholder="Ingresa el c√≥digo" maxlength="6">
                <button class="btn btn-secondary" id="generateRoomCode" style="margin-top: 10px; width: 100%;">Generar c√≥digo aleatorio</button>
            </div>
            <div class="input-group" id="roomSettingsGroup" style="display: none;">
                <label for="customRoomCode">Personalizar c√≥digo (opcional):</label>
                <input type="text" id="customRoomCode" placeholder="Ej: MATH01" maxlength="6" pattern="[A-Z0-9]{4,6}">
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <input type="checkbox" id="lockRoom">
                    <label for="lockRoom">Bloquear sala despu√©s de unirse</label>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <input type="checkbox" id="allowSpectators" checked>
                    <label for="allowSpectators">Permitir espectadores</label>
                </div>
            </div>
            <button class="btn" id="joinButton">Unirse al juego</button>
            <div class="error-message" id="joinError" style="display: none;"></div>
        </div>
    </div>

    <div class="multiplayer-lobby" id="multiplayerLobby">
        <canvas id="lobby3DCanvas"></canvas>
        <div class="lobby-container">
            <h2>Sala de espera</h2>
            <div class="connection-status connected" id="lobbyConnectionStatus">
                <span class="loader-small"></span> Conectado a la sala
            </div>
            <div class="room-info">
                <p>C√≥digo de sala: <strong id="displayRoomCode">MATH01</strong></p>
                <p>Jugadores: <span id="playerCount">1</span>/<span id="maxPlayers">8</span></p>
                <button class="btn btn-secondary" id="roomSettingsBtn">Configuraci√≥n de sala</button>
                <button class="btn btn-secondary" id="invitePlayersBtn">Invitar jugadores</button>
            </div>
            <div class="player-list" id="playerList">
                </div>
            <div class="mode-selection" id="modeSelection">
                <h3>Selecciona el modo de juego:</h3>
                <div class="mode-buttons">
                    <div class="mode-btn" data-mode="classic">Cl√°sico</div>
                    <div class="mode-btn" data-mode="1vs1">1 vs 1</div>
                    <div class="mode-btn" data-mode="tournament">Torneo</div>
                    <div class="mode-btn" data-mode="lightning">Rel√°mpago</div>
                    <div class="mode-btn" data-mode="teams">Equipos</div>
                    <div class="mode-btn" data-mode="survival">Supervivencia</div>
                    <div class="mode-btn" data-mode="countdown">Contrarreloj</div>
                </div>
                <div class="vote-section" id="voteSection" style="display: none;">
                    <h3>Votaci√≥n en curso...</h3>
                    <div class="vote-timer" id="voteTimer">10</div>
                    <p>Esperando a que los dem√°s voten...</p>
                </div>
                <div class="vote-results" id="voteResults" style="display: none;">
                    <h3>Resultados de la votaci√≥n</h3>
                    <div id="voteResultsList"></div>
                </div>
            </div>
            <div class="lobby-controls">
                <button class="btn" id="startGameBtn" disabled>Iniciar juego</button>
                <button class="btn btn-secondary" id="leaveLobbyBtn">Salir de la sala</button>
            </div>
            <div class="lobby-countdown-message" id="lobbyCountdown"></div>
        </div>
    </div>

    <div id="gameContainer">
        <div class="theme-toggle" id="themeToggle">
            üåô
        </div>

        <div class="connection-status connected" id="connectionStatus">
            <span class="loader-small"></span> Conectado
        </div>

        <div class="live-ranking" id="liveRanking">
            <h3>Ranking en Vivo</h3>
            <div id="rankingList">
                </div>
        </div>

        <div class="live-answers-panel" id="liveAnswersPanel">
            <h3>Respuestas</h3>
            <div id="answersList">
                </div>
        </div>

        <div class="game-info">
            <h1>Math Challenge PRO</h1>
            <div id="gameModeIndicator"></div>
            <div id="roundInfo"></div>
            <div id="teamInfo" style="display: none;"></div>
            <div class="survival-count" id="survivalCount" style="display: none;">Jugadores restantes: <span id="playersLeft">0</span></div>
            <div class="countdown-clock" id="countdownClock" style="display: none;">60</div>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="game">
            <div class="question" id="question">
                </div>
            <div id="questionImageContainer" style="display: none;">
                <img class="question-image" id="questionImage" src="" alt="Imagen de la pregunta">
            </div>

            <div class="abcd-buttons" id="abcdButtons" style="display: none;">
                </div>

            <div class="input-container" id="numericInput" style="display: none;">
                <input type="number" id="playerAnswer" placeholder="Tu respuesta">
                <div class="keyboard">
                    <div class="key" data-key="1">1</div>
                    <div class="key" data-key="2">2</div>
                    <div class="key" data-key="3">3</div>
                    <div class="key" data-key="4">4</div>
                    <div class="key" data-key="5">5</div>
                    <div class="key" data-key="6">6</div>
                    <div class="key" data-key="7">7</div>
                    <div class="key" data-key="8">8</div>
                    <div class="key" data-key="9">9</div>
                    <div class="key" data-key="0">0</div>
                    <div class="key" data-key="-">-</div>
                    <div class="key negative" data-key="clear">Borrar</div>
                </div>
                <button class="btn" id="submitAnswer">Enviar respuesta</button>
            </div>

            <div class="result" id="result">
                </div>

            <div class="timer-container">
                <svg class="timer-svg" viewBox="0 0 100 100">
                    <circle class="timer-circle" cx="50" cy="50" r="45"></circle>
                </svg>
                <div class="timer-text" id="timer">10</div>
            </div>
        </div>

        <button class="btn skip-btn" id="skipQuestion" style="display: none;">Saltar pregunta</button>

        <div class="tournament-bracket" id="tournamentBracket" style="display: none;">
            </div>

        <div class="team-container" id="teamContainer" style="display: none;">
            </div>
    </div>

    <div class="final-results" id="finalResults">
        <h2>¬°Partida Terminada!</h2>
        
        <div class="podium" id="podium">
            </div>

        <div class="other-players" id="otherPlayers">
            </div>

        <div class="stats-container" id="advancedStats">
            </div>

        <div class="errors-panel" id="errorsPanel" style="display: none;">
            <h3>Preguntas m√°s dif√≠ciles</h3>
            </div>

        <div class="game-actions">
            <button class="btn" id="playAgainBtn">Jugar otra vez</button>
            <button class="btn btn-secondary" id="viewHistoryBtn">Ver historial</button>
            <button class="btn btn-secondary" id="mainMenuBtn">Men√∫ principal</button>
        </div>
    </div>

    <div class="history-screen" id="historyScreen">
        <div class="history-container">
            <h2>Historial de Partidas</h2>
            <div class="history-list" id="historyList">
                </div>
            <button class="btn" id="backFromHistoryBtn">Volver</button>
        </div>
    </div>

    <div class="room-settings" id="roomSettings">
        <div class="settings-container">
            <h2>Configuraci√≥n de Sala</h2>
            <div class="settings-row">
                <span>C√≥digo de sala:</span>
                <span id="currentRoomCode">MATH01</span>
            </div>
            <div class="settings-row">
                <span>Jugadores conectados:</span>
                <span id="connectedPlayersCount">1/8</span>
            </div>
            <div class="settings-row">
                <span>Estado de la sala:</span>
                <span id="roomState">Abierta</span>
            </div>
            <div class="settings-row">
                <span>Permitir espectadores:</span>
                <input type="checkbox" id="toggleSpectators" checked>
            </div>
            <div class="settings-row">
                <button class="btn btn-secondary" id="lockRoomBtn">üîí Bloquear sala</button>
                <button class="btn btn-secondary" id="kickAllBtn">Expulsar a todos</button>
            </div>
            <div class="settings-row">
                <button class="btn" id="closeSettingsBtn">Cerrar configuraci√≥n</button>
            </div>
        </div>
    </div>

    <div id="notificationArea"></div>

    <canvas class="confetti-canvas" id="confettiCanvas"></canvas>
    <div class="fireworks" id="fireworksContainer"></div>

    <div class="versus-animation" id="versusAnimation" style="display: none;">
        <div class="versus-container">
            <div class="versus-player" id="versusPlayer1">
                <div class="player-avatar" id="versusAvatar1"></div>
                <div class="player-name" id="versusName1">Jugador 1</div>
            </div>
            <div class="versus-vs">VS</div>
            <div class="versus-player" id="versusPlayer2">
                <div class="player-avatar" id="versusAvatar2"></div>
                <div class="player-name" id="versusName2">Jugador 2</div>
            </div>
        </div>
    </div>

    <div class="reconnect-overlay" id="reconnectOverlay" style="display: none;">
        <div class="loader"></div>
        <p>Reconectando...</p>
        <p>No cierres esta p√°gina</p>
    </div>

    <div class="particles" id="particlesContainer"></div>

    <script>
        // =============================================
        // CONFIGURACI√ìN INICIAL Y VARIABLES GLOBALES
        // =============================================

        // Configuraci√≥n del juego
        const gameConfig = {
            totalQuestions: 10,
            questionTime: 10, // segundos
            lightningTime: 3, // segundos para modo rel√°mpago
            countdownTime: 60, // segundos para modo contrarreloj
            maxPlayers: 8,
            avatars: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ'],
            colors: ['#4e8cff', '#ff6b6b', '#6bff6b', '#ffde59', '#a459ff', '#ff59b3', '#59ffb3', '#b359ff']
        };

        // Estado del juego
        let gameState = {
            currentScreen: 'welcome',
            player: {
                id: null,
                name: '',
                avatar: '',
                color: '',
                isHost: false,
                isSpectator: false
            },
            room: {
                code: '',
                players: [],
                maxPlayers: gameConfig.maxPlayers,
                isLocked: false,
                allowSpectators: true,
                mode: 'classic',
                votedModes: {}
            },
            game: {
                currentQuestion: 0,
                questions: [],
                timer: null,
                timeLeft: gameConfig.questionTime,
                isAnswered: false,
                startTime: null,
                results: [],
                tournament: {
                    rounds: [],
                    currentRound: 0,
                    matches: []
                },
                teams: {
                    red: [],
                    blue: [],
                    scores: { red: 0, blue: 0 }
                },
                survival: {
                    playersLeft: 0,
                    eliminated: []
                },
                countdown: {
                    timeLeft: gameConfig.countdownTime,
                    interval: null
                }
            },
            history: JSON.parse(localStorage.getItem('mathChallengeHistory')) || [],
            settings: {
                darkMode: localStorage.getItem('darkMode') === 'true',
                soundEnabled: true,
                animationsEnabled: true
            }
        };

        // Elementos DOM
        const elements = {
            // Pantallas
            welcomeScreen: document.getElementById('welcomeScreen'),
            loadingScreen: document.getElementById('loadingScreen'),
            joinScreen: document.getElementById('joinScreen'),
            multiplayerLobby: document.getElementById('multiplayerLobby'),
            gameContainer: document.getElementById('gameContainer'),
            finalResults: document.getElementById('finalResults'),
            historyScreen: document.getElementById('historyScreen'),
            roomSettings: document.getElementById('roomSettings'),

            // ========== INICIO DE LA CORRECCI√ìN ==========
            // El bot√≥n 'startButton' no estaba definido aqu√≠, lo que causaba el error.
            startButton: document.getElementById('startButton'),
            // ========== FIN DE LA CORRECCI√ìN ==========
            
            // Elementos de la pantalla de uni√≥n
            playerName: document.getElementById('playerName'),
            avatarSelector: document.getElementById('avatarSelector'),
            gameMode: document.getElementById('gameMode'),
            roomCodeGroup: document.getElementById('roomCodeGroup'),
            roomCode: document.getElementById('roomCode'),
            generateRoomCode: document.getElementById('generateRoomCode'),
            roomSettingsGroup: document.getElementById('roomSettingsGroup'),
            customRoomCode: document.getElementById('customRoomCode'),
            lockRoom: document.getElementById('lockRoom'),
            allowSpectators: document.getElementById('allowSpectators'),
            joinButton: document.getElementById('joinButton'),
            joinError: document.getElementById('joinError'),
            
            // Elementos del lobby
            lobby3DCanvas: document.getElementById('lobby3DCanvas'),
            displayRoomCode: document.getElementById('displayRoomCode'),
            playerCount: document.getElementById('playerCount'),
            maxPlayers: document.getElementById('maxPlayers'),
            playerList: document.getElementById('playerList'),
            modeSelection: document.getElementById('modeSelection'),
            voteSection: document.getElementById('voteSection'),
            voteTimer: document.getElementById('voteTimer'),
            voteResults: document.getElementById('voteResults'),
            voteResultsList: document.getElementById('voteResultsList'),
            startGameBtn: document.getElementById('startGameBtn'),
            leaveLobbyBtn: document.getElementById('leaveLobbyBtn'),
            lobbyCountdown: document.getElementById('lobbyCountdown'),
            lobbyConnectionStatus: document.getElementById('lobbyConnectionStatus'),
            roomSettingsBtn: document.getElementById('roomSettingsBtn'),
            invitePlayersBtn: document.getElementById('invitePlayersBtn'),
            
            // Elementos del juego
            themeToggle: document.getElementById('themeToggle'),
            connectionStatus: document.getElementById('connectionStatus'),
            liveRanking: document.getElementById('liveRanking'),
            rankingList: document.getElementById('rankingList'),
            liveAnswersPanel: document.getElementById('liveAnswersPanel'),
            answersList: document.getElementById('answersList'),
            gameModeIndicator: document.getElementById('gameModeIndicator'),
            roundInfo: document.getElementById('roundInfo'),
            teamInfo: document.getElementById('teamInfo'),
            survivalCount: document.getElementById('survivalCount'),
            playersLeft: document.getElementById('playersLeft'),
            countdownClock: document.getElementById('countdownClock'),
            progressBar: document.getElementById('progressBar'),
            question: document.getElementById('question'),
            questionImageContainer: document.getElementById('questionImageContainer'),
            questionImage: document.getElementById('questionImage'),
            abcdButtons: document.getElementById('abcdButtons'),
            numericInput: document.getElementById('numericInput'),
            playerAnswer: document.getElementById('playerAnswer'),
            submitAnswer: document.getElementById('submitAnswer'),
            result: document.getElementById('result'),
            timer: document.getElementById('timer'),
            skipQuestion: document.getElementById('skipQuestion'),
            tournamentBracket: document.getElementById('tournamentBracket'),
            teamContainer: document.getElementById('teamContainer'),
            
            // Elementos de resultados finales
            podium: document.getElementById('podium'),
            otherPlayers: document.getElementById('otherPlayers'),
            advancedStats: document.getElementById('advancedStats'),
            errorsPanel: document.getElementById('errorsPanel'),
            playAgainBtn: document.getElementById('playAgainBtn'),
            viewHistoryBtn: document.getElementById('viewHistoryBtn'),
            mainMenuBtn: document.getElementById('mainMenuBtn'),
            
            // Elementos del historial
            historyList: document.getElementById('historyList'),
            backFromHistoryBtn: document.getElementById('backFromHistoryBtn'),
            
            // Elementos de configuraci√≥n de sala
            currentRoomCode: document.getElementById('currentRoomCode'),
            connectedPlayersCount: document.getElementById('connectedPlayersCount'),
            roomState: document.getElementById('roomState'),
            toggleSpectators: document.getElementById('toggleSpectators'),
            lockRoomBtn: document.getElementById('lockRoomBtn'),
            kickAllBtn: document.getElementById('kickAllBtn'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            
            // Efectos especiales
            confettiCanvas: document.getElementById('confettiCanvas'),
            fireworksContainer: document.getElementById('fireworksContainer'),
            versusAnimation: document.getElementById('versusAnimation'),
            versusPlayer1: document.getElementById('versusPlayer1'),
            versusAvatar1: document.getElementById('versusAvatar1'),
            versusName1: document.getElementById('versusName1'),
            versusPlayer2: document.getElementById('versusPlayer2'),
            versusAvatar2: document.getElementById('versusAvatar2'),
            versusName2: document.getElementById('versusName2'),
            reconnectOverlay: document.getElementById('reconnectOverlay'),
            particlesContainer: document.getElementById('particlesContainer'),
            notificationArea: document.getElementById('notificationArea')
        };

        // =============================================
        // INICIALIZACI√ìN DEL JUEGO
        // =============================================

        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
        });

        function initializeGame() {
            // Aplicar tema guardado
            applyTheme();
            
            // Inicializar avatares
            initializeAvatars();
            
            // Configurar event listeners
            setupEventListeners();
            
            // Inicializar efectos de part√≠culas
            initializeParticles();
            
            // Mostrar pantalla de bienvenida
            showScreen('welcome');
        }

        function applyTheme() {
            if (gameState.settings.darkMode) {
                document.body.classList.add('dark-mode');
                elements.themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                elements.themeToggle.textContent = 'üåô';
            }
        }

        function initializeAvatars() {
            elements.avatarSelector.innerHTML = '';
            gameConfig.avatars.forEach(avatar => {
                const avatarElement = document.createElement('div');
                avatarElement.className = 'avatar-option';
                avatarElement.textContent = avatar;
                avatarElement.addEventListener('click', () => selectAvatar(avatar));
                elements.avatarSelector.appendChild(avatarElement);
            });
            
            // Seleccionar un avatar por defecto aleatorio
            const randomAvatar = gameConfig.avatars[Math.floor(Math.random() * gameConfig.avatars.length)];
            selectAvatar(randomAvatar);
        }

        function selectAvatar(avatar) {
            // Quitar selecci√≥n anterior
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Seleccionar nuevo avatar
            document.querySelectorAll('.avatar-option').forEach(el => {
                if (el.textContent === avatar) {
                    el.classList.add('selected');
                    gameState.player.avatar = avatar;
                }
            });
        }

        function setupEventListeners() {
            // Bot√≥n de inicio
            elements.startButton.addEventListener('click', startGame);
            
            // Pantalla de uni√≥n
            elements.gameMode.addEventListener('change', toggleRoomCodeVisibility);
            elements.generateRoomCode.addEventListener('click', generateRoomCode);
            elements.joinButton.addEventListener('click', joinGame);
            
            // Lobby multijugador
            elements.startGameBtn.addEventListener('click', startMultiplayerGame);
            elements.leaveLobbyBtn.addEventListener('click', leaveLobby);
            elements.roomSettingsBtn.addEventListener('click', showRoomSettings);
            elements.invitePlayersBtn.addEventListener('click', invitePlayers);
            
            // Modos de juego en el lobby
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (gameState.player.isHost) {
                        selectGameMode(this.dataset.mode);
                    } else {
                        voteForGameMode(this.dataset.mode);
                    }
                });
            });
            
            // Teclado virtual
            document.querySelectorAll('.key').forEach(key => {
                key.addEventListener('click', function() {
                    handleKeyPress(this.dataset.key);
                });
            });
            
            // Env√≠o de respuesta
            elements.submitAnswer.addEventListener('click', submitAnswer);
            elements.playerAnswer.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitAnswer();
                }
            });
            
            // Bot√≥n saltar pregunta
            elements.skipQuestion.addEventListener('click', skipQuestion);
            
            // Tema nocturno
            elements.themeToggle.addEventListener('click', toggleDarkMode);
            
            // Resultados finales
            elements.playAgainBtn.addEventListener('click', playAgain);
            elements.viewHistoryBtn.addEventListener('click', showHistory);
            elements.mainMenuBtn.addEventListener('click', goToMainMenu);
            
            // Historial
            elements.backFromHistoryBtn.addEventListener('click', hideHistory);
            
            // Configuraci√≥n de sala
            elements.closeSettingsBtn.addEventListener('click', hideRoomSettings);
            elements.lockRoomBtn.addEventListener('click', toggleRoomLock);
            elements.kickAllBtn.addEventListener('click', kickAllPlayers);
            elements.toggleSpectators.addEventListener('change', toggleSpectators);
        }

        // =============================================
        // GESTI√ìN DE PANTALLAS
        // =============================================

        function showScreen(screenName) {
            // Ocultar todas las pantallas
            elements.welcomeScreen.style.display = 'none';
            elements.loadingScreen.style.display = 'none';
            elements.joinScreen.style.display = 'none';
            elements.multiplayerLobby.style.display = 'none';
            elements.gameContainer.style.display = 'none';
            elements.finalResults.style.display = 'none';
            elements.historyScreen.style.display = 'none';
            elements.roomSettings.style.display = 'none';
            
            // Mostrar la pantalla solicitada
            switch(screenName) {
                case 'welcome':
                    elements.welcomeScreen.style.display = 'flex';
                    break;
                case 'loading':
                    elements.loadingScreen.style.display = 'flex';
                    break;
                case 'join':
                    elements.joinScreen.classList.add('active');
                    elements.joinScreen.style.display = 'flex';
                    break;
                case 'lobby':
                    elements.multiplayerLobby.style.display = 'flex';
                    initializeLobby3D();
                    break;
                case 'game':
                    elements.gameContainer.style.display = 'block';
                    break;
                case 'results':
                    elements.finalResults.style.display = 'flex';
                    showFinalResults();
                    break;
                case 'history':
                    elements.historyScreen.style.display = 'flex';
                    showGameHistory();
                    break;
                case 'roomSettings':
                    elements.roomSettings.style.display = 'flex';
                    updateRoomSettings();
                    break;
            }
            
            gameState.currentScreen = screenName;
        }

        // =============================================
        // FLUJO PRINCIPAL DEL JUEGO
        // =============================================

        function startGame() {
            showScreen('loading');
            
            // Simular carga de recursos
            setTimeout(() => {
                showScreen('join');
                toggleRoomCodeVisibility();
            }, 2000);
        }

        function toggleRoomCodeVisibility() {
            const mode = elements.gameMode.value;
            
            if (mode === 'multiplayer' || mode === '1vs1' || mode === 'tournament' || 
                mode === 'lightning' || mode === 'teams' || mode === 'survival' || mode === 'countdown') {
                elements.roomCodeGroup.style.display = 'block';
                elements.roomSettingsGroup.style.display = 'block';
                
                // Si es anfitri√≥n, mostrar opciones de configuraci√≥n
                if (mode !== 'multiplayer') {
                    gameState.player.isHost = true;
                }
                
                generateRoomCode();
            } else {
                elements.roomCodeGroup.style.display = 'none';
                elements.roomSettingsGroup.style.display = 'none';
                gameState.player.isHost = false;
            }
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            elements.roomCode.value = code;
            elements.customRoomCode.value = code;
        }

        function joinGame() {
            const playerName = elements.playerName.value.trim();
            const gameMode = elements.gameMode.value;
            
            if (!playerName) {
                showError(elements.joinError, 'Por favor, ingresa tu nombre');
                return;
            }
            
            if (playerName.length < 2) {
                showError(elements.joinError, 'El nombre debe tener al menos 2 caracteres');
                return;
            }
            
            // Guardar informaci√≥n del jugador
            gameState.player.name = playerName;
            gameState.player.id = generatePlayerId();
            gameState.player.color = gameConfig.colors[Math.floor(Math.random() * gameConfig.colors.length)];
            
            // Asignar modo de juego
            gameState.room.mode = gameMode;
            
            if (gameMode === 'solo') {
                // Modo individual
                startSoloGame();
            } else {
                // Modo multijugador
                const roomCode = elements.roomCode.value.toUpperCase();
                
                if (!roomCode) {
                    showError(elements.joinError, 'Por favor, ingresa un c√≥digo de sala');
                    return;
                }
                
                gameState.room.code = roomCode;
                
                // Configurar sala
                if (gameState.player.isHost) {
                    const customCode = elements.customRoomCode.value.toUpperCase();
                    if (customCode && customCode.length >= 4) {
                        gameState.room.code = customCode;
                    }
                    
                    gameState.room.isLocked = elements.lockRoom.checked;
                    gameState.room.allowSpectators = elements.allowSpectators.checked;
                    
                    // A√±adir al jugador anfitri√≥n a la sala
                    gameState.room.players = [gameState.player];
                }
                
                // Unirse a la sala (simulaci√≥n)
                joinMultiplayerRoom();
            }
        }

        function generatePlayerId() {
            return 'player_' + Math.random().toString(36).substr(2, 9);
        }

        function startSoloGame() {
            showScreen('game');
            initializeGameSession();
            loadQuestion();
        }

        function joinMultiplayerRoom() {
            showScreen('lobby');
            updateLobbyUI();
            
            // Simular conexi√≥n a sala multijugador
            simulateMultiplayerConnection();
        }

        function simulateMultiplayerConnection() {
            // Simular otros jugadores uni√©ndose (solo para demostraci√≥n)
            if (gameState.player.isHost) {
                setTimeout(() => {
                    addDemoPlayers();
                }, 1000);
            }
        }

        function addDemoPlayers() {
            const demoPlayers = [
                { name: 'Ana', avatar: 'üê±', color: '#ff6b6b' },
                { name: 'Carlos', avatar: 'üê∂', color: '#6bff6b' },
                { name: 'Mar√≠a', avatar: 'üê∞', color: '#ffde59' },
                { name: 'Luis', avatar: 'üêª', color: '#a459ff' }
            ];
            
            demoPlayers.forEach((demo, index) => {
                setTimeout(() => {
                    const player = {
                        id: 'demo_' + index,
                        name: demo.name,
                        avatar: demo.avatar,
                        color: demo.color,
                        isHost: false,
                        isSpectator: false
                    };
                    
                    gameState.room.players.push(player);
                    updateLobbyUI();
                    
                    // Notificaci√≥n de nuevo jugador
                    showNotification(`${demo.name} se ha unido a la sala`, 'info');
                }, (index + 1) * 1000);
            });
        }

        function updateLobbyUI() {
            // Actualizar informaci√≥n de la sala
            elements.displayRoomCode.textContent = gameState.room.code;
            elements.playerCount.textContent = gameState.room.players.length;
            elements.maxPlayers.textContent = gameState.room.maxPlayers;
            
            // Actualizar lista de jugadores
            elements.playerList.innerHTML = '';
            gameState.room.players.forEach(player => {
                const playerBadge = document.createElement('div');
                playerBadge.className = 'player-badge';
                playerBadge.style.background = `linear-gradient(45deg, ${player.color}, ${adjustColor(player.color, 20)})`;
                playerBadge.innerHTML = `
                    <span class="player-avatar">${player.avatar}</span>
                    <span class="player-name">${player.name}</span>
                    ${player.isHost ? '<span title="Anfitri√≥n">üëë</span>' : ''}
                    ${player.isSpectator ? '<span class="spectator-badge">Espectador</span>' : ''}
                `;
                elements.playerList.appendChild(playerBadge);
            });
            
            // Habilitar bot√≥n de inicio si hay al menos 2 jugadores y es anfitri√≥n
            elements.startGameBtn.disabled = !(gameState.player.isHost && gameState.room.players.length >= 2);
            
            // Actualizar estado de conexi√≥n
            updateConnectionStatus();
        }

        function adjustColor(color, amount) {
            // Simplificaci√≥n para ajustar color (en una implementaci√≥n real usar√≠a una librer√≠a de color)
            return color;
        }

        function selectGameMode(mode) {
            // Seleccionar modo de juego (anfitri√≥n)
            gameState.room.mode = mode;
            
            // Resaltar modo seleccionado
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('selected');
                }
            });
            
            // Notificar a los jugadores
            showNotification(`Modo de juego cambiado a: ${getModeDisplayName(mode)}`, 'success');
        }

        function voteForGameMode(mode) {
            // Votar por un modo de juego (jugador no anfitri√≥n)
            if (!gameState.room.votedModes[gameState.player.id]) {
                gameState.room.votedModes[gameState.player.id] = mode;
                
                // Resaltar voto
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('voted');
                    if (btn.dataset.mode === mode) {
                        btn.classList.add('voted');
                    }
                });
                
                showNotification(`Has votado por: ${getModeDisplayName(mode)}`, 'info');
                
                // Simular votaci√≥n de otros jugadores
                simulateOtherVotes(mode);
            }
        }

        function simulateOtherVotes(mode) {
            // Simular votos de otros jugadores (solo para demostraci√≥n)
            if (gameState.room.players.length > 1) {
                setTimeout(() => {
                    const otherPlayers = gameState.room.players.filter(p => p.id !== gameState.player.id);
                    otherPlayers.forEach((player, index) => {
                        setTimeout(() => {
                            const voteMode = ['classic', '1vs1', 'tournament', 'lightning', 'teams', 'survival', 'countdown'][
                                Math.floor(Math.random() * 7)
                            ];
                            gameState.room.votedModes[player.id] = voteMode;
                            
                            // Actualizar UI de votaci√≥n
                            updateVoteResults();
                        }, (index + 1) * 500);
                    });
                }, 1000);
            }
        }

        function updateVoteResults() {
            // Contar votos
            const voteCounts = {};
            Object.values(gameState.room.votedModes).forEach(mode => {
                voteCounts[mode] = (voteCounts[mode] || 0) + 1;
            });
            
            // Mostrar resultados
            elements.voteResultsList.innerHTML = '';
            for (const mode in voteCounts) {
                const count = voteCounts[mode];
                const resultItem = document.createElement('div');
                resultItem.className = 'vote-result-item';
                resultItem.innerHTML = `
                    <span>${getModeDisplayName(mode)}:</span>
                    <span>${count} voto(s)</span>
                `;
                elements.voteResultsList.appendChild(resultItem);
            }
            
            // Mostrar secci√≥n de resultados si hay votos
            if (Object.keys(voteCounts).length > 0) {
                elements.voteResults.style.display = 'block';
            }
        }

        function getModeDisplayName(mode) {
            const modeNames = {
                'classic': 'Cl√°sico',
                '1vs1': '1 vs 1',
                'tournament': 'Torneo',
                'lightning': 'Rel√°mpago',
                'teams': 'Equipos',
                'survival': 'Supervivencia',
                'countdown': 'Contrarreloj'
            };
            return modeNames[mode] || mode;
        }

        function startMultiplayerGame() {
            if (gameState.player.isHost && gameState.room.players.length >= 2) {
                // Iniciar cuenta regresiva en el lobby
                startLobbyCountdown();
            }
        }

        function startLobbyCountdown() {
            let countdown = 5;
            elements.lobbyCountdown.textContent = `El juego comenzar√° en ${countdown}...`;
            elements.lobbyCountdown.classList.add('active');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                elements.lobbyCountdown.textContent = `El juego comenzar√° en ${countdown}...`;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    elements.lobbyCountdown.classList.remove('active');
                    
                    // Iniciar el juego
                    initializeGameSession();
                    showScreen('game');
                    loadQuestion();
                }
            }, 1000);
        }

        function leaveLobby() {
            if (confirm('¬øEst√°s seguro de que quieres salir de la sala?')) {
                // Volver a la pantalla de uni√≥n
                showScreen('join');
            }
        }

        function showRoomSettings() {
            if (gameState.player.isHost) {
                showScreen('roomSettings');
            }
        }

        function hideRoomSettings() {
            showScreen('lobby');
        }

        function updateRoomSettings() {
            elements.currentRoomCode.textContent = gameState.room.code;
            elements.connectedPlayersCount.textContent = `${gameState.room.players.length}/${gameState.room.maxPlayers}`;
            elements.roomState.textContent = gameState.room.isLocked ? 'Bloqueada' : 'Abierta';
            elements.toggleSpectators.checked = gameState.room.allowSpectators;
            elements.lockRoomBtn.textContent = gameState.room.isLocked ? 'üîì Desbloquear sala' : 'üîí Bloquear sala';
        }

        function toggleRoomLock() {
            gameState.room.isLocked = !gameState.room.isLocked;
            updateRoomSettings();
            showNotification(`Sala ${gameState.room.isLocked ? 'bloqueada' : 'desbloqueada'}`, 'info');
        }

        function toggleSpectators() {
            gameState.room.allowSpectators = elements.toggleSpectators.checked;
            showNotification(`Espectadores ${gameState.room.allowSpectators ? 'permitidos' : 'no permitidos'}`, 'info');
        }

        function kickAllPlayers() {
            if (confirm('¬øEst√°s seguro de que quieres expulsar a todos los jugadores?')) {
                // Mantener solo al anfitri√≥n
                gameState.room.players = [gameState.player];
                updateRoomSettings();
                showNotification('Todos los jugadores han sido expulsados', 'warning');
            }
        }

        function invitePlayers() {
            // Simular funcionalidad de invitaci√≥n
            const inviteText = `¬°√önete a mi partida de Math Challenge PRO! C√≥digo de sala: ${gameState.room.code}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Math Challenge PRO',
                    text: inviteText,
                    url: window.location.href
                });
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(inviteText).then(() => {
                    showNotification('Enlace de invitaci√≥n copiado al portapapeles', 'success');
                });
            } else {
                // Fallback: mostrar el c√≥digo para que lo copien manualmente
                alert(`Comparte este c√≥digo con tus amigos: ${gameState.room.code}`);
            }
        }

        // =============================================
        // L√ìGICA PRINCIPAL DEL JUEGO
        // =============================================

        function initializeGameSession() {
            // Reiniciar estado del juego
            gameState.game.currentQuestion = 0;
            gameState.game.questions = [];
            gameState.game.timeLeft = getQuestionTime();
            gameState.game.isAnswered = false;
            gameState.game.results = [];
            gameState.game.startTime = Date.now();
            
            // Generar preguntas
            generateQuestions();
            
            // Configurar UI seg√∫n el modo de juego
            setupGameUI();
            
            // Mostrar ranking en vivo si es multijugador
            if (gameState.room.mode !== 'solo') {
                elements.liveRanking.style.display = 'block';
                elements.liveAnswersPanel.style.display = 'block';
                updateLiveRanking();
            }
            
            // Mostrar informaci√≥n del modo de juego
            updateGameModeIndicator();
        }

        function getQuestionTime() {
            switch (gameState.room.mode) {
                case 'lightning': return gameConfig.lightningTime;
                case 'countdown': return gameConfig.countdownTime;
                default: return gameConfig.questionTime;
            }
        }

        function generateQuestions() {
            // Generar preguntas matem√°ticas aleatorias
            for (let i = 0; i < gameConfig.totalQuestions; i++) {
                const question = generateMathQuestion();
                gameState.game.questions.push(question);
            }
        }

        function generateMathQuestion() {
            const types = ['addition', 'subtraction', 'multiplication', 'division'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let num1, num2, question, answer, options;
            
            switch (type) {
                case 'addition':
                    num1 = Math.floor(Math.random() * 50) + 1;
                    num2 = Math.floor(Math.random() * 50) + 1;
                    question = `${num1} + ${num2} = ?`;
                    answer = num1 + num2;
                    break;
                    
                case 'subtraction':
                    num1 = Math.floor(Math.random() * 50) + 20;
                    num2 = Math.floor(Math.random() * 20) + 1;
                    question = `${num1} - ${num2} = ?`;
                    answer = num1 - num2;
                    break;
                    
                case 'multiplication':
                    num1 = Math.floor(Math.random() * 10) + 1;
                    num2 = Math.floor(Math.random() * 10) + 1;
                    question = `${num1} √ó ${num2} = ?`;
                    answer = num1 * num2;
                    break;
                    
                case 'division':
                    num2 = Math.floor(Math.random() * 10) + 1;
                    answer = Math.floor(Math.random() * 10) + 1;
                    num1 = num2 * answer;
                    question = `${num1} √∑ ${num2} = ?`;
                    break;
            }
            
            // Generar opciones incorrectas
            options = generateOptions(answer, 4);
            
            return {
                question: question,
                answer: answer,
                options: options,
                type: type,
                image: null // En una implementaci√≥n real, podr√≠a haber im√°genes
            };
        }

        function generateOptions(correctAnswer, count) {
            const options = [correctAnswer];
            
            // Generar opciones incorrectas que sean cercanas a la respuesta correcta
            while (options.length < count) {
                let option;
                const variation = Math.floor(Math.random() * 10) + 1;
                const shouldAdd = Math.random() > 0.5;
                
                if (shouldAdd) {
                    option = correctAnswer + variation;
                } else {
                    option = correctAnswer - variation;
                }
                
                // Asegurarse de que la opci√≥n no sea negativa y no se repita
                if (option > 0 && !options.includes(option)) {
                    options.push(option);
                }
            }
            
            // Mezclar las opciones
            return shuffleArray(options);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function setupGameUI() {
            // Configurar UI seg√∫n el modo de juego
            const mode = gameState.room.mode;
            
            // Ocultar todos los elementos espec√≠ficos de modo primero
            elements.teamInfo.style.display = 'none';
            elements.survivalCount.style.display = 'none';
            elements.countdownClock.style.display = 'none';
            elements.tournamentBracket.style.display = 'none';
            elements.teamContainer.style.display = 'none';
            
            // Mostrar elementos seg√∫n el modo
            switch (mode) {
                case 'teams':
                    elements.teamInfo.style.display = 'block';
                    elements.teamInfo.innerHTML = '<h3>Modo Equipos</h3><p>¬°Colabora con tu equipo para ganar!</p>';
                    elements.teamContainer.style.display = 'flex';
                    setupTeams();
                    break;
                    
                case 'survival':
                    elements.survivalCount.style.display = 'block';
                    gameState.game.survival.playersLeft = gameState.room.players.length;
                    elements.playersLeft.textContent = gameState.game.survival.playersLeft;
                    break;
                    
                case 'countdown':
                    elements.countdownClock.style.display = 'block';
                    startCountdownMode();
                    break;
                    
                case 'tournament':
                    elements.tournamentBracket.style.display = 'block';
                    setupTournament();
                    break;
                    
                case '1vs1':
                    showVersusAnimation();
                    break;
            }
            
            // Mostrar bot√≥n de saltar pregunta si es anfitri√≥n
            elements.skipQuestion.style.display = gameState.player.isHost ? 'block' : 'none';
        }

        function setupTeams() {
            // Dividir jugadores en equipos
            const players = gameState.room.players;
            gameState.game.teams.red = [];
            gameState.game.teams.blue = [];
            gameState.game.teams.scores = { red: 0, blue: 0 };
            
            // Mezclar jugadores y dividirlos en equipos
            const shuffledPlayers = shuffleArray([...players]);
            shuffledPlayers.forEach((player, index) => {
                if (index % 2 === 0) {
                    gameState.game.teams.red.push(player);
                } else {
                    gameState.game.teams.blue.push(player);
                }
            });
            
            // Actualizar UI de equipos
            updateTeamsUI();
        }

        function updateTeamsUI() {
            elements.teamContainer.innerHTML = '';
            
            // Equipo rojo
            const teamRed = document.createElement('div');
            teamRed.className = 'team team-red';
            teamRed.innerHTML = `
                <h3>Equipo Rojo</h3>
                <div class="team-score">${gameState.game.teams.scores.red}</div>
                <div class="team-players">
                    ${gameState.game.teams.red.map(player => `
                        <div class="player-badge" style="background: linear-gradient(45deg, ${player.color}, ${adjustColor(player.color, 20)})">
                            <span class="player-avatar">${player.avatar}</span>
                            <span class="player-name">${player.name}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            elements.teamContainer.appendChild(teamRed);
            
            // Equipo azul
            const teamBlue = document.createElement('div');
            teamBlue.className = 'team team-blue';
            teamBlue.innerHTML = `
                <h3>Equipo Azul</h3>
                <div class="team-score">${gameState.game.teams.scores.blue}</div>
                <div class="team-players">
                    ${gameState.game.teams.blue.map(player => `
                        <div class="player-badge" style="background: linear-gradient(45deg, ${player.color}, ${adjustColor(player.color, 20)})">
                            <span class="player-avatar">${player.avatar}</span>
                            <span class="player-name">${player.name}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            elements.teamContainer.appendChild(teamBlue);
        }

        function setupTournament() {
            // Configurar estructura del torneo
            const players = gameState.room.players;
            gameState.game.tournament.rounds = [];
            gameState.game.tournament.currentRound = 0;
            gameState.game.tournament.matches = [];
            
            // Crear primera ronda (cuartos de final)
            const firstRoundMatches = [];
            for (let i = 0; i < players.length; i += 2) {
                if (i + 1 < players.length) {
                    firstRoundMatches.push({
                        player1: players[i],
                        player2: players[i + 1],
                        winner: null
                    });
                } else {
                    // Jugador libre (avanza autom√°ticamente)
                    firstRoundMatches.push({
                        player1: players[i],
                        player2: null,
                        winner: players[i]
                    });
                }
            }
            
            gameState.game.tournament.rounds.push(firstRoundMatches);
            gameState.game.tournament.matches = firstRoundMatches;
            
            // Actualizar UI del torneo
            updateTournamentBracket();
        }

        function updateTournamentBracket() {
            elements.tournamentBracket.innerHTML = '';
            
            gameState.game.tournament.rounds.forEach((round, roundIndex) => {
                const roundElement = document.createElement('div');
                roundElement.className = 'tournament-round';
                roundElement.innerHTML = `<h4>${getRoundName(roundIndex)}</h4>`;
                
                round.forEach(match => {
                    const matchElement = document.createElement('div');
                    matchElement.className = 'tournament-match';
                    
                    const player1HTML = match.player1 ? `
                        <div class="tournament-player ${match.winner === match.player1 ? 'tournament-winner' : ''}">
                            <span>${match.player1.avatar} ${match.player1.name}</span>
                        </div>
                    ` : '';
                    
                    const player2HTML = match.player2 ? `
                        <div class="tournament-player ${match.winner === match.player2 ? 'tournament-winner' : ''}">
                            <span>${match.player2.avatar} ${match.player2.name}</span>
                        </div>
                    ` : '<div class="tournament-player">Bye</div>';
                    
                    matchElement.innerHTML = player1HTML + player2HTML;
                    roundElement.appendChild(matchElement);
                });
                
                elements.tournamentBracket.appendChild(roundElement);
            });
        }

        function getRoundName(roundIndex) {
            const roundNames = ['Cuartos de final', 'Semifinales', 'Final'];
            return roundNames[roundIndex] || `Ronda ${roundIndex + 1}`;
        }

        function showVersusAnimation() {
            if (gameState.room.players.length >= 2) {
                const player1 = gameState.room.players[0];
                const player2 = gameState.room.players[1];
                
                elements.versusAvatar1.textContent = player1.avatar;
                elements.versusName1.textContent = player1.name;
                elements.versusAvatar2.textContent = player2.avatar;
                elements.versusName2.textContent = player2.name;
                
                elements.versusAnimation.style.display = 'flex';
                
                // Ocultar despu√©s de 3 segundos
                setTimeout(() => {
                    elements.versusAnimation.style.display = 'none';
                }, 3000);
            }
        }

        function startCountdownMode() {
            gameState.game.countdown.timeLeft = gameConfig.countdownTime;
            elements.countdownClock.textContent = gameState.game.countdown.timeLeft;
            
            // Iniciar cuenta regresiva global
            gameState.game.countdown.interval = setInterval(() => {
                gameState.game.countdown.timeLeft--;
                elements.countdownClock.textContent = gameState.game.countdown.timeLeft;
                
                if (gameState.game.countdown.timeLeft <= 0) {
                    clearInterval(gameState.game.countdown.interval);
                    endGame();
                }
            }, 1000);
        }

        function loadQuestion() {
            const currentQuestion = gameState.game.questions[gameState.game.currentQuestion];
            
            // Reiniciar estado de la pregunta
            gameState.game.isAnswered = false;
            gameState.game.timeLeft = getQuestionTime();
            gameState.game.startTime = Date.now();
            
            // Actualizar UI
            elements.question.textContent = currentQuestion.question;
            elements.result.textContent = '';
            elements.result.className = 'result';
            
            // Mostrar imagen si existe
            if (currentQuestion.image) {
                elements.questionImage.src = currentQuestion.image;
                elements.questionImageContainer.style.display = 'block';
            } else {
                elements.questionImageContainer.style.display = 'none';
            }
            
            // Configurar tipo de respuesta
            if (currentQuestion.options) {
                // Pregunta de opci√≥n m√∫ltiple
                elements.numericInput.style.display = 'none';
                elements.abcdButtons.style.display = 'grid';
                
                // Generar botones A/B/C/D
                elements.abcdButtons.innerHTML = '';
                const letters = ['A', 'B', 'C', 'D'];
                
                currentQuestion.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'abcd-btn';
                    button.innerHTML = `
                        <span class="letter">${letters[index]}</span>
                        <span class="option-text">${option}</span>
                    `;
                    button.addEventListener('click', () => selectAnswer(option));
                    elements.abcdButtons.appendChild(button);
                });
            } else {
                // Pregunta de entrada num√©rica
                elements.abcdButtons.style.display = 'none';
                elements.numericInput.style.display = 'block';
                elements.playerAnswer.value = '';
                elements.playerAnswer.focus();
            }
            
            // Actualizar barra de progreso
            updateProgressBar();
            
            // Actualizar informaci√≥n de ronda
            elements.roundInfo.textContent = `Pregunta ${gameState.game.currentQuestion + 1} de ${gameConfig.totalQuestions}`;
            
            // Iniciar temporizador
            startTimer();
            
            // Limpiar panel de respuestas en vivo
            if (elements.liveAnswersPanel.style.display !== 'none') {
                elements.answersList.innerHTML = '';
            }
        }

        function updateProgressBar() {
            const progress = ((gameState.game.currentQuestion) / gameConfig.totalQuestions) * 100;
            elements.progressBar.style.width = `${progress}%`;
        }

        function startTimer() {
            // Reiniciar temporizador visual
            const timerCircle = document.querySelector('.timer-circle');
            const circumference = 2 * Math.PI * 45;
            timerCircle.style.strokeDasharray = circumference;
            timerCircle.style.strokeDashoffset = 0;
            
            // Actualizar tiempo inicial
            elements.timer.textContent = gameState.game.timeLeft;
            elements.timer.className = 'timer-text';
            timerCircle.className = 'timer-circle';
            
            // Configurar intervalo del temporizador
            clearInterval(gameState.game.timer);
            gameState.game.timer = setInterval(() => {
                gameState.game.timeLeft--;
                elements.timer.textContent = gameState.game.timeLeft;
                
                // Actualizar c√≠rculo del temporizador
                const offset = circumference - (gameState.game.timeLeft / getQuestionTime()) * circumference;
                timerCircle.style.strokeDashoffset = offset;
                
                // Cambiar color cuando quede poco tiempo
                if (gameState.game.timeLeft <= 5) {
                    elements.timer.className = 'timer-text timer-warning';
                    timerCircle.className = 'timer-circle timer-warning';
                }
                
                // Tiempo agotado
                if (gameState.game.timeLeft <= 0) {
                    clearInterval(gameState.game.timer);
                    timeUp();
                }
            }, 1000);
        }

        function timeUp() {
            // Efecto de parpadeo
            elements.question.classList.add('time-up');
            
            // Marcar como no respondida
            if (!gameState.game.isAnswered) {
                gameState.game.isAnswered = true;
                elements.result.textContent = '¬°Tiempo agotado!';
                elements.result.className = 'result incorrect';
                
                // Registrar resultado
                recordAnswer(null, false, 0);
                
                // Avanzar despu√©s de un breve delay
                setTimeout(nextQuestion, 2000);
            }
        }

        function selectAnswer(answer) {
            if (!gameState.game.isAnswered) {
                gameState.game.isAnswered = true;
                
                // Calcular tiempo de respuesta
                const responseTime = (Date.now() - gameState.game.startTime) / 1000;
                
                // Verificar respuesta
                const currentQuestion = gameState.game.questions[gameState.game.currentQuestion];
                const isCorrect = answer === currentQuestion.answer;
                
                // Mostrar resultado
                if (isCorrect) {
                    elements.result.textContent = '¬°Correcto! +10 puntos';
                    elements.result.className = 'result correct';
                    
                    // Efecto de confeti para respuestas correctas
                    if (gameState.settings.animationsEnabled) {
                        triggerConfetti();
                    }
                } else {
                    elements.result.textContent = `Incorrecto. La respuesta era: ${currentQuestion.answer}`;
                    elements.result.className = 'result incorrect';
                }
                
                // Registrar respuesta
                recordAnswer(answer, isCorrect, responseTime);
                
                // Actualizar ranking en vivo
                updateLiveRanking();
                
                // Avanzar despu√©s de un breve delay
                setTimeout(nextQuestion, 2000);
            }
        }

        function submitAnswer() {
            const answer = elements.playerAnswer.value.trim();
            
            if (!answer) {
                showError(elements.result, 'Por favor, ingresa una respuesta');
                return;
            }
            
            if (!gameState.game.isAnswered) {
                gameState.game.isAnswered = true;
                
                // Calcular tiempo de respuesta
                const responseTime = (Date.now() - gameState.game.startTime) / 1000;
                
                // Verificar respuesta
                const currentQuestion = gameState.game.questions[gameState.game.currentQuestion];
                const isCorrect = parseInt(answer) === currentQuestion.answer;
                
                // Mostrar resultado
                if (isCorrect) {
                    elements.result.textContent = '¬°Correcto! +10 puntos';
                    elements.result.className = 'result correct';
                    
                    // Efecto de confeti para respuestas correctas
                    if (gameState.settings.animationsEnabled) {
                        triggerConfetti();
                    }
                } else {
                    elements.result.textContent = `Incorrecto. La respuesta era: ${currentQuestion.answer}`;
                    elements.result.className = 'result incorrect';
                }
                
                // Registrar respuesta
                recordAnswer(answer, isCorrect, responseTime);
                
                // Actualizar ranking en vivo
                updateLiveRanking();
                
                // Avanzar despu√©s de un breve delay
                setTimeout(nextQuestion, 2000);
            }
        }

        function recordAnswer(answer, isCorrect, responseTime) {
            // Registrar respuesta del jugador actual
            const result = {
                player: gameState.player,
                questionIndex: gameState.game.currentQuestion,
                answer: answer,
                isCorrect: isCorrect,
                responseTime: responseTime,
                points: isCorrect ? 10 : 0
            };
            
            gameState.game.results.push(result);
            
            // En modo multijugador, simular respuestas de otros jugadores
            if (gameState.room.mode !== 'solo') {
                simulateOtherPlayersAnswers(isCorrect, responseTime);
            }
            
            // Actualizar panel de respuestas en vivo
            updateLiveAnswers();
        }

        function simulateOtherPlayersAnswers(correct, playerResponseTime) {
            // Simular respuestas de otros jugadores (solo para demostraci√≥n)
            const otherPlayers = gameState.room.players.filter(p => p.id !== gameState.player.id);
            const currentQuestion = gameState.game.questions[gameState.game.currentQuestion];
            
            otherPlayers.forEach((player, index) => {
                setTimeout(() => {
                    // Determinar si responde correctamente (70% de probabilidad si el jugador real acert√≥, 30% si no)
                    const willBeCorrect = correct ? 
                        Math.random() < 0.7 : 
                        Math.random() < 0.3;
                    
                    // Tiempo de respuesta simulado (ligeramente mayor que el del jugador real)
                    const simulatedResponseTime = playerResponseTime + (Math.random() * 2) + 0.5;
                    
                    const simulatedAnswer = willBeCorrect ? 
                        currentQuestion.answer : 
                        generateWrongAnswer(currentQuestion.answer);
                    
                    const result = {
                        player: player,
                        questionIndex: gameState.game.currentQuestion,
                        answer: simulatedAnswer,
                        isCorrect: willBeCorrect,
                        responseTime: simulatedResponseTime,
                        points: willBeCorrect ? 10 : 0
                    };
                    
                    gameState.game.results.push(result);
                    
                    // Actualizar panel de respuestas en vivo
                    updateLiveAnswers();
                    
                    // Actualizar ranking
                    updateLiveRanking();
                }, (index + 1) * 500);
            });
        }

        function generateWrongAnswer(correctAnswer) {
            // Generar una respuesta incorrecta plausible
            const variation = Math.floor(Math.random() * 10) + 1;
            const shouldAdd = Math.random() > 0.5;
            
            if (shouldAdd) {
                return correctAnswer + variation;
            } else {
                return Math.max(1, correctAnswer - variation);
            }
        }

        function updateLiveAnswers() {
            if (elements.liveAnswersPanel.style.display === 'none') return;
            
            // Obtener respuestas de la pregunta actual
            const currentQuestionResults = gameState.game.results.filter(
                r => r.questionIndex === gameState.game.currentQuestion
            );
            
            // Ordenar por tiempo de respuesta
            currentQuestionResults.sort((a, b) => a.responseTime - b.responseTime);
            
            // Actualizar UI
            elements.answersList.innerHTML = '';
            
            currentQuestionResults.forEach((result, index) => {
                const answerItem = document.createElement('div');
                answerItem.className = `answer-item ${result.isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                if (index === 0 && result.isCorrect) {
                    answerItem.classList.add('fastest-answer');
                }
                
                answerItem.innerHTML = `
                    <div class="player-info">
                        <span class="answer-avatar">${result.player.avatar}</span>
                        <span>${result.player.name}</span>
                    </div>
                    <div class="answer-details">
                        <span>${result.answer}</span>
                        <span>${result.responseTime.toFixed(1)}s</span>
                    </div>
                `;
                
                elements.answersList.appendChild(answerItem);
            });
            
            // Si no hay respuestas a√∫n, mostrar estado de espera
            if (currentQuestionResults.length === 0) {
                const waitingItem = document.createElement('div');
                waitingItem.className = 'answer-item answer-pending';
                waitingItem.textContent = 'Esperando respuestas...';
                elements.answersList.appendChild(waitingItem);
            }
        }

        function updateLiveRanking() {
            if (elements.liveRanking.style.display === 'none') return;
            
            // Calcular puntuaciones
            const scores = {};
            gameState.room.players.forEach(player => {
                scores[player.id] = {
                    player: player,
                    points: 0,
                    correctAnswers: 0,
                    averageTime: 0,
                    totalTime: 0
                };
            });
            
            // Sumar puntos y tiempos
            gameState.game.results.forEach(result => {
                if (scores[result.player.id]) {
                    scores[result.player.id].points += result.points;
                    if (result.isCorrect) {
                        scores[result.player.id].correctAnswers++;
                    }
                    scores[result.player.id].totalTime += result.responseTime;
                }
            });
            
            // Calcular promedios
            Object.keys(scores).forEach(playerId => {
                if (scores[playerId].correctAnswers > 0) {
                    scores[playerId].averageTime = scores[playerId].totalTime / scores[playerId].correctAnswers;
                }
            });
            
            // Convertir a array y ordenar por puntos
            const ranking = Object.values(scores).sort((a, b) => b.points - a.points);
            
            // Actualizar UI
            elements.rankingList.innerHTML = '';
            
            ranking.forEach((score, index) => {
                const rankingItem = document.createElement('div');
                rankingItem.className = `ranking-item ${score.player.id === gameState.player.id ? 'current-player' : ''}`;
                
                rankingItem.innerHTML = `
                    <span class="ranking-position">${index + 1}</span>
                    <span class="ranking-avatar">${score.player.avatar}</span>
                    <span class="ranking-name">${score.player.name}</span>
                    <span class="ranking-points">${score.points}</span>
                `;
                
                elements.rankingList.appendChild(rankingItem);
            });
        }

        function nextQuestion() {
            gameState.game.currentQuestion++;
            
            if (gameState.game.currentQuestion < gameConfig.totalQuestions) {
                loadQuestion();
            } else {
                endGame();
            }
        }

        function skipQuestion() {
            if (gameState.player.isHost) {
                clearInterval(gameState.game.timer);
                nextQuestion();
            }
        }

        function endGame() {
            // Detener temporizadores
            clearInterval(gameState.game.timer);
            clearInterval(gameState.game.countdown.interval);
            
            // Calcular resultados finales
            calculateFinalResults();
            
            // Guardar en historial
            saveGameToHistory();
            
            // Mostrar pantalla de resultados
            showScreen('results');
        }

        function calculateFinalResults() {
            // Calcular puntuaciones finales
            const scores = {};
            gameState.room.players.forEach(player => {
                scores[player.id] = {
                    player: player,
                    points: 0,
                    correctAnswers: 0,
                    averageTime: 0,
                    totalTime: 0,
                    streak: 0,
                    maxStreak: 0
                };
            });
            
            // Procesar todas las respuestas
            let currentStreak = 0;
            let lastPlayerId = null;
            
            gameState.game.results.forEach(result => {
                if (scores[result.player.id]) {
                    scores[result.player.id].points += result.points;
                    
                    if (result.isCorrect) {
                        scores[result.player.id].correctAnswers++;
                        scores[result.player.id].totalTime += result.responseTime;
                        
                        // Calcular racha
                        if (result.player.id === lastPlayerId) {
                            currentStreak++;
                        } else {
                            currentStreak = 1;
                            lastPlayerId = result.player.id;
                        }
                        
                        scores[result.player.id].streak = currentStreak;
                        scores[result.player.id].maxStreak = Math.max(scores[result.player.id].maxStreak, currentStreak);
                    } else {
                        currentStreak = 0;
                        lastPlayerId = null;
                    }
                }
            });
            
            // Calcular promedios
            Object.keys(scores).forEach(playerId => {
                if (scores[playerId].correctAnswers > 0) {
                    scores[playerId].averageTime = scores[playerId].totalTime / scores[playerId].correctAnswers;
                }
            });
            
            // Convertir a array y ordenar por puntos
            gameState.game.finalScores = Object.values(scores).sort((a, b) => b.points - a.points);
        }

        function showFinalResults() {
            // Mostrar podio
            showPodium();
            
            // Mostrar otros jugadores
            showOtherPlayers();
            
            // Mostrar estad√≠sticas avanzadas
            showAdvancedStats();
            
            // Mostrar preguntas m√°s dif√≠ciles
            showDifficultQuestions();
            
            // Efectos de celebraci√≥n
            if (gameState.settings.animationsEnabled) {
                triggerFireworks();
                triggerConfetti();
            }
        }

        function showPodium() {
            elements.podium.innerHTML = '';
            
            // Tomar los primeros 3 jugadores
            const topPlayers = gameState.game.finalScores.slice(0, 3);
            
            // Si hay menos de 3 jugadores, ajustar
            while (topPlayers.length < 3) {
                topPlayers.push(null);
            }
            
            // Segundo lugar
            if (topPlayers[1]) {
                const secondPlace = createPodiumPlace(topPlayers[1], 2);
                elements.podium.appendChild(secondPlace);
            }
            
            // Primer lugar
            if (topPlayers[0]) {
                const firstPlace = createPodiumPlace(topPlayers[0], 1);
                elements.podium.appendChild(firstPlace);
                
                // A√±adir corona y emoji bailar√≠n
                const crown = document.createElement('div');
                crown.className = 'crown';
                crown.textContent = 'üëë';
                firstPlace.querySelector('.podium-1').appendChild(crown);
                
                const dancer = document.createElement('div');
                dancer.className = 'winner-dancing-emoji';
                dancer.textContent = 'üíÉ';
                firstPlace.appendChild(dancer);
            }
            
            // Tercer lugar
            if (topPlayers[2]) {
                const thirdPlace = createPodiumPlace(topPlayers[2], 3);
                elements.podium.appendChild(thirdPlace);
            }
        }

        function createPodiumPlace(score, position) {
            if (!score) return document.createElement('div');
            
            const place = document.createElement('div');
            place.className = 'podium-place';
            
            const podiumClass = `podium-${position}`;
            const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : 'ü•â';
            
            place.innerHTML = `
                <div class="${podiumClass}"></div>
                <div class="podium-name">
                    <span class="podium-avatar">${score.player.avatar}</span>
                    <span>${score.player.name}</span>
                </div>
                <div class="podium-points">${medal} ${score.points} puntos</div>
            `;
            
            return place;
        }

        function showOtherPlayers() {
            // Mostrar jugadores que no est√°n en el podio
            const otherPlayers = gameState.game.finalScores.slice(3);
            
            elements.otherPlayers.innerHTML = '';
            
            if (otherPlayers.length === 0) {
                elements.otherPlayers.innerHTML = '<p>No hay m√°s jugadores</p>';
                return;
            }
            
            otherPlayers.forEach((score, index) => {
                const playerElement = document.createElement('div');
                playerElement.className = 'other-player';
                
                playerElement.innerHTML = `
                    <div class="player-info">
                        <span class="other-avatar">${score.player.avatar}</span>
                        <span>${index + 4}. ${score.player.name}</span>
                    </div>
                    <div class="player-stats">
                        <span>${score.points} puntos</span>
                    </div>
                `;
                
                elements.otherPlayers.appendChild(playerElement);
            });
        }

        function showAdvancedStats() {
            elements.advancedStats.innerHTML = '';
            
            // Solo mostrar estad√≠sticas si hay al menos un jugador
            if (gameState.game.finalScores.length === 0) return;
            
            const stats = [
                {
                    label: 'Preguntas correctas',
                    value: gameState.game.finalScores[0].correctAnswers + '/' + gameConfig.totalQuestions
                },
                {
                    label: 'Tiempo promedio',
                    value: gameState.game.finalScores[0].averageTime.toFixed(2) + 's'
                },
                {
                    label: 'M√°xima racha',
                    value: gameState.game.finalScores[0].maxStreak
                },
                {
                    label: 'Puntuaci√≥n total',
                    value: gameState.game.finalScores[0].points
                }
            ];
            
            stats.forEach(stat => {
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                `;
                elements.advancedStats.appendChild(statCard);
            });
        }

        function showDifficultQuestions() {
            // Identificar preguntas m√°s falladas
            const questionStats = {};
            
            gameState.game.questions.forEach((question, index) => {
                questionStats[index] = {
                    question: question.question,
                    correctAnswers: 0,
                    totalAnswers: 0
                };
            });
            
            gameState.game.results.forEach(result => {
                if (questionStats[result.questionIndex]) {
                    questionStats[result.questionIndex].totalAnswers++;
                    if (result.isCorrect) {
                        questionStats[result.questionIndex].correctAnswers++;
                    }
                }
            });
            
            // Convertir a array y ordenar por tasa de error
            const difficultQuestions = Object.values(questionStats)
                .filter(q => q.totalAnswers > 0)
                .map(q => ({
                    ...q,
                    errorRate: (q.totalAnswers - q.correctAnswers) / q.totalAnswers
                }))
                .sort((a, b) => b.errorRate - a.errorRate)
                .slice(0, 3); // Top 3 preguntas m√°s dif√≠ciles
            
            // Mostrar solo si hay preguntas dif√≠ciles
            if (difficultQuestions.length > 0 && difficultQuestions[0].errorRate > 0) {
                elements.errorsPanel.style.display = 'block';
                elements.errorsPanel.innerHTML = '<h3>Preguntas m√°s dif√≠ciles</h3>';
                
                difficultQuestions.forEach((q, index) => {
                    const errorQuestion = document.createElement('div');
                    errorQuestion.className = 'error-question';
                    errorQuestion.innerHTML = `
                        <p><strong>${index + 1}. ${q.question}</strong></p>
                        <p>Tasa de error: ${(q.errorRate * 100).toFixed(1)}%</p>
                    `;
                    elements.errorsPanel.appendChild(errorQuestion);
                });
            }
        }

        function saveGameToHistory() {
            const gameRecord = {
                date: new Date().toISOString(),
                mode: gameState.room.mode,
                players: gameState.room.players.map(p => p.name),
                scores: gameState.game.finalScores.map(s => ({
                    player: s.player.name,
                    points: s.points,
                    correctAnswers: s.correctAnswers
                })),
                duration: (Date.now() - gameState.game.startTime) / 1000
            };
            
            gameState.history.unshift(gameRecord);
            
            // Mantener solo las √∫ltimas 50 partidas
            if (gameState.history.length > 50) {
                gameState.history = gameState.history.slice(0, 50);
            }
            
            // Guardar en localStorage
            localStorage.setItem('mathChallengeHistory', JSON.stringify(gameState.history));
        }

        function showGameHistory() {
            elements.historyList.innerHTML = '';
            
            if (gameState.history.length === 0) {
                elements.historyList.innerHTML = '<p>No hay partidas anteriores</p>';
                return;
            }
            
            gameState.history.forEach((record, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(record.date).toLocaleDateString();
                const winner = record.scores.length > 0 ? record.scores[0].player : 'N/A';
                
                historyItem.innerHTML = `
                    <h4>Partida ${index + 1} - ${date}</h4>
                    <p>Modo: ${getModeDisplayName(record.mode)}</p>
                    <p>Jugadores: ${record.players.join(', ')}</p>
                    <p>Ganador: ${winner} (${record.scores[0]?.points || 0} puntos)</p>
                    <p>Duraci√≥n: ${Math.floor(record.duration / 60)}m ${Math.floor(record.duration % 60)}s</p>
                `;
                
                elements.historyList.appendChild(historyItem);
            });
        }

        function playAgain() {
            if (gameState.room.mode === 'solo') {
                // Reiniciar juego individual
                initializeGameSession();
                showScreen('game');
                loadQuestion();
            } else {
                // Volver al lobby multijugador
                showScreen('lobby');
                updateLobbyUI();
            }
        }

        function showHistory() {
            showScreen('history');
        }

        function hideHistory() {
            showScreen('results');
        }

        function goToMainMenu() {
            if (confirm('¬øVolver al men√∫ principal? Se perder√° el progreso actual.')) {
                showScreen('join');
            }
        }

        // =============================================
        // FUNCIONALIDADES ADICIONALES
        // =============================================

        function toggleDarkMode() {
            gameState.settings.darkMode = !gameState.settings.darkMode;
            localStorage.setItem('darkMode', gameState.settings.darkMode);
            applyTheme();
        }

        function handleKeyPress(key) {
            if (key === 'clear') {
                elements.playerAnswer.value = '';
            } else {
                elements.playerAnswer.value += key;
            }
        }

        function updateGameModeIndicator() {
            const mode = gameState.room.mode;
            elements.gameModeIndicator.innerHTML = `
                <h3>Modo: ${getModeDisplayName(mode)}</h3>
                ${mode === 'survival' ? '<p>¬°Responde correctamente para sobrevivir!</p>' : ''}
                ${mode === 'countdown' ? '<p>¬°Responde tantas preguntas como puedas en 60 segundos!</p>' : ''}
                ${mode === 'teams' ? '<p>¬°Colabora con tu equipo para ganar!</p>' : ''}
            `;
        }

        function updateConnectionStatus() {
            // Simular cambios de estado de conexi√≥n
            const statuses = ['connected', 'connecting', 'disconnected'];
            const messages = {
                connected: 'Conectado',
                connecting: 'Conectando...',
                disconnected: 'Desconectado'
            };
            
            // Cambiar estado aleatoriamente (solo para demostraci√≥n)
            if (Math.random() < 0.01) { // 1% de probabilidad
                const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                elements.connectionStatus.className = `connection-status ${randomStatus}`;
                elements.connectionStatus.innerHTML = `<span class="loader-small"></span> ${messages[randomStatus]}`;
                
                elements.lobbyConnectionStatus.className = `connection-status ${randomStatus}`;
                elements.lobbyConnectionStatus.innerHTML = `<span class="loader-small"></span> ${messages[randomStatus]}`;
                
                if (randomStatus === 'disconnected') {
                    elements.reconnectOverlay.style.display = 'flex';
                    
                    // Reconectar despu√©s de 3 segundos
                    setTimeout(() => {
                        elements.reconnectOverlay.style.display = 'none';
                        updateConnectionStatus(); // Volver a conectado
                    }, 3000);
                }
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            elements.notificationArea.appendChild(notification);
            
            // Eliminar despu√©s de 3 segundos
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
            
            // Ocultar despu√©s de 3 segundos
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }

        function triggerConfetti() {
            if (typeof confetti === 'function') {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        function triggerFireworks() {
            // Implementaci√≥n simplificada de fuegos artificiales
            const container = elements.fireworksContainer;
            container.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.style.position = 'absolute';
                    firework.style.left = Math.random() * 100 + '%';
                    firework.style.top = Math.random() * 50 + '%';
                    firework.style.width = '4px';
                    firework.style.height = '4px';
                    firework.style.backgroundColor = gameConfig.colors[Math.floor(Math.random() * gameConfig.colors.length)];
                    firework.style.borderRadius = '50%';
                    firework.style.boxShadow = '0 0 10px currentColor';
                    firework.style.animation = 'firework 1s ease-out forwards';
                    
                    // A√±adir estilo de animaci√≥n
                    if (!document.querySelector('#fireworkStyle')) {
                        const style = document.createElement('style');
                        style.id = 'fireworkStyle';
                        style.textContent = `
                            @keyframes firework {
                                0% { transform: scale(1); opacity: 1; }
                                100% { transform: scale(20); opacity: 0; }
                            }
                        `;
                        document.head.appendChild(style);
                    }
                    
                    container.appendChild(firework);
                    
                    // Eliminar despu√©s de la animaci√≥n
                    setTimeout(() => {
                        firework.remove();
                    }, 1000);
                }, i * 200);
            }
        }

        function initializeParticles() {
            // Implementaci√≥n simplificada de part√≠culas de fondo
            const container = elements.particlesContainer;
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.width = Math.random() * 3 + 1 + 'px';
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = gameConfig.colors[Math.floor(Math.random() * gameConfig.colors.length)];
                particle.style.borderRadius = '50%';
                particle.style.opacity = Math.random() * 0.5 + 0.1;
                particle.style.animation = `float ${Math.random() * 10 + 10}s linear infinite`;
                
                // A√±adir estilo de animaci√≥n
                if (!document.querySelector('#particleStyle')) {
                    const style = document.createElement('style');
                    style.id = 'particleStyle';
                    style.textContent = `
                        @keyframes float {
                            0% { transform: translate(0, 0); }
                            25% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px); }
                            50% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px); }
                            75% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px); }
                            100% { transform: translate(0, 0); }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                container.appendChild(particle);
            }
        }

        function initializeLobby3D() {
            // Implementaci√≥n simplificada de escena 3D para el lobby
            // En una implementaci√≥n real, se usar√≠a Three.js para crear una escena 3D interactiva
            const canvas = elements.lobby3DCanvas;
            const ctx = canvas.getContext('2d');
            
            // Ajustar tama√±o del canvas
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Dibujar fondo animado
            function animate() {
                ctx.fillStyle = gameState.settings.darkMode ? 'rgba(26, 26, 46, 0.1)' : 'rgba(245, 247, 250, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Dibujar part√≠culas flotantes
                for (let i = 0; i < 10; i++) {
                    const x = (Date.now() / 50 + i * 100) % canvas.width;
                    const y = Math.sin(Date.now() / 1000 + i) * 50 + canvas.height / 2;
                    const size = Math.sin(Date.now() / 500 + i) * 5 + 10;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fillStyle = gameConfig.colors[i % gameConfig.colors.length] + '20';
                    ctx.fill();
                }
                
                requestAnimationFrame(animate);
            }
            
            animate();
        }

        // =============================================
        // INICIALIZACI√ìN FINAL
        // =============================================

        // Asegurarse de que el juego se inicialice correctamente
        window.addEventListener('load', function() {
            // Peque√±o delay para que se carguen todos los recursos
            setTimeout(() => {
                elements.welcomeScreen.style.opacity = '1';
            }, 100);
        });
    </script>
    <script>
  // üëâ Conecta al servidor WebSocket de forma segura y exponible
  (function() {
    const socketUrl = "wss://juego-matematic.onrender.com";

    if (!('WebSocket' in window)) {
      console.warn("WebSocket no es compatible con este navegador.");
      return;
    }

    let socket;
    try {
      socket = new WebSocket(socketUrl);
    } catch (err) {
      console.error("‚ùå No se pudo crear WebSocket:", err);
      return;
    }

    socket.addEventListener('open', () => {
      console.log("‚úÖ Conectado al servidor WebSocket");
    });

    socket.addEventListener('error', (err) => {
      console.error("‚ùå Error de conexi√≥n WS:", err);
    });

    socket.addEventListener('close', () => {
      console.warn("‚ö†Ô∏è Conexi√≥n WS cerrada");
    });

    socket.addEventListener('message', (event) => {
      console.log("üì© Mensaje recibido:", event.data);
    });

    // Exponer el socket para uso posterior si es necesario
    window.gameSocket = socket;
  })();
</script>
</body>
</html>
