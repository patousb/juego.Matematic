<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Challenge PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --azul: #4e8cff;
            --rojo: #ff6b6b;
            --verde: #6bff6b;
            --amarillo: #ffde59;
            --morado: #a459ff;
            --fondo: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --texto: #333;
            --panel: white;
            --borde: #ddd;
            --sombra: rgba(0, 0, 0, 0.1);
            --tiempo-normal: #a459ff;
            --tiempo-alerta: #ff6b6b;
        }

        .dark-mode {
            --fondo: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --texto: #f0f0f0;
            --panel: #1e293b;
            --borde: #334155;
            --sombra: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Neue', cursive;
            text-align: center;
            background: var(--fondo);
            color: var(--texto);
            min-height: 100vh;
            transition: all 0.3s ease;
            padding: 20px;
        }

        h1, h2, h3 {
            font-family: 'Fredoka One', cursive;
            color: var(--texto);
            margin-bottom: 20px;
        }

        /* Pantalla de carga */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--fondo);
            z-index: 2000;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(78, 140, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--morado);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        .loader-small {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(78, 140, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--morado);
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Pantalla de uni√≥n */
        .join-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--fondo);
            z-index: 1000;
            padding: 20px;
        }

        .join-form {
            background: var(--panel);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px var(--sombra);
            width: 100%;
            max-width: 500px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--borde);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Comic Neue', cursive;
        }

        .avatar-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .avatar-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .avatar-option:hover {
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: var(--morado);
            transform: scale(1.1);
        }

        .btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Comic Neue', cursive;
            margin: 8px;
            background: linear-gradient(45deg, var(--azul), var(--morado));
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px var(--sombra);
        }

        .btn-secondary {
            background: var(--panel);
            border: 2px solid var(--borde);
            color: var(--texto);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .error-message {
            color: var(--rojo);
            margin-top: 10px;
            font-weight: bold;
        }

        /* Lobby multijugador */
        .multiplayer-lobby {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo);
            z-index: 1000;
            display: none; /* Inicialmente oculto */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .lobby-container {
            background: var(--panel);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px var(--sombra);
            width: 100%;
            max-width: 800px;
        }

        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .player-badge {
            background: linear-gradient(45deg, var(--azul), var(--morado));
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .vote-section {
            margin: 30px 0;
        }

        .vote-timer {
            font-size: 1.5rem;
            margin: 15px 0;
            font-weight: bold;
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .mode-btn {
            padding: 15px;
            border: 2px solid var(--borde);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            background: var(--panel);
        }

        .mode-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px var(--sombra);
        }

        .mode-btn.selected {
            background: var(--morado);
            color: white;
            border-color: var(--morado);
        }

        .mode-btn.voted {
            position: relative;
            overflow: hidden;
        }

        .mode-btn.voted::after {
            content: "‚úì";
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--verde);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .vote-results {
            margin-top: 20px;
            padding: 15px;
            background: var(--panel);
            border-radius: 10px;
            border: 2px solid var(--borde);
        }

        /* Juego principal */
        #gameContainer {
            display: none; /* Inicialmente oculto */
            max-width: 800px;
            margin: 0 auto;
        }

        .game {
            background: var(--panel);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px var(--sombra);
            margin: 20px 0;
            border: 4px solid var(--amarillo);
        }

        .question {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid var(--morado);
        }

        .math-question {
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .number {
            font-weight: bold;
            color: var(--morado);
        }

        .equals {
            color: var(--texto);
        }

        .question-mark {
            color: var(--amarillo);
            animation: pulse 1.5s infinite;
        }

        .question-image {
            max-width: 100%;
            max-height: 200px;
            margin: 10px auto;
            border-radius: 8px;
        }

        .input-container {
            margin: 20px 0;
        }

        #playerAnswer {
            padding: 12px;
            font-size: 1.3rem;
            width: 200px;
            text-align: center;
            margin-bottom: 15px;
            border: 2px solid var(--borde);
            border-radius: 8px;
        }

        .keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 0 auto;
        }

        .key {
            padding: 15px;
            font-size: 1.3rem;
            cursor: pointer;
            background: var(--panel);
            border: 2px solid var(--borde);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .key:hover {
            background: var(--borde);
        }

        .key.negative {
            grid-column: span 3;
        }

        .result {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 15px 0;
            min-height: 40px;
        }

        .result-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .operation {
            font-size: 1.2rem;
        }

        .correct-answer {
            color: var(--verde);
            font-weight: bold;
        }

        .points {
            font-size: 1.1rem;
            color: var(--amarillo);
        }

        .correct {
            color: var(--verde);
            animation: tada 1s ease;
        }

        .incorrect {
            color: var(--rojo);
            animation: shake 0.5s ease;
        }

        @keyframes tada {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Temporizador */
        .timer-container {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            position: relative;
        }

        .timer-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .timer-circle {
            fill: none;
            stroke: var(--tiempo-normal);
            stroke-width: 6;
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 1s linear;
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--tiempo-normal);
        }

        .timer-warning {
            stroke: var(--tiempo-alerta);
            color: var(--tiempo-alerta);
        }

        /* Barra de progreso */
        .progress-container {
            width: 80%;
            height: 10px;
            background: var(--borde);
            border-radius: 5px;
            margin: 20px auto;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--azul), var(--morado));
            transition: width 0.5s ease;
        }

        /* Ranking en vivo */
        .live-ranking {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 250px;
            background: var(--panel);
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--sombra);
            padding: 15px;
            z-index: 50;
            display: none; /* Inicialmente oculto */
            border: 3px solid var(--morado);
        }

        .live-ranking h3 {
            margin-bottom: 10px;
            color: var(--morado);
            text-align: center;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 8px;
            background: rgba(78, 140, 255, 0.1);
            transition: all 0.5s ease;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .ranking-item.current-player {
            background: rgba(255, 222, 89, 0.2);
            border-left: 4px solid var(--amarillo);
        }

        .ranking-item.move-up {
            animation: moveUp 0.5s ease;
        }

        .ranking-item.move-down {
            animation: moveDown 0.5s ease;
        }

        @keyframes moveUp {
            0% { transform: translateY(0); background: var(--verde); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }

        @keyframes moveDown {
            0% { transform: translateY(0); background: var(--rojo); }
            50% { transform: translateY(10px); }
            100% { transform: translateY(0); }
        }

        .ranking-position {
            font-weight: bold;
            color: var(--morado);
        }

        .ranking-name {
            flex-grow: 1;
            margin: 0 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-points {
            font-weight: bold;
            color: var(--azul);
        }

        .ranking-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* Resultados finales */
        .final-results {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo);
            display: none; /* Inicialmente oculto */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin: 30px 0;
            height: 250px;
        }

        .podium-place {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
        }

        .podium-1 {
            height: 200px;
            background: linear-gradient(to top, #ffd700, #ffec80);
            width: 100px;
            border-radius: 8px 8px 0 0;
            animation: bounce 1s ease;
        }

        .podium-2 {
            height: 150px;
            background: linear-gradient(to top, #c0c0c0, #e0e0e0);
            width: 100px;
            border-radius: 8px 8px 0 0;
            animation: bounce 1s 0.2s ease;
        }

        .podium-3 {
            height: 100px;
            background: linear-gradient(to top, #cd7f32, #e0a76c);
            width: 100px;
            border-radius: 8px 8px 0 0;
            animation: bounce 1s 0.4s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .podium-name {
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .podium-points {
            font-size: 1rem;
            color: var(--texto);
        }

        .podium-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .other-players {
            max-height: 200px;
            overflow-y: auto;
            width: 80%;
            max-width: 500px;
            margin-top: 20px;
            padding: 10px;
            background: var(--panel);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--sombra);
        }

        .other-player {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
            align-items: center;
        }

        .other-player:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .other-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 3px 10px var(--sombra);
            z-index: 200;
            animation: fadeInOut 3s ease forwards;
            display: flex;
            align-items: center;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        /* Estado de conexi√≥n */
        .connection-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            background: var(--panel);
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 100;
        }

        .connection-status.connected {
            color: var(--verde);
        }

        .connection-status.disconnected {
            color: var(--rojo);
            animation: pulse 1.5s infinite;
        }

        .connection-status.connecting {
            color: var(--amarillo);
        }

        /* Bot√≥n tema nocturno */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--panel);
            border: 2px solid var(--borde);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px var(--sombra);
            z-index: 100;
        }

        /* Bot√≥n saltar pregunta (modo profesor) */
        .skip-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: none; /* Inicialmente oculto, se muestra para el profesor */
        }

        /* Modo rel√°mpago */
        .lightning-mode .timer-container {
            width: 70px;
            height: 70px;
        }

        .lightning-mode .timer-text {
            font-size: 1.5rem;
        }

        /* Modo verdadero/falso */
        .true-false-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .true-false-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        .true-btn {
            background-color: var(--verde);
            color: white;
        }

        .false-btn {
            background-color: var(--rojo);
            color: white;
        }

        /* Animaci√≥n de nueva pregunta */
        .question-animation {
            animation: pulseQuestion 0.5s ease;
        }

        @keyframes pulseQuestion {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Indicador de modo actual */
        .game-mode-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel);
            padding: 8px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 10px var(--sombra);
            z-index: 100;
            font-weight: bold;
            display: none; /* Inicialmente oculto */
        }

        /* Bot√≥n listo en lobby */
        .ready-btn {
            /* position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); */ /* Movido al flujo normal del lobby */
            z-index: 100;
            margin-top: 20px; /* A√±adido para espaciado */
        }
        
        /* Bot√≥n Iniciar Votaci√≥n (solo para el Host) */
        .start-vote-btn {
             display: none; /* Oculto por defecto, se muestra para el host */
             margin-top: 15px;
        }


        /* Logros y medallas */
        .achievement-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ffde59"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>');
            background-size: contain;
            margin-left: 5px;
            vertical-align: middle;
        }

        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--panel);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--sombra);
            z-index: 1000;
            text-align: center;
            display: none; /* Inicialmente oculto */
            animation: achievementUnlock 1s ease;
        }

        @keyframes achievementUnlock {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Estad√≠sticas del jugador */
        .player-stats {
            position: fixed;
            bottom: 50px;
            right: 20px;
            background: var(--panel);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--sombra);
            z-index: 100;
            display: none; /* Inicialmente oculto */
            max-width: 250px;
        }

        .player-stats h3 {
            margin-bottom: 10px;
            color: var(--morado);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .stat-label {
            font-weight: bold;
        }

        .stat-value {
            color: var(--azul);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mode-buttons {
                grid-template-columns: 1fr;
            }
            
            .keyboard {
                grid-template-columns: repeat(3, 70px);
            }

            .live-ranking {
                width: 200px;
                left: 10px;
                top: 10px;
            }

            .podium-place {
                margin: 0 5px;
            }

            .podium-1, .podium-2, .podium-3 {
                width: 80px;
            }

            .true-false-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .true-false-btn {
                width: 100%;
            }

            .player-stats {
                bottom: 70px;
                right: 10px;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <h2>Cargando Math Challenge PRO...</h2>
    </div>

    <div class="join-screen" id="joinScreen">
        <h1>‚ú® Math Challenge PRO ‚ú®</h1>
        <div class="join-form">
            <h2>¬°√önete al juego!</h2>
            <div class="input-group">
                <label for="playerName">Tu nombre:</label>
                <input type="text" id="playerName" placeholder="Ej: Juan" maxlength="20">
            </div>
            <div class="input-group">
                <label for="grade">Tu grado:</label>
                <input type="text" id="grade" placeholder="Ej: 5¬∞ Primaria" maxlength="20">
            </div>
            <div class="input-group">
                <label for="gamePin">C√≥digo PIN:</label>
                <input type="text" id="gamePin" placeholder="Ej: 1234" maxlength="4">
            </div>
            
            <div class="input-group">
                <label>Elige tu avatar:</label>
                <div class="avatar-selector" id="avatarSelector">
                    <img src="https://i.pravatar.cc/150?img=1" class="avatar-option" data-avatar="1">
                    <img src="https://i.pravatar.cc/150?img=2" class="avatar-option" data-avatar="2">
                    <img src="https://i.pravatar.cc/150?img=3" class="avatar-option" data-avatar="3">
                    <img src="https://i.pravatar.cc/150?img=4" class="avatar-option" data-avatar="4">
                    <img src="https://i.pravatar.cc/150?img=5" class="avatar-option" data-avatar="5">
                    <img src="https://i.pravatar.cc/150?img=6" class="avatar-option" data-avatar="6">
                </div>
            </div>
            
            <button class="btn" id="joinGame">Unirse</button>
            <button class="btn btn-secondary" id="createGame">Crear nueva sala</button>
            <p id="joinError" class="error-message"></p>
        </div>
    </div>

    <div class="multiplayer-lobby" id="multiplayerLobby">
        <div class="lobby-container">
            <h2>Sala: <span id="lobbyPin">----</span></h2>
            <div class="player-count">Jugadores: <span id="playerCount">0</span>/15</div>
            
            <div class="vote-section">
                <h3>Votar modo de juego:</h3>
                <div class="vote-timer">Tiempo: <span id="voteTime">30</span>s</div>
                <div class="mode-buttons">
                    <button class="mode-btn" data-mode="operaciones">üî¢ Operaci√≥n R√°pida</button>
                    <button class="mode-btn" data-mode="misterioso">‚ùì N√∫mero Misterioso</button>
                    <button class="mode-btn" data-mode="secuencia">üìà Secuencia Num√©rica</button>
                    <button class="mode-btn" data-mode="potenciacion">üí™ Potenciaci√≥n</button>
                    <button class="mode-btn" data-mode="combinadas">üß© Operaciones Combinadas</button>
                    <button class="mode-btn" data-mode="relampago">‚ö° Modo Rel√°mpago</button>
                    <button class="mode-btn" data-mode="verdadero-falso">‚úÖ‚ùå Verdadero/Falso</button>
                    <button class="mode-btn" data-mode="mas-cercano">üéØ El m√°s cercano gana</button>
                </div>
                <div class="vote-results">
                    <h4>Resultados:</h4>
                    <div id="voteResults"><p>Esperando votos...</p></div>
                </div>
            </div>
            
            <div class="player-list" id="multiplayerPlayerList"></div>
            <button class="btn ready-btn" id="readyBtn">üëç Listo</button>
            <button class="btn start-vote-btn" id="startVoteBtn">üéâ Iniciar Votaci√≥n üéâ</button> 
        </div>
    </div>

    <div class="live-ranking" id="liveRanking">
        <h3>üèÜ Ranking en Vivo</h3>
        <div id="rankingList"></div>
    </div>

    <div id="gameContainer">
        <h1>‚ú® Math Challenge PRO ‚ú®</h1>
        <div class="game-mode-indicator" id="gameModeIndicator"></div>

        <div class="timer-container">
            <svg class="timer-svg" viewBox="0 0 100 100">
                <circle class="timer-circle" cx="50" cy="50" r="45"></circle>
            </svg>
            <div class="timer-text" id="timerText">30</div>
        </div>

        <div class="game">
            <p class="score">Puntos: <span id="playerScore">0</span> üíé</p>
            <p id="currentQuestion" class="question">Haz clic en un juego para comenzar</p>
            <img id="questionImage" class="question-image" style="display: none;">
            
            <div class="input-container" id="standardInput">
                <input type="text" id="playerAnswer" readonly>
                <div class="keyboard">
                    <div class="key" data-number="1">1</div>
                    <div class="key" data-number="2">2</div>
                    <div class="key" data-number="3">3</div>
                    <div class="key" data-number="4">4</div>
                    <div class="key" data-number="5">5</div>
                    <div class="key" data-number="6">6</div>
                    <div class="key" data-number="7">7</div>
                    <div class="key" data-number="8">8</div>
                    <div class="key" data-number="9">9</div>
                    <div class="key" data-action="clear">‚å´</div>
                    <div class="key" data-number="0">0</div>
                    <div class="key negative" data-number="-">-</div>
                </div>
                <button class="btn" id="submitAnswer">Responder üöÄ</button>
                <p id="answerResult" class="result">Esperando respuesta... ü§î</p>
            </div>
            
            <div class="true-false-buttons" id="trueFalseButtons" style="display: none;">
                <button class="true-false-btn true-btn" id="trueBtn">‚úÖ Verdadero</button>
                <button class="true-false-btn false-btn" id="falseBtn">‚ùå Falso</button>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <button class="btn" id="reiniciarBtn">üîÑ Reiniciar Juego</button>
        <p id="mensajeVictoria" class="result"></p>
    </div>

    <div class="final-results" id="finalResults">
        <h1>üèÜ ¬°Juego Terminado! üèÜ</h1>
        <div class="podium">
            <div class="podium-place" id="secondPlace">
                <div class="podium-2"></div>
                <div class="podium-name">
                    <img class="podium-avatar" id="secondAvatar">
                    <span id="secondName">-</span>
                </div>
                <div class="podium-points">0 pts</div>
            </div>
            <div class="podium-place" id="firstPlace">
                <div class="podium-1"></div>
                <div class="podium-name">
                    <img class="podium-avatar" id="firstAvatar">
                    <span id="firstName">-</span>
                </div>
                <div class="podium-points">0 pts</div>
            </div>
            <div class="podium-place" id="thirdPlace">
                <div class="podium-3"></div>
                <div class="podium-name">
                    <img class="podium-avatar" id="thirdAvatar">
                    <span id="thirdName">-</span>
                </div>
                <div class="podium-points">0 pts</div>
            </div>
        </div>
        <div class="other-players" id="otherPlayers"></div>
        <button class="btn" id="backToLobby">Volver al Lobby</button>
    </div>

    <div class="theme-toggle" id="themeToggle">üåô</div>
    
    <button class="btn skip-btn" id="skipQuestion">‚è≠Ô∏è Saltar pregunta</button>

    <div class="connection-status connected" id="connectionStatus">üü¢ Conectado</div>

    <div class="achievement-popup" id="achievementPopup">
        <div class="achievement-icon">üèÜ</div>
        <h3 id="achievementTitle">Logro Desbloqueado</h3>
        <p id="achievementDescription">Descripci√≥n del logro</p>
        <button class="btn" id="closeAchievement">¬°Genial!</button>
    </div>

    <div class="player-stats" id="playerStats">
        <h3>üìä Mis Estad√≠sticas</h3>
        <div id="statsContent"></div>
        <button class="btn" id="closeStats">Cerrar</button>
    </div>

    <audio id="correctSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>
    <audio id="wrongSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" preload="auto"></audio>
    <audio id="winSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>
    <audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" preload="auto"></audio>
    <audio id="countdownSound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-explosion-1699.mp3" preload="auto"></audio>
    <audio id="achievementSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" preload="auto"></audio>

    <script>
        class GameManager {
            constructor() {
                // Estados del juego
                this.STATES = {
                    LOADING: 0,
                    JOIN_SCREEN: 1,
                    LOBBY: 2,
                    VOTING: 3, // Estado de votaci√≥n activa
                    PLAYING: 4,
                    RESULTS: 5
                };
                this.state = this.STATES.LOADING;

                this.player = {
                    id: null, name: "", grade: "", displayName: "", avatar: "1", points: 0,
                    hasAnswered: false, hasVoted: false, streak: 0, maxStreak: 0,
                    avgResponseTime: 0, responseTimes: [], history: [], isProfessor: false,
                    isReady: false, gamesPlayed: 0, favoriteMode: null, modeStats: {}, achievements: []
                };
                
                this.questions = [];
                this.currentQuestionIndex = 0;
                this.gameMode = null; // El modo de juego actual seleccionado
                this.timeLeft = 30; // Tiempo para preguntas/votaci√≥n
                this.timerDuration = 30; // Duraci√≥n base del temporizador de preguntas
                this.initialVoteTime = 30; // Tiempo inicial para votaci√≥n
                this.timerInterval = null; // Intervalo para el temporizador de preguntas
                this.soundEnabled = true;
                this.currentQuestionData = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 3000;
                this.closestAnswerMode = false;
                this.lastAnswerTime = null;
                this.animationFrameId = null;
                
                // Multijugador
                this.isMultiplayer = false;
                this.isHost = false;
                this.gamePin = '';
                this.players = [];
                this.playerVotes = {}; // Qui√©n vot√≥ por qu√© (si se necesita granularidad)
                this.selectedGameModeForNextRound = null; // Modo votado para la siguiente ronda
                this.playerRanking = [];
                this.maxPlayers = 15;
                this.socket = null;
                this.socketUrl = 'wss://pollen-fortunate-kangaroo.glitch.me'; // Reemplaza con tu URL de Glitch si es diferente
                this.heartbeatInterval = null;
                this.lastPongTime = null;
                
                // Votaci√≥n
                this.voteTimeLeft = this.initialVoteTime; // Tiempo restante para la votaci√≥n
                this.voteInterval = null; // Intervalo para el temporizador de votaci√≥n
                this.voteCounts = this.getInitialVoteCounts(); // Votos para cada modo
                
                // Ranking
                this.lastRanking = [];
                this.rankingUpdateInterval = null;
                this.animationPending = false;
                
                this.achievementsList = { /* ... (sin cambios) ... */ };
                
                // IMPROVEMENT: Cacheo de elementos del DOM
                this.ui = {
                    loadingScreen: document.getElementById('loadingScreen'),
                    joinScreen: document.getElementById('joinScreen'),
                    multiplayerLobby: document.getElementById('multiplayerLobby'),
                    gameContainer: document.getElementById('gameContainer'),
                    finalResultsScreen: document.getElementById('finalResults'),
                    liveRankingDisplay: document.getElementById('liveRanking'),
                    gameModeIndicator: document.getElementById('gameModeIndicator'),
                    themeToggle: document.getElementById('themeToggle'),
                    timerCircle: document.querySelector('.timer-circle'),
                    timerText: document.getElementById('timerText'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    skipQuestionBtn: document.getElementById('skipQuestion'),
                    readyBtn: document.getElementById('readyBtn'),
                    startVoteBtn: document.getElementById('startVoteBtn'), // Bot√≥n para que el host inicie votaci√≥n
                    achievementPopup: document.getElementById('achievementPopup'),
                    closeAchievementBtn: document.getElementById('closeAchievement'),
                    playerStatsDisplay: document.getElementById('playerStats'),
                    closeStatsBtn: document.getElementById('closeStats'),
                    statsContent: document.getElementById('statsContent'),
                    playerNameInput: document.getElementById('playerName'),
                    gradeInput: document.getElementById('grade'),
                    gamePinInput: document.getElementById('gamePin'),
                    joinErrorMsg: document.getElementById('joinError'),
                    joinGameBtn: document.getElementById('joinGame'),
                    createGameBtn: document.getElementById('createGame'),
                    lobbyPinDisplay: document.getElementById('lobbyPin'),
                    playerCountDisplay: document.getElementById('playerCount'),
                    voteTimeDisplay: document.getElementById('voteTime'),
                    voteResultsDisplay: document.getElementById('voteResults'),
                    multiplayerPlayerList: document.getElementById('multiplayerPlayerList'),
                    playerScoreDisplay: document.getElementById('playerScore'),
                    currentQuestionDisplay: document.getElementById('currentQuestion'),
                    questionImage: document.getElementById('questionImage'),
                    playerAnswerInput: document.getElementById('playerAnswer'),
                    submitAnswerBtn: document.getElementById('submitAnswer'),
                    answerResultDisplay: document.getElementById('answerResult'),
                    standardInputContainer: document.getElementById('standardInput'),
                    trueFalseButtonsContainer: document.getElementById('trueFalseButtons'),
                    trueBtn: document.getElementById('trueBtn'),
                    falseBtn: document.getElementById('falseBtn'),
                    progressBar: document.getElementById('progressBar'),
                    reiniciarBtn: document.getElementById('reiniciarBtn'),
                    mensajeVictoria: document.getElementById('mensajeVictoria'),
                    backToLobbyBtn: document.getElementById('backToLobby'),
                    // Podium elements
                    firstPlacePodium: {
                        name: document.getElementById('firstName'),
                        avatar: document.getElementById('firstAvatar'),
                        points: document.querySelector('#firstPlace .podium-points')
                    },
                    secondPlacePodium: {
                        name: document.getElementById('secondName'),
                        avatar: document.getElementById('secondAvatar'),
                        points: document.querySelector('#secondPlace .podium-points')
                    },
                    thirdPlacePodium: {
                        name: document.getElementById('thirdName'),
                        avatar: document.getElementById('thirdAvatar'),
                        points: document.querySelector('#thirdPlace .podium-points')
                    },
                    otherPlayersList: document.getElementById('otherPlayers'),
                    avatarSelector: document.getElementById('avatarSelector'),
                    allModeButtons: document.querySelectorAll('.mode-btn'),
                    allKeypadKeys: document.querySelectorAll('.key')
                };
                
                this.setupEventListeners();
                this.checkDarkModePreference();
                this.loadPlayerStats();
                
                setTimeout(() => {
                    this.setState(this.STATES.JOIN_SCREEN);
                }, 1500);
            }

            getInitialVoteCounts() {
                return {
                    operaciones: 0, misterioso: 0, secuencia: 0, potenciacion: 0,
                    combinadas: 0, relampago: 0, "verdadero-falso": 0, "mas-cercano": 0
                };
            }

            setState(newState) {
                this.state = newState;
                this.updateUIForState();
            }

            updateUIForState() {
                this.ui.loadingScreen.style.display = 'none';
                this.ui.joinScreen.style.display = 'none';
                this.ui.multiplayerLobby.style.display = 'none';
                this.ui.gameContainer.style.display = 'none';
                this.ui.finalResultsScreen.style.display = 'none';
                this.ui.liveRankingDisplay.style.display = 'none';
                this.ui.gameModeIndicator.style.display = 'none';
                this.ui.startVoteBtn.style.display = 'none'; // Ocultar bot√≥n de iniciar voto por defecto


                switch(this.state) {
                    case this.STATES.LOADING:
                        this.ui.loadingScreen.style.display = 'flex';
                        break;
                    case this.STATES.JOIN_SCREEN:
                        this.ui.joinScreen.style.display = 'flex';
                        break;
                    case this.STATES.LOBBY:
                        this.ui.multiplayerLobby.style.display = 'flex';
                        this.ui.readyBtn.style.display = this.isMultiplayer ? 'block' : 'none';
                        // BUG FIX: Resetear UI de votaci√≥n al entrar al lobby si no hay votaci√≥n activa
                        if (!this.voteInterval) {
                           this.resetVoteDisplay();
                        }
                        // Mostrar bot√≥n "Iniciar Votaci√≥n" solo al host si no hay votaci√≥n en curso y hay suficientes jugadores
                        if (this.isHost && !this.voteInterval && this.players.length >= 1) { // Podr√≠a ser >= 1 si el host puede jugar solo o testear
                            this.ui.startVoteBtn.style.display = 'block';
                        }
                        break;
                    case this.STATES.VOTING: // Cuando la votaci√≥n est√° activa
                        this.ui.multiplayerLobby.style.display = 'flex';
                        this.ui.readyBtn.style.display = 'none'; // Ocultar bot√≥n de listo durante la votaci√≥n
                        this.ui.startVoteBtn.style.display = 'none'; // Ocultar bot√≥n de iniciar voto
                        break;
                    case this.STATES.PLAYING:
                        this.ui.gameContainer.style.display = 'block';
                        this.ui.liveRankingDisplay.style.display = 'block';
                        this.ui.gameModeIndicator.style.display = 'block';
                        this.ui.readyBtn.style.display = 'none';
                        break;
                    case this.STATES.RESULTS:
                        this.ui.finalResultsScreen.style.display = 'flex';
                        break;
                }
            }
            
            resetVoteDisplay() { // BUG FIX: Ayudante para resetear la UI de votos
                this.ui.voteTimeDisplay.textContent = this.initialVoteTime; // Mostrar tiempo de voto inicial
                this.ui.voteResultsDisplay.innerHTML = '<h4>Resultados:</h4><p>Esperando votos...</p>';
                this.ui.allModeButtons.forEach(btn => {
                    btn.classList.remove('selected', 'voted');
                    btn.disabled = false; // Habilitar botones de voto
                });
                 this.player.hasVoted = false; // Permitir que el jugador actual vuelva a votar
            }


            setupEventListeners() {
                this.ui.themeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    this.ui.themeToggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
                    this.playSound('clickSound');
                    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
                });
                
                this.ui.avatarSelector.querySelectorAll('.avatar-option').forEach(avatar => {
                    avatar.addEventListener('click', () => {
                        this.ui.avatarSelector.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('selected'));
                        avatar.classList.add('selected');
                        this.player.avatar = avatar.dataset.avatar;
                        this.playSound('clickSound');
                    });
                });
                
                if (this.ui.avatarSelector.querySelector('.avatar-option')) {
                     this.ui.avatarSelector.querySelector('.avatar-option').click();
                }
                
                this.ui.joinGameBtn.addEventListener('click', () => this.joinGame());
                this.ui.createGameBtn.addEventListener('click', () => this.createGame());
                
                this.ui.allKeypadKeys.forEach(key => {
                    if (key.dataset.number) {
                        key.addEventListener('click', () => this.addNumber(key.dataset.number));
                    } else if (key.dataset.action === 'clear') {
                        key.addEventListener('click', () => this.clearNumber());
                    }
                });
                
                this.ui.submitAnswerBtn.addEventListener('click', () => this.submitAnswer());
                this.ui.playerAnswerInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.submitAnswer();
                });
                
                this.ui.trueBtn.addEventListener('click', () => this.checkAnswer('true'));
                this.ui.falseBtn.addEventListener('click', () => this.checkAnswer('false'));
                
                this.ui.reiniciarBtn.addEventListener('click', () => this.reiniciarJuego(true)); // true para indicar volver al lobby
                this.ui.backToLobbyBtn.addEventListener('click', () => this.reiniciarJuego(true));
                
                this.ui.allModeButtons.forEach(btn => {
                    btn.addEventListener('click', () => this.castVote(btn.dataset.mode));
                });
                
                this.ui.skipQuestionBtn.addEventListener('click', () => this.skipQuestionAsProfessor());
                this.ui.readyBtn.addEventListener('click', () => this.toggleReady());
                this.ui.closeAchievementBtn.addEventListener('click', () => { this.ui.achievementPopup.style.display = 'none'; });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 's' && e.ctrlKey) { this.toggleStats(); }
                });
                this.ui.closeStatsBtn.addEventListener('click', () => { this.ui.playerStatsDisplay.style.display = 'none'; });

                window.addEventListener('online', () => {
                    if (this.socket && this.socket.readyState === WebSocket.CLOSED) { this.attemptReconnect(); }
                });
                // BUG FIX: Event listener para el nuevo bot√≥n de iniciar votaci√≥n
                this.ui.startVoteBtn.addEventListener('click', () => {
                    if (this.isHost && this.state === this.STATES.LOBBY) {
                        // Enviar mensaje al servidor para que inicie la votaci√≥n para todos
                        this.socket.send(JSON.stringify({
                            type: 'host_starts_voting',
                            pin: this.gamePin,
                            time: this.initialVoteTime 
                        }));
                        // El servidor deber√≠a responder con 'start_voting' a todos los clientes
                    }
                });
            }

            checkDarkModePreference() { /* ... (sin cambios) ... */ }
            loadPlayerStats() { /* ... (sin cambios) ... */ }
            savePlayerStats() { /* ... (sin cambios) ... */ }
            toggleStats() { /* ... (sin cambios) ... */ }
            sanitizeInput(input) { /* ... (sin cambios) ... */ }

            joinGame() {
                const playerName = this.sanitizeInput(this.ui.playerNameInput.value.trim());
                const grade = this.sanitizeInput(this.ui.gradeInput.value.trim());
                const gamePin = this.ui.gamePinInput.value.trim();

                if (!playerName || playerName.length < 3) {
                    this.ui.joinErrorMsg.textContent = 'El nombre debe tener al menos 3 caracteres'; return;
                }
                if (!grade) {
                    this.ui.joinErrorMsg.textContent = 'Ingresa tu grado'; return;
                }
                if (!/^\d{4}$/.test(gamePin)) {
                    this.ui.joinErrorMsg.textContent = 'PIN debe ser 4 d√≠gitos'; return;
                }

                let playerId = localStorage.getItem('playerId');
                if (!playerId) {
                    playerId = this.generateId();
                    localStorage.setItem('playerId', playerId);
                }
                this.player = { ...this.player, id: playerId, name: playerName, grade: grade, displayName: `${playerName} (${grade})`, isProfessor: false };
                this.gamePin = gamePin;
                this.isHost = false; // Al unirse, no es host
                this.connectToServer();
            }

            createGame() {
                const playerName = this.sanitizeInput(this.ui.playerNameInput.value.trim());
                const grade = this.sanitizeInput(this.ui.gradeInput.value.trim());
                
                if (!playerName || playerName.length < 3) {
                    this.ui.joinErrorMsg.textContent = 'El nombre debe tener al menos 3 caracteres'; return;
                }
                if (!grade) {
                    this.ui.joinErrorMsg.textContent = 'Ingresa tu grado'; return;
                }

                this.ui.createGameBtn.disabled = true;
                this.ui.createGameBtn.innerHTML = '<span class="loader-small"></span> Creando sala...';

                let playerId = localStorage.getItem('playerId');
                if (!playerId) {
                    playerId = this.generateId();
                    localStorage.setItem('playerId', playerId);
                }
                this.player = { ...this.player, id: playerId, name: playerName, grade: grade, displayName: `${playerName} (Profesor)`, isProfessor: true };
                this.gamePin = Math.floor(1000 + Math.random() * 9000).toString();
                this.ui.gamePinInput.value = this.gamePin;
                this.isHost = true; // Al crear, es host
                this.ui.skipQuestionBtn.style.display = 'block';
                
                this.connectToServer();
                this.showNotification(`Sala ${this.gamePin} creada. Eres el profesor.`);
                
                setTimeout(() => {
                    this.ui.createGameBtn.disabled = false;
                    this.ui.createGameBtn.textContent = 'Crear nueva sala';
                }, 2000);
            }

            connectToServer() { /* ... (sin cambios significativos, asegurarse que player.isProfessor se env√≠a) ... */ 
                 try {
                    this.updateConnectionStatus('connecting', 'üü° Conectando...');
                    if (!navigator.onLine) {
                        this.handleNetworkError(new Error('Sin conexi√≥n a internet')); return;
                    }
                    const wsUrl = `${this.socketUrl}?playerId=${this.player.id}`;
                    this.socket = new WebSocket(wsUrl);
                    this.setupHeartbeat();
                    
                    this.socket.onerror = (error) => { /* ... */ };
                    this.socket.onclose = (event) => { /* ... */ };
                    
                    this.socket.onopen = () => {
                        console.log("Conexi√≥n establecida");
                        this.reconnectAttempts = 0;
                        this.lastPongTime = Date.now();
                        this.updateConnectionStatus('connected', 'üü¢ Conectado');
                        
                        this.socket.send(JSON.stringify({
                            type: 'join_room',
                            pin: this.gamePin,
                            player: { // Enviar todos los datos relevantes del jugador
                                id: this.player.id,
                                name: this.player.displayName, // Usar displayName
                                avatar: this.player.avatar,
                                points: 0, // Puntos iniciales
                                isProfessor: this.player.isProfessor, // Asegurar que esto se env√≠e
                                isReady: this.player.isReady // Estado inicial de listo
                            }
                        }));
                    };
                    this.socket.onmessage = (event) => { /* ... */ };
                } catch (error) { /* ... */ }
            }
            setupHeartbeat() { /* ... (sin cambios) ... */ }
            attemptReconnect() { /* ... (sin cambios) ... */ }
            showReconnectButton() { /* ... (sin cambios) ... */ }
            updateConnectionStatus(status, message = null) { /* ... (sin cambios) ... */ }

            handleSocketMessage(data) {
                console.log("Mensaje recibido:", data);
                switch(data.type) {
                    case 'room_joined': this.handleRoomJoined(data); break;
                    case 'player_joined': this.handlePlayerJoined(data); break;
                    case 'player_left': this.handlePlayerLeft(data); break;
                    case 'player_ready': this.handlePlayerReady(data); break;
                    case 'start_voting': // BUG FIX: El servidor ahora dicta cu√°ndo inicia la votaci√≥n
                        this.setState(this.STATES.VOTING);
                        this.initiateVoteCountdown(data.time || this.initialVoteTime); 
                        break;
                    case 'update_vote_timer': this.updateVoteTimerDisplay(data.time); break;
                    case 'vote_update': this.updateVoteResults(data.votes); break;
                    case 'start_game': this.startGame(data.mode, data.closestAnswerMode); break;
                    case 'question_update': this.handleQuestionUpdate(data); break;
                    case 'game_over': this.handleGameOver(data); break;
                    case 'player_score': this.updatePlayerScore(data.playerId, data.points, data.streak); break;
                    case 'error': this.handleError(data); break;
                    default: console.warn('Tipo de mensaje no reconocido:', data.type);
                }
            }

            handleRoomJoined(data) {
                this.isMultiplayer = true;
                this.players = data.players || [];
                // El host puede ser determinado por el servidor o si this.player.isProfessor es true y su ID coincide
                this.isHost = this.players.find(p => p.id === this.player.id)?.isProfessor || false; 

                this.players = this.players.filter((player, index, self) => index === self.findIndex(p => p.id === player.id));
                this.setState(this.STATES.LOBBY);
                this.ui.lobbyPinDisplay.textContent = this.gamePin;
                this.updatePlayerList();
                
                if (data.voteTime !== undefined && data.isVotingActive) { // Si el servidor indica que la votaci√≥n ya est√° activa
                    this.setState(this.STATES.VOTING);
                    this.initiateVoteCountdown(data.voteTime);
                }
                if (data.votes) { this.updateVoteResults(data.votes); }
                if (data.gameMode && data.isGameRunning) { this.startGame(data.gameMode, data.closestAnswerMode); }
            }
            handlePlayerJoined(data) { /* ... (sin cambios) ... */ }
            handlePlayerLeft(data) { /* ... (sin cambios) ... */ }
            
            handlePlayerReady(data) {
                const player = this.players.find(p => p.id === data.playerId);
                if (player) {
                    player.isReady = data.isReady;
                    this.updatePlayerList(); // Actualiza la UI para mostrar qui√©n est√° listo
                    
                    if (data.playerId === this.player.id) {
                        this.player.isReady = data.isReady;
                        this.ui.readyBtn.textContent = data.isReady ? "‚ùå No listo" : "üëç Listo";
                    } else {
                        this.showNotification(`${player.name} ${data.isReady ? "est√° listo" : "ya no est√° listo"}`);
                    }
                }
                // BUG FIX: Quitar inicio autom√°tico de votaci√≥n desde aqu√≠. El host usar√° el bot√≥n.
                // if (this.isHost && this.players.every(p => p.isReady && p.id !== undefined) && this.players.length >= 1) {
                //    // El host ahora debe presionar "Iniciar Votaci√≥n"
                // }
            }

            toggleReady() { /* ... (sin cambios) ... */ }
            handleQuestionUpdate(data) { /* ... (sin cambios) ... */ }
            handleGameOver(data) { /* ... (sin cambios significativos, asegurar que Podium usa los elementos cacheados de this.ui) ... */ }
            updatePlayerStatistics(finalRanking) { /* ... (sin cambios) ... */ }
            checkAchievements() { /* ... (sin cambios) ... */ }
            unlockAchievement(achievementId, achievement) { /* ... (sin cambios) ... */ }
            showAchievementPopup(achievement) { /* ... (sin cambios) ... */ }
            handleError(data) { /* ... (sin cambios) ... */ }

            updatePlayerList() {
                this.ui.multiplayerPlayerList.innerHTML = '';
                this.players.forEach(player => {
                    const playerElement = document.createElement('div');
                    playerElement.className = 'player-badge';
                    playerElement.innerHTML = `
                        <img src="https://i.pravatar.cc/150?img=${player.avatar || '1'}" class="player-avatar">
                        <span>${player.name}</span>
                        ${player.isProfessor ? ' üë®‚Äçüè´' : ''}
                        ${player.isReady ? ' ‚úì' : ''}
                    `;
                    if (player.id === this.player.id) { playerElement.style.border = '2px solid var(--amarillo)';}
                    this.ui.multiplayerPlayerList.appendChild(playerElement);
                });
                this.ui.playerCountDisplay.textContent = `${this.players.length}/${this.maxPlayers}`;

                // BUG FIX: Controlar visibilidad del bot√≥n "Iniciar Votaci√≥n" para el host
                if (this.state === this.STATES.LOBBY) { // Solo si estamos en el lobby
                    if (this.isHost && !this.voteInterval && this.players.length >= 1) { // M√≠nimo 1 jugador (el host) para poder iniciar
                        this.ui.startVoteBtn.style.display = 'block';
                    } else {
                        this.ui.startVoteBtn.style.display = 'none';
                    }
                }
            }
            
            // BUG FIX: Renombrado para diferenciar del manejo de la UI
            initiateVoteCountdown(time) {
                if (this.voteInterval) clearInterval(this.voteInterval);
                this.voteCounts = this.getInitialVoteCounts(); // Resetear conteos
                this.resetVoteDisplay(); // Resetear la UI de votos
                this.player.hasVoted = false; // Permitir votar de nuevo
                this.ui.allModeButtons.forEach(btn => btn.disabled = false);


                this.voteTimeLeft = time;
                this.ui.voteTimeDisplay.textContent = this.voteTimeLeft;

                // El intervalo real de la cuenta regresiva
                this.voteInterval = setInterval(() => {
                    this.voteTimeLeft--;
                    this.ui.voteTimeDisplay.textContent = this.voteTimeLeft;
                    
                    // El host podr√≠a enviar actualizaciones del timer, o el servidor manejarlo y enviar 'update_vote_timer'
                    if (this.isHost) {
                         this.socket.send(JSON.stringify({ type: 'update_vote_timer', pin: this.gamePin, time: this.voteTimeLeft }));
                    }

                    if (this.voteTimeLeft <= 0) {
                        clearInterval(this.voteInterval);
                        this.voteInterval = null;
                        this.ui.allModeButtons.forEach(btn => btn.disabled = true); // Deshabilitar botones al acabar tiempo
                        if (this.isHost) {
                            this.startSelectedGameMode(); // El host determina el modo y arranca el juego
                        }
                    }
                }, 1000);
            }

            updateVoteTimerDisplay(time) { // Solo actualiza la UI
                this.voteTimeLeft = time;
                this.ui.voteTimeDisplay.textContent = this.voteTimeLeft;
                 if (this.voteTimeLeft <= 0 && this.voteInterval) { // Si el servidor indica tiempo 0, detener localmente
                    clearInterval(this.voteInterval);
                    this.voteInterval = null;
                    this.ui.allModeButtons.forEach(btn => btn.disabled = true);
                }
            }


            castVote(mode) {
                if (this.player.hasVoted || this.voteTimeLeft <= 0) return;
                this.player.hasVoted = true;
                this.ui.allModeButtons.forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.dataset.mode === mode) btn.classList.add('selected', 'voted');
                    btn.disabled = true; // Deshabilitar todos despu√©s de votar
                });
                this.playSound('clickSound');
                this.socket.send(JSON.stringify({ type: 'cast_vote', pin: this.gamePin, playerId: this.player.id, mode: mode }));
            }

            updateVoteResults(votes) {
                this.voteCounts = votes;
                let resultsHTML = '<h4>Resultados:</h4>';
                const sortedModes = Object.entries(this.voteCounts).sort((a, b) => b[1] - a[1]).filter(([_, count]) => count > 0);
                if (sortedModes.length > 0) {
                    sortedModes.forEach(([mode, count]) => {
                        resultsHTML += `<p>${this.getModeName(mode)}: ${count} ${count === 1 ? 'voto' : 'votos'}</p>`;
                    });
                } else {
                    resultsHTML += '<p>A√∫n no hay votos.</p>';
                }
                this.ui.voteResultsDisplay.innerHTML = resultsHTML;
            }

            getModeName(mode) { /* ... (sin cambios) ... */ }

            startSelectedGameMode() { // Llamado por el host despu√©s de la votaci√≥n
                if (!this.isHost) return;
                let maxVotes = 0;
                let selectedMode = 'operaciones'; 
                let closestAnswer = false;

                const totalVotes = Object.values(this.voteCounts).reduce((a, b) => a + b, 0);
                if (totalVotes > 0) {
                    for (const [mode, votes] of Object.entries(this.voteCounts)) {
                        if (votes > maxVotes) {
                            maxVotes = votes;
                            selectedMode = mode;
                        }
                    }
                    const modesWithMaxVotes = Object.entries(this.voteCounts).filter(([_, votes]) => votes === maxVotes).map(([mode]) => mode);
                    if (modesWithMaxVotes.length > 1) {
                        selectedMode = modesWithMaxVotes[Math.floor(Math.random() * modesWithMaxVotes.length)];
                    }
                }
                
                if (selectedMode === 'mas-cercano') {
                    closestAnswer = true;
                    // selectedMode = 'operaciones'; // O mantenerlo y que generarPreguntas lo maneje
                }
                this.selectedGameModeForNextRound = selectedMode; // Guardar el modo seleccionado
                this.closestAnswerMode = closestAnswer;

                this.socket.send(JSON.stringify({ type: 'start_game', pin: this.gamePin, mode: this.selectedGameModeForNextRound, closestAnswerMode: this.closestAnswerMode }));
            }

            startGame(mode, closestAnswerMode = false) {
                this.gameMode = mode; // Usar this.gameMode para el modo actual de la partida
                this.closestAnswerMode = closestAnswerMode;
                
                this.ui.gameModeIndicator.textContent = `Modo: ${this.getModeName(mode)}`;
                if (closestAnswerMode) { this.ui.gameModeIndicator.textContent += " üéØ"; }
                
                this.timerDuration = (mode === 'relampago') ? 5 : (mode === 'verdadero-falso') ? 15 : 30;
                document.body.classList.toggle('lightning-mode', mode === 'relampago'); // Usar classList.toggle
                
                this.setState(this.STATES.PLAYING);
                
                this.ui.standardInputContainer.style.display = (mode === 'verdadero-falso') ? 'none' : 'block';
                this.ui.trueFalseButtonsContainer.style.display = (mode === 'verdadero-falso') ? 'flex' : 'none';
                
                if (this.isHost) {
                    this.questions = this.generarPreguntas(mode, 10);
                    this.currentQuestionIndex = 0;
                    this.shareQuestionWithPlayers();
                }
                
                this.player.points = 0; this.player.streak = 0; this.player.responseTimes = [];
                this.updatePlayerScore(); // Actualiza la UI y llama a animateRanking
                
                this.lastRanking = [...this.players].sort((a, b) => (b.points || 0) - (a.points || 0));
                this.animateRanking(); // Llamada inicial
                if (this.rankingUpdateInterval) clearInterval(this.rankingUpdateInterval);
                this.rankingUpdateInterval = setInterval(() => this.animateRanking(), 2000); // BUG FIX: Sigue siendo √∫til como fallback
            }

            shareQuestionWithPlayers() {
                if (!this.isHost || !this.questions.length || this.currentQuestionIndex >= this.questions.length) return;
                const question = this.questions[this.currentQuestionIndex];
                this.currentQuestionData = question; // El host tambi√©n necesita esto
                
                this.socket.send(JSON.stringify({
                    type: 'question_update', pin: this.gamePin, question: question,
                    questionIndex: this.currentQuestionIndex, totalQuestions: this.questions.length
                }));
                // El host tambi√©n debe mostrar la pregunta y reiniciar su propio temporizador
                this.displayQuestion(question); 
                this.resetTimer(); 
            }

            generarPreguntas(mode, count) { /* ... (sin cambios) ... */ }

            displayQuestion(questionData = null) {
                try {
                    const question = questionData || this.currentQuestionData;
                    if (!question) return;
                    
                    if (question.tipo === 'operacion-rapida' && question.pregunta.includes('=')) {
                        this.ui.currentQuestionDisplay.innerHTML = `
                            <div class="math-question">
                                <span class="number">${question.pregunta.split('=')[0]}</span>
                                <span class="equals">=</span> <span class="question-mark">?</span> </div>`;
                    } else { this.ui.currentQuestionDisplay.innerHTML = question.pregunta; }
                    
                    this.ui.currentQuestionDisplay.classList.remove('question-animation');
                    void this.ui.currentQuestionDisplay.offsetWidth; 
                    this.ui.currentQuestionDisplay.classList.add('question-animation');
                    
                    this.ui.playerAnswerInput.value = "";
                    this.ui.answerResultDisplay.textContent = "Esperando respuesta... ü§î";
                    this.ui.answerResultDisplay.className = "result";
                    this.player.hasAnswered = false;
                    this.ui.submitAnswerBtn.disabled = false;
                    this.lastAnswerTime = Date.now();
                    
                    this.ui.questionImage.style.display = question.imagen ? (this.ui.questionImage.src = question.imagen, 'block') : 'none';
                    
                    // No reiniciar el timer aqu√≠ si es el host, shareQuestionWithPlayers lo har√°.
                    // Si es un cliente, el timer se reinicia al recibir question_update implicitamente por el flujo.
                    // Para asegurar:
                    if (!this.isHost) this.resetTimer();

                } catch (error) { /* ... */ }
            }

            checkAnswer(userAnswer) {
                try {
                    if (this.player.hasAnswered) return;
                    if ((!userAnswer || String(userAnswer).trim() === "") && this.gameMode !== 'verdadero-falso') {
                        this.showResult("¬°Escribe una respuesta!", false); return;
                    }
                    this.player.hasAnswered = true;
                    this.ui.submitAnswerBtn.disabled = true;
                    if(this.timerInterval) clearInterval(this.timerInterval); // Detener timer al responder

                    const responseTime = (Date.now() - this.lastAnswerTime) / 1000;
                    this.player.responseTimes.push(responseTime);
                    this.player.avgResponseTime = this.player.responseTimes.reduce((a, b) => a + b, 0) / this.player.responseTimes.length;

                    const currentQuestion = this.currentQuestionData;
                    let isCorrect = false; let pointsEarned = 0;
                    let timeBonus = Math.max(0, Math.floor(this.timeLeft / 5)); // timeLeft puede ser negativo si el timer del host ya acab√≥
                     if (this.timeLeft <=0) timeBonus = 0;


                    if (this.gameMode === 'verdadero-falso') {
                        isCorrect = (userAnswer === 'true') === currentQuestion.respuesta;
                        if (isCorrect) {
                            pointsEarned = 1 + timeBonus; this.player.streak++;
                            this.showResult(`‚úÖ Correcto! +${pointsEarned} puntos<br>${currentQuestion.explicacion}`, true);
                        } else {
                            this.player.streak = 0;
                            this.showResult(`‚ùå Incorrecto! ${currentQuestion.explicacion}`, false);
                        }
                    } else {
                        const userAnswerParsed = parseFloat(String(userAnswer).trim());
                        if (isNaN(userAnswerParsed)) { this.showResult("¬°Solo n√∫meros!", false); return; }
                        
                        if (this.closestAnswerMode) {
                            const diferencia = Math.abs(userAnswerParsed - currentQuestion.respuesta);
                            pointsEarned = Math.max(0, 5 - diferencia) + timeBonus; isCorrect = true; this.player.streak++;
                            this.showResult(`üéØ Diferencia: ${diferencia} (+${pointsEarned} puntos)`, true);
                        } else {
                            isCorrect = (currentQuestion.operador === '√∑') ? 
                                (Math.abs(userAnswerParsed - currentQuestion.respuesta) < 0.01) : 
                                (userAnswerParsed === currentQuestion.respuesta);
                            if (isCorrect) {
                                pointsEarned = 1 + timeBonus; this.player.streak++;
                                this.showResult(`‚úÖ Correcto! +${pointsEarned} puntos`, true);
                            } else {
                                this.player.streak = 0;
                                this.showResult(`‚ùå Incorrecto! Era ${currentQuestion.respuesta}`, false);
                            }
                        }
                    }
                    if (this.player.streak > this.player.maxStreak) this.player.maxStreak = this.player.streak;
                    this.player.points += pointsEarned;
                    this.player.history.push({ /* ... */ });
                    this.playSound(isCorrect ? 'correctSound' : 'wrongSound');
                    
                    this.updatePlayerScore(); // Actualiza UI local y llama a animateRanking

                    if (this.isMultiplayer && this.socket) {
                        this.socket.send(JSON.stringify({
                            type: 'player_score', pin: this.gamePin, playerId: this.player.id,
                            points: this.player.points, streak: this.player.streak, maxStreak: this.player.maxStreak,
                            avgResponseTime: this.player.avgResponseTime, isCorrect: isCorrect
                        }));
                    }
                    
                    // BUG FIX: El host ya no necesita este timeout aqu√≠ si el timer global maneja el avance.
                    // La l√≥gica de avance del host ahora est√° en startTimer() cuando timeLeft <= 0,
                    // o cuando el profesor usa skipQuestionAsProfessor().
                    // Si todos responden antes de que acabe el tiempo, el host deber√≠a avanzar.
                    // Esto requiere que el servidor notifique al host cuando todos han respondido.
                    // Por simplicidad, el juego avanzar√° cuando el timer del host termine o el host salte.
                    // Si deseas que avance cuando todos responden, el servidor debe enviar un mensaje "all_players_answered" al host.
                    // Y el host tendr√≠a un handler para eso.

                } catch (error) { /* ... */ }
            }

            showResult(message, isCorrect) { /* ... (sin cambios significativos) ... */ }

            updatePlayerScore(playerId = null, points = null, streak = null) { // BUG FIX: Llamar a animateRanking
                if (playerId && points !== null) {
                    const player = this.players.find(p => p.id === playerId);
                    if (player) {
                        player.points = points;
                        if (streak !== null) { player.streak = streak; if (streak > (player.maxStreak || 0)) player.maxStreak = streak; }
                    }
                }
                this.ui.playerScoreDisplay.textContent = this.player.points;
                this.animateRanking(); // Actualizar ranking cada vez que una puntuaci√≥n cambia
            }

            animateRanking() { /* ... (sin cambios) ... */ }
            extractName(fullName) { /* ... (sin cambios) ... */ }

            startTimer() { // BUG FIX: L√≥gica de avance para el host y manejo de timeout de cliente
                try {
                    this.timeLeft = this.timerDuration;
                    this.updateTimerUI();
                    if(this.timerInterval) clearInterval(this.timerInterval);

                    this.timerInterval = setInterval(() => {
                        this.timeLeft--;
                        this.updateTimerUI();
                        
                        if (this.timeLeft <= 5 && this.timeLeft > 0 && this.timeLeft % 2 === 0) this.playSound('countdownSound');
                        
                        if (this.timeLeft <= 0) {
                            clearInterval(this.timerInterval);
                            this.timerInterval = null;
                            this.player.hasAnswered = true; // Evita m√°s respuestas
                            this.ui.submitAnswerBtn.disabled = true;

                            if (this.isHost && this.isMultiplayer) {
                                console.log("Host: Tiempo de pregunta agotado. Avanzando...");
                                this.showResult("¬°Tiempo agotado para la pregunta!", false); // Feedback para el host
                                setTimeout(() => { // Dar tiempo para ver el mensaje
                                    this.currentQuestionIndex++;
                                    if (this.currentQuestionIndex < this.questions.length) {
                                        this.shareQuestionWithPlayers();
                                    } else {
                                        this.endGame();
                                    }
                                }, 1500); // Un breve delay
                            } else if (this.isMultiplayer && !this.player.hasAnswered) { // Cliente que no ha respondido
                                this.showResult("¬°Se acab√≥ el tiempo!", false);
                                if (this.socket) {
                                    this.socket.send(JSON.stringify({ type: 'player_timeout', pin: this.gamePin, playerId: this.player.id }));
                                }
                            } else if (!this.isMultiplayer) { // Un jugador
                                this.showResult("¬°Se acab√≥ el tiempo!", false);
                                setTimeout(() => this.skipQuestion(), 1500);
                            }
                        }
                    }, 1000);
                } catch (error) { /* ... */ }
            }

            updateTimerUI() { /* ... (sin cambios) ... */ }
            resetTimer() { if(this.timerInterval) clearInterval(this.timerInterval); this.startTimer(); }

            skipQuestion() { // Para modo un jugador o l√≥gica interna de avance
                this.currentQuestionIndex++;
                if (this.currentQuestionIndex < this.questions.length) {
                    this.displayQuestion(this.questions[this.currentQuestionIndex]);
                    this.resetTimer(); 
                } else { this.endGame(); }
            }

            skipQuestionAsProfessor() { // BUG FIX: Usar shareQuestionWithPlayers
                if (!this.player.isProfessor || !this.isHost) return;
                this.playSound('clickSound');
                if(this.timerInterval) clearInterval(this.timerInterval); // Detener timer actual

                this.currentQuestionIndex++;
                if (this.currentQuestionIndex < this.questions.length) {
                    this.shareQuestionWithPlayers(); // Esto se encarga de enviar y mostrar la nueva pregunta
                } else {
                    this.endGame();
                }
            }

            endGame() { /* ... (sin cambios significativos) ... */ }
            getFinalRanking() { /* ... (sin cambios) ... */ }
            showWinner() { /* ... (sin cambios) ... */ }
            showMultiplayerResults(finalRanking) { /* ... (usar this.ui para elementos del podio) ... */ }
            showError(message) { /* ... (sin cambios) ... */ }
            showNotification(message) { /* ... (sin cambios) ... */ }

            reiniciarJuego(volverAlLobby = false) { // BUG FIX: Reinicio de votos
                try {
                    this.playSound('clickSound');
                    if(this.timerInterval) clearInterval(this.timerInterval);
                    if(this.voteInterval) clearInterval(this.voteInterval); this.voteInterval = null;
                    if(this.rankingUpdateInterval) clearInterval(this.rankingUpdateInterval); this.rankingUpdateInterval = null;
                    if(this.animationFrameId) cancelAnimationFrame(this.animationFrameId); this.animationFrameId = null;
                    
                    this.player.points = 0; this.player.streak = 0; this.player.responseTimes = [];
                    this.player.hasAnswered = false; this.player.hasVoted = false;
                    this.player.isReady = false; // Importante resetear el estado de listo
                    
                    this.currentQuestionIndex = 0;
                    this.gameMode = null; // Resetear modo de juego actual
                    this.selectedGameModeForNextRound = null; // Resetear modo seleccionado para la siguiente
                    this.closestAnswerMode = false;
                    this.questions = []; // Limpiar preguntas
                    
                    this.ui.playerScoreDisplay.textContent = '0';
                    this.ui.currentQuestionDisplay.textContent = "Haz clic en un juego para comenzar";
                    this.ui.playerAnswerInput.value = "";
                    this.ui.answerResultDisplay.textContent = "Esperando respuesta... ü§î";
                    this.ui.answerResultDisplay.className = "result";
                    this.ui.mensajeVictoria.innerHTML = "";
                    this.ui.progressBar.style.width = "0%";
                    this.ui.submitAnswerBtn.disabled = false;
                    this.ui.questionImage.style.display = 'none';
                    this.ui.liveRankingDisplay.style.display = 'none'; // Ocultar ranking
                    this.ui.rankingList.innerHTML = ''; // Limpiar lista del ranking
                    this.lastRanking = [];


                    // BUG FIX: Resetear completamente la secci√≥n de votaci√≥n
                    this.voteCounts = this.getInitialVoteCounts();
                    this.resetVoteDisplay(); // Llama a la funci√≥n que resetea la UI de votos
                    this.ui.readyBtn.textContent = "üëç Listo"; // Resetear texto del bot√≥n Listo


                    if (this.isMultiplayer && volverAlLobby) {
                        // Notificar al servidor que el jugador quiere volver al lobby (opcional, si el servidor maneja este estado)
                        // this.socket.send(JSON.stringify({ type: 'return_to_lobby', pin: this.gamePin, playerId: this.player.id }));
                        this.setState(this.STATES.LOBBY);
                        this.updatePlayerList(); // Actualizar lista de jugadores en el lobby
                    } else {
                        // Si no es multijugador o no se vuelve al lobby, ir a pantalla de uni√≥n
                        this.isMultiplayer = false; // Resetear estado multijugador
                        this.isHost = false;
                        this.players = [];
                        if (this.socket) { this.socket.close(); this.socket = null; } // Cerrar conexi√≥n si existe
                        this.setState(this.STATES.JOIN_SCREEN);
                    }
                } catch (error) { /* ... */ }
            }

            addNumber(num) { /* ... (sin cambios) ... */ }
            clearNumber() { /* ... (sin cambios) ... */ }
            submitAnswer() { this.checkAnswer(this.ui.playerAnswerInput.value); }
            handleNetworkError(error, message = "Error de red") { /* ... (sin cambios) ... */ }
            generateId() { return Math.random().toString(36).substr(2, 9); }
            playSound(soundId) { /* ... (sin cambios) ... */ }
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const game = new GameManager();
                window.game = game; // Para depuraci√≥n
            } catch (error) {
                console.error("Error al iniciar el juego:", error);
                alert("Ocurri√≥ un error al cargar el juego. Por favor recarga la p√°gina.");
            }
        });
    </script>
</body>
</html>
